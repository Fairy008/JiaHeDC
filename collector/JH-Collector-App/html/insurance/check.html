<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/app.css" rel="stylesheet" />
		<style>
			/* .clt-span-account-name, */ 
			.clt-span-time{ margin-left: 5px;}
			.clt-span-type{ padding: 0px 3px; height: 20px; line-height: 20px;}
			.mui-table-view .mui-media-object{
				height: 70px; width: 70px; max-width: 70px;
			}
			
			.mui-pull-bottom-tips {
				text-align: center;
				background-color: #efeff4;
				font-size: 15px;
				line-height: 40px;
				color: #777;
			}
			.mui-pull-top-tips {
				position: absolute;
				top: 0px;
				left: 50%;
				margin-left: -25px;
				width: 40px;
				height: 40px;
				border-radius: 100%;
				z-index: 1;
			}
			.mui-pull-top-wrapper {
				width: 42px;
				height: 42px;
				display: block;
				text-align: center;
				background-color: #efeff4;
				border: 1px solid #ddd;
				border-radius: 25px;
				background-clip: padding-box;
				box-shadow: 0 4px 10px #bbb;
				overflow: hidden;
			}
			.mui-pull-top-tips.mui-transitioning {
				-webkit-transition-duration: 200ms;
				transition-duration: 200ms;
			}
			.mui-pull-top-canvas canvas {
				width: 40px;
			}
			.mui-slider-indicator.mui-segmented-control {
				background-color: #efeff4;
			}
			
			.mui-slider-item .taskName{
				display: block;
				position: absolute;
				top: 0;
				width: 100%;
				margin-top: 70px;
				color: #fff;
				font-size: 15px;
				text-align: center;
			}
			.mui-btn.mui-btn-blue{
				background-color: #2da3d5;
			}
			.mui-icon.mui-icon-location-filled.jh-title-button{
				background-color: rgba(0,0,0,0);
				border-width: 0;
				color: white;
			}
			.jh-progressbar{
				background-color: #F0F0F0;
				/* padding: 0.0625rem; */
				width: 4rem;
				height: 1.2rem;
				margin-top: 0.5rem;
				margin-bottom: 0.5rem;
				border:0.0625rem solid #2da3d5 !important;
				padding: 0;
				/* border-width:  0.3rem; */
				z-index: 7;
			}
			.jh-progressbar.jh-state-finshed{
				border:0.0625rem solid #14c13b !important;
			}
			.jh-progressbar.jh-state-unstart{
				border:0.0625rem solid #e69200 !important;
			}
			.jh-progressbar .jh-progressbar-text{
				text-align: center;
				width: 3.875rem;
				/* height: 1.075rem; */
				font-size: 0.8rem;
				color: white;
				position: absolute;
				/* left: 1.2rem; */
				z-index:9;
			}
			/* 3.875rem */
			.jh-progressbar .jh-progressbar-bar{
				position: absolute;
				left: 1rem;
				width: 2rem;
				height: 1.075rem;
				background-color: #2da3d5;
				z-index:8;
			}
			.jh-progressbar.jh-state-finshed .jh-progressbar-bar{
				background-color: #14c13b;
				width: 3.875rem;
			}
			
			.jh-progressbar.jh-state-unstart .jh-progressbar-bar{
				background-color: #e69200;
				width: 3.875rem;
			}
			.jh-progressbar .jh-progressbar-state{
				position: absolute;
				top: 2.4rem; 
				margin-left: 4.5rem;
				color: #2da3d5;
				font-size: 1rem;
			}
			.jh-progressbar.jh-state-finshed .jh-progressbar-state{
				color: #14c13b;
			}
			.jh-progressbar.jh-state-unstart .jh-progressbar-state{
				color: #E69200;
			}
			.jh-padding-div{
				padding: 0.7rem;
			}
			.jh-li{
				height: 10rem;
				margin-bottom: 0.7rem;
				background-color: #FFFFFF;
				border: 0 soild #FFFFFF !important;
				background-position: right;
				background-repeat: no-repeat;
				background-size:  40%;
				-moz-border-radius: 0.625rem;      /* Gecko browsers */
				-webkit-border-radius: 0.625rem;   /* Webkit browsers */
				border-radius:0.625rem;            /* W3C syntax */
			}
			.jh-li p{
				margin-left: 1.5rem;
			}
			.jh-li p .jh-title{
				margin-top:1.5rem ;
				display: inline-block;
				width: 90%; 
				font-size: 1.4rem; 
				color:#d5b200;
			}
			.jh-li p .jh-subtitle{
				color: #000000;
			}
			.jh-li .jh-show-button{
				font-size: 0.7rem;
				margin-left: 1rem;
				margin-top: 0.8rem;
				width: 6rem;
				height: 2rem;
				border-radius: 0.5rem
			}
			.jh-font-size1{
				font-size: 1.4rem;
			}
			.jh-font-size2{
				font-size: 1.2rem;
			}
			.mui-slider-indicator.mui-segmented-control.mui-segmented-control-inverted{
				background-color: white;
			}
			
			
		</style>
	</head>

	<body class="mui-plus mui-statusbar mui-statusbar-offset">
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title jh-font-size1">验险</h1>
		</header>
		<div id="clt-home-menu" class="mui-slider mui-fullscreen" style="top: 4rem;">
			<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
				<a class="mui-control-item jh-font-size2 mui-active" href="#itemAll" isPublish="All">全部</a>
				<a class="mui-control-item jh-font-size2" href="#item22004" isPublish="22004">未提交</a>
				<a class="mui-control-item jh-font-size2" href="#item22002" isPublish="22002">已提交</a>
			</div>
			<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-4"></div>
			<div id="clt-home-content" class="mui-slider-group">
				<div id="itemAll" class="mui-slider-item mui-control-content mui-active">
					<div class="mui-scroll-wrapper">
						<div id="scrolAll" class="mui-scroll jh-padding-div">
							<ul class="mui-table-view" style="background-color: rgba(0,0,0,0);">
								<li class="jh-li" style="background-image: url(../../images/list-bg/bg5.png);">
									<p>
										<span class="jh-title mui-ellipsis">湖北省黄梅县农险试点定验标</span>
									</p>
									<p class="mui-ellipsis">
										<span class="clt-span-account-name jh-subtitle">千克</span>
										<span class="clt-span-time jh-subtitle">2019-05-08</span>
									</p>
									<button type="button" class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">待下载：200</button>
									<button type="button" class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">定标中：200</button>
									<button type="button" class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">已定标：200</button>
								</li>
								<li class="jh-li" style="background-image: url(../../images/list-bg/bg4.png);">
									<p>
										<span class="jh-title mui-ellipsis">湖北省黄梅县农险试点定验标</span>
									</p>
									<p class="mui-ellipsis">
										<span class="clt-span-account-name jh-subtitle">千克</span>
										<span class="clt-span-time jh-subtitle">2019-05-08</span>
									</p>
									<button type="button"  class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">待下载：200</button>
									<button type="button"  class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">定标中：200</button>
									<button type="button"  class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">已定标：200</button>
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div id="item22004" class="mui-slider-item mui-control-content">
					<div class="mui-scroll-wrapper">
						<div id="scroll21001" class="mui-scroll">
							<ul class="mui-table-view">

							</ul>
						</div>
					</div>
				</div>
				<div id="item22002" class="mui-slider-item mui-control-content">
					<div class="mui-scroll-wrapper">
						<div id="scroll21001" class="mui-scroll">
							<ul class="mui-table-view">

							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script src="../../js/jquery-1.8.3.min.js"></script>
		<script src="../../js/mui.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<script src="../../js/url_config.js"></script>
		<script src="../../js/commons.js"></script>
		<script src="../../js/enums_config.js"></script>
		<script src="../../js/myloop.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});

			//mui slider禁止滑动
			//mui('.mui-slider').slider().stopped = true;
			var tabEventLoop = TabEventLoop.initEventLoop();
			var init = function() {
				tabEventLoop.myLoop();
				var isPublish = $("#sliderSegmentedControl a.mui-active")[0].getAttribute("isPublish");
				setTimeout(function() {
					initArticlePage(isPublish, "up");
				}, 10);
				
			};

			(function($) {
				//阻尼系数
				var deceleration = mui.os.ios ? 0.003 : 0.0009;
				$('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration: deceleration
				});

				$.ready(function() {
					//循环初始化所有下拉刷新，上拉加载。
					$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
						$(pullRefreshEl).pullToRefresh({
							down: {
								height: 50, //可选,默认50.触发下拉刷新拖动距离,
								auto: false, //可选,默认false.首次加载自动下拉刷新一次
								contentdown: "下拉可以刷新", //可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
								contentover: "释放立即刷新", //可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
								contentrefresh: "正在刷新...", //可选，正在刷新状态时，下拉刷新控件上显示的标题内容
								callback: function() {
									var self = this;
									setTimeout(function() {
										page = 1;
										var isPublish = $("#sliderSegmentedControl a.mui-active")[0].getAttribute("isPublish");
										initArticlePage(isPublish, "down");
									}, 100);
								}
							},
							up: {
								auto: false, //自动执行一次上拉加载，可选；
								show: true, //显示底部上拉加载提示信息，可选；
								contentrefresh: '正在加载...', //上拉进行中提示信息
								contentnomore: '没有更多数据了', //上拉无更多信息时提示信息
								callback: function() {
									var self = this;
									setTimeout(function() {
										var isPublish = $("#sliderSegmentedControl a.mui-active")[0].getAttribute("isPublish");
										initArticlePage(isPublish, "up");
									}, 100);
								}
							}
						});
					});


					init();


				});
			})(mui);

			var startDate;
			var endDate;
			//选项卡切换事件
			document.getElementById('clt-home-menu').addEventListener('slide', function(e) {
				if (startDate == null) {
					startDate = new Date().getTime()
					// console.log(startDate)
				} else {
					endDate = new Date().getTime()
					// console.log(endDate)
					if ((endDate - startDate) < 1000) {
						mToastSet('请勿切换的太过频繁')
					} else {
						endDate = null;
						startDate = null;
					}
				}
				tabEventLoop.setEvent(function() {
					page = 1;
					var isPublish = $("#sliderSegmentedControl a").eq(e.detail.slideNumber).attr("isPublish");
					$("#item" + isPublish).find("ul.mui-table-view").html("");
					initArticlePage(isPublish, "up");
				});
			});

			var page = 1; //开始数据条数
			var rows = 10; //每页显示条数
			var initArticlePage = function(isPublish, pullRefreshType) {
				var taskJson = {
					page: page,
					rows: rows
				};
				if (isPublish != "All") {
					taskJson.isPublish = isPublish;
				} else {

				}

				var ul = $('#item' + isPublish + ' .mui-scroll').find("ul.mui-table-view")[0];
				ul.innerHTML = ''
				var fragment = document.createDocumentFragment();
				for (var i = 0; i < 5; i++) {
					fragment.appendChild(addItem(i, isPublish));
				}
				ul.appendChild(fragment);

				// console.log(JSON.stringify(taskJson));

				// mui.ajax(FORUM_TASK.log_findShareCltTaskInfoPageInfo_url + commons.getToken(), {
				// 	data: taskJson,
				// 	dataType: 'json',
				// 	type: 'post',
				// 	timeout: 10000,
				// 	headers: {
				// 		'Content-Type': 'application/json'
				// 	},
				// 	success: function(result) {
				// 		var fragment = document.createDocumentFragment();
				// 		mui.each(result.list, function(index, obj) {
				// 			fragment.appendChild(addTask(obj, isPublish));
				// 		});
				// 		var ul = $('#item' + isPublish + ' .mui-scroll').find("ul.mui-table-view")[0];
				// 		mui('#item' + isPublish + ' .mui-scroll').pullToRefresh().refresh(true); //重置
				// 		page = result.nextPage;
				// 		var flag = false;
				// 		if (!result.hasNextPage) {
				// 			flag = true;
				// 		}
				// 		if (pullRefreshType == "up") {
				// 			ul.appendChild(fragment);
				// 			mui('#item' + isPublish + ' .mui-scroll').pullToRefresh().endPullUpToRefresh(flag);
				// 		} else if (pullRefreshType == "down") {
				// 			$("#item" + isPublish).find("ul.mui-table-view").html("");
				// 			ul.insertBefore(fragment, ul.firstChild);
				// 			if (!result.hasNextPage) {
				// 				mui('#item' + isPublish + ' .mui-scroll').pullToRefresh().endPullUpToRefresh(flag);
				// 			}
				// 			mui('#item' + isPublish + ' .mui-scroll').pullToRefresh().endPullDownToRefresh(flag);
				// 		}
				// 		listDataChange(result, flag, mui('#item' + isPublish + ' .mui-scroll')[0]);
				// 	},
				// 	error: function(xhr, ertype, errorThrown) { //异常处理；
				// 		console.log(JSON.stringify(xhr) + '  ' + ertype + ' ' + errorThrown);
				// 	}
				// });
			};

			function listDataChange(result, flag, dom) {
				emptyStr = '<div class="mui-pull-bottom-wrapper"><span class="mui-pull-loading">没有更多数据了</span></div>';
				setTimeout(function() {
					var ul = dom.firstElementChild;
					var bottomTips = dom.lastElementChild.lastElementChild;
					if (ul.innerHTML == "" && (result.pages == 0)) {
						dom.lastElementChild.lastElementChild.innerHTML = "暂无数据";
					} else if (result.pages == 1 && (result.hasNextPage == false)) {
						dom.lastElementChild.lastElementChild.innerHTML = "";
					}
					// console.log(ul.innerHTML.length);
					// console.log(dom.lastElementChild.lastElementChild.innerHTML);
				}, 0)
			}

			var totalH = document.getElementById('clt-home-content').offsetHeight;
			//li单个任务的view

			var addItem = function(index, isPublish) {
				var li = document.createElement('li');
				li.className = "jh-li";
				var loopImage
				switch (index % 5) {
					case 0:
						loopImage = "background-image: url(../../images/list-bg/bg5.png);"
						break;
					case 1:
						loopImage = "background-image: url(../../images/list-bg/bg4.png);"
						break;
					case 2:
						loopImage = "background-image: url(../../images/list-bg/bg3.png);"
						break;
					case 3:
						loopImage = "background-image: url(../../images/list-bg/bg2.png);"
						break;
					default:
						loopImage = "background-image: url(../../images/list-bg/bg1.png);"
						break;
				}
				li.setAttribute('style', loopImage);
				li.innerHTML = '<p><span class="jh-title mui-ellipsis">湖北省黄梅县农险试点定验标</span></p>' +
					'<p class="mui-ellipsis"><span class="clt-span-account-name jh-subtitle">千克</span>' +
					'<span class="clt-span-time jh-subtitle">2019-05-08</span></p>' +
					'<button type="button"  class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">待下载：200</button>' +
					'<button type="button"  class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">定标中：200</button>' +
					'<button type="button"  class="jh-show-button mui-btn mui-btn-blue mui-btn-outlined">已定标：200</button>';

				li.style.height = setItemHeight();
				return li;
			}

			function setItemHeight() {
				var titleH = mui(".mui-bar.mui-bar-nav")[0].scrollHeight
				var tabH = document.getElementById('sliderSegmentedControl').scrollHeight;
				var tabShadowH = document.getElementById('sliderProgressBar').scrollHeight;
				var allH = document.documentElement.clientHeight;
				var allW = document.documentElement.clientWidth
				console.log()
			// console.log(document.documentElement.clientHeight)
				var listH = allH - titleH - tabH - tabShadowH;
				// console.log('titleH：' + titleH)
				// console.log('tabH：' + tabH)
				// console.log('tabShadowH：' + tabShadowH)
				// console.log('allH：' + allH)
				// console.log('allW：' + allW)
				// console.log('listH：' + listH)
				var mheight = 0;
				if (listH > 600) {
					mheight = 200;
				} else if (listH < 480) {
					mheight = 160;
				} else {
					mheight = (listH / 3);
				}
				mheight = mheight - 15;
				mheight = mheight + 'px'
				// console.log('mheight：' + mheight)
				return mheight
			}
			var addTask = function(obj, isPublish) {
				var li = document.createElement('li');
				var markStr = '<span class="mui-btn {key8} clt-span-type">{key7}</span>';
				var arrowStr = '<span class="mui-pull-right mui-icon mui-icon-arrowright"></span>';
				// console.log(isPublish)
				if (isPublish != 'All') {
					markStr = "";
				}
				li.className = "mui-table-view-cell mui-media";
				var objStr = '{key}' +
					'<div class="mui-media-body mui-slider-handle">' +
					'<img class="mui-media-object mui-pull-left" src="{key1}">' +
					'<div class="mui-media-body">' +
					'<p><span style="display: inline-block; width: 90%; font-size: 16px; font-weight: bold; color:#000;" ' +
					'class="mui-ellipsis">' + markStr + '&nbsp{key2}</span></p>' +
					'<p>&nbsp{keyArrow}</p>' +
					'<p class="mui-ellipsis"><span class="clt-span-account-name">{key3}</span><span class="clt-span-time">{key4}</span></p>' +
					//'{key9}' +
					'</div>' +
					'</div>';

				var key = "",
					key1 = "../../images/1.png";
				var key2 = obj.taskName,
					key3 = (obj.creatorName == null ? "&nbsp" : obj.creatorName),
					key4 = (obj.createTime == null ? "&nbsp" : obj.createTime.substr(0, 10)),
					key5 = "mui-btn-warning",
					key6 = "未分享",
					key7 = "",
					key8 = "",
					key9 = "",
					keyArrow = "";

				key7 = "已完成";
				key8 = "mui-btn-success";

				if (obj.taskType == clt_task_type.distribution) {
					key1 = "../../images/1.png";
				} else if (obj.taskType == clt_task_type.growth) {
					key1 = "../../images/2.png";
				} else if (obj.taskType == clt_task_type.yield) {
					key1 = "../../images/3.png";
				}

				if (obj.isPublish == forum_publishStatus.WAIT_AUDIT) {
					key7 = "待审核";
					key8 = "mui-btn-blue";
					//key6 = "待审核";
					//key5 = "mui-btn-blue";
				} else if (obj.isPublish == forum_publishStatus.PUBLISHED) {
					key7 = "已分享";
					key8 = "mui-btn-success";
					//key6 = "已分享";
					//key5 = "mui-btn-success";
				}

				//key9 = '<span style="padding: 1px 1px 0px 1px;" class="mui-btn '+ key5 +' mui-btn-outlined">'+ key6 +'</span>';
				if (obj.isPublish == forum_publishStatus.PUBLISHED || obj.isPublish == forum_publishStatus.WAIT_AUDIT) {
					key = '<div class="mui-slider-right mui-disabled">' +
						'<a class="mui-btn mui-btn-green">撤回</a>' +
						'</div>';
					keyArrow = arrowStr;
				}



				var objKey = {
					'key': key,
					'key1': key1,
					'key2': key2,
					'key3': key3,
					"key4": key4,
					'key5': key5,
					'key6': key6,
					'key7': key7,
					'key8': key8,
					'key9': key9,
					'keyArrow': keyArrow,
				};
				li.innerHTML = objStr.formatCLT(objKey);
				li.setAttribute('taskId', obj.taskId);
				li.setAttribute('isPublish', obj.isPublish);
				li.setAttribute('taskType', obj.taskType);
				li.className = 'mui-table-view-cell';
				if (totalH > 700) {
					li.style.height = '100px';
				} else if (totalH < 420) {
					li.style.height = '60px';
				} else {
					li.style.height = (totalH / 7) + 'px';
				}
				// console.log('单元格高度：' + li.style.height)
				return li;
			};



			(function($) {
				var btnArray = ['确认', '取消'];
				//第二个demo，向左拖拽后显示操作图标，释放后自动触发的业务逻辑
				$('#itemAll, #item22004, #item22002').on('tap', '.mui-slider-right .mui-btn', function(event) {
					var elem = this;
					var li = elem.parentNode.parentNode;
					var taskId = li.getAttribute("taskid");
					var isPublish = li.getAttribute("isPublish");

					if (elem.className.indexOf('mui-btn-green') != -1) { //撤回

						var dataJson = {
							"taskId": taskId,
							"isPublish": forum_publishStatus.RECALLED
						};

						mui.confirm('确认撤回任务？', '提示', btnArray, function(e) {
							if (e.index == 0) {

								mui.ajax(FORUM_TASK.log_updateTaskStatusByTaskId_url + commons.getToken(), {
									data: dataJson,
									dataType: 'json',
									type: 'post',
									timeout: 10000,
									headers: {
										'Content-Type': 'application/json'
									},
									success: function(result) {

										var isPublish = $("#sliderSegmentedControl a.mui-active")[0].getAttribute("isPublish");
										mui("#item" + isPublish + " .mui-scroll").pullToRefresh().pullDownLoading(); //下拉刷新
									},
									error: function(xhr, ertype, errorThrown) { //异常处理；
										console.log(JSON.stringify(xhr) + '  ' + ertype + ' ' + errorThrown);
										console.log('分享任务异常');
									}
								});

								setTimeout(function() {
									$.swipeoutClose(li);
								}, 0);
							} else {
								setTimeout(function() {
									$.swipeoutClose(li);
								}, 0);
							}
						});
					}

				});
			})(mui);


			//详情跳转
			mui(".mui-table-view").on('tap', '.mui-table-view-cell', function() {
				//获取taskId
				var taskId = this.getAttribute("taskId");
				var taskType = this.getAttribute("taskType");
				var taskName = this.getElementsByTagName("span")[0].textContent;

				//打开任务采集数据列表详情
				mui.openWindow({
					id: 'collection-list.html',
					url: 'my-clt-list.html?taskId=' + taskId + '&taskType=' + taskType + '&taskName=' + encodeURI(taskName),
					show: {
						aniShow: 'pop-in'
					},
					styles: {
						popGesture: 'hide'
					},
					extras: {
						taskName: taskName
					},
					waiting: {
						autoShow: false
					}
				});
			});

			mui("#scrolAll").on('tap', '.jh-li', function() {
				console.log("123")
				mui.openWindow({
					id: "itemlist.html",
					url: "itemlist.html",
				})
			});

			//init();
		</script>
	</body>

</html>
