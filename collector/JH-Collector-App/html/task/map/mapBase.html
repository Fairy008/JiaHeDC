<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<meta charset="utf-8">
		<meta http-equiv="imagetoolbar" content="no" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/app.css" type="text/css" charset="utf-8" />
		<link href="../../../js/v4.6.5-dist/ol.css" ref="stylesheet" />
		<script src="../../../js/v4.6.5-dist/ol.js"></script>
		<script src="../../../js/mui.js"></script>
		<script src="../../../js/app.js"></script>
		<script src="../../../js/areaData.js"></script>
		<script src="../../../js/v4.6.5-dist/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
		<style type="text/css">
			#osmCheckbox,
			#osmCheckboxLabel {
				bottom: 10px;
				position: absolute
			}

			#layerList,
			#osmCheckbox,
			#osmCheckboxLabel,
			#slider {
				position: absolute
			}

			#layerList {
				top: 30px;
				right: 0;
				bottom: 0;
				width: 220px;
				overflow: auto
			}

			#map,
			.ol-overlaycontainer-stopevent,
			body,
			html {
				overflow: hidden
			}

			#layerList div {
				color: #000;
				cursor: pointer
			}

			#layerList div.hidden {
				opacity: .3
			}

			#layerList div div {
				width: 15px;
				height: 15px;
				display: inline-block
			}

			#osmCheckbox {
				left: 10px
			}

			#osmCheckboxLabel {
				left: 30px;
				text-shadow: #fff 0 0 8px
			}

			#slider {
				width: 200px;
				top: 10px;
				right: 10px;
				background: #fff;
				color: #fff
			}

			#map,
			body,
			html {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
				background: #fff, color:#333;
				font-family: Arial, sans-serif;
				font-size: 14px;
				line-height: 1
			}

			#map {
				top: 0;
				left: 0;
				right: 230px;
				bottom: 0;
				width: auto
			}

			#map,
			.ol-popup {
				position: absolute
			}

			.map-controls a.primary,
			.map-controls a.primary:active,
			.map-controls a.primary:focus,
			.map-controls a.primary:hover,
			.ol-control button.primary,
			.ol-control button.primary:active,
			.ol-control button.primary:focus,
			.ol-control button.primary:hover {
				color: #fff;
				background: #6941aa;
				border: 1px solid #6941aa
			}

			.map-controls a:active,
			.map-controls a:focus,
			.map-controls a:hover,
			.ol-control button:active,
			.ol-control button:focus,
			.ol-control button:hover {
				color: #6941aa;
				background: #fff;
				border: 1px solid #977dc7
			}

			.map-controls a .disabled,
			.map-controls a.disabled,
			.ol-control button .disabled,
			.ol-control button.disabled {
				background-color: #e6e6e6
			}

			.map-controls a span:first-child,
			.ol-control button span:first-child {
				display: none
			}

			.map-controls a .enabled span:first-child,
			.map-controls a span:last-child,
			.map-controls a.enabled span:first-child,
			.ol-control button .enabled span:first-child,
			.ol-control button span:last-child,
			.ol-control button.enabled span:first-child {
				display: block
			}

			.map-controls a .enabled,
			.map-controls a.enabled,
			.ol-control button .enabled,
			.ol-control button.enabled {
				color: #6941aa;
				background: #fff;
				border: 1px solid #6941aa;
				z-index: 12
			}

			.map-controls a .enabled span:last-child,
			.map-controls a.enabled span:last-child,
			.ol-control button .enabled span:last-child,
			.ol-control button.enabled span:last-child {
				display: none
			}

			.ol-control button {
				vertical-align: middle;
				font-family: icons;
				display: block;
				position: relative;
				color: #848788;
				background: #fff;
				text-decoration: none;
				width: 36px;
				height: 36px;
				font-size: 21.6px;
				text-align: center;
				margin: -1px 0;
				font-weight: 700;
				cursor: pointer;
				z-index: 10;
				border: 1px solid #977dc7;
				line-height: 1.2em;
				padding-bottom: 5px
			}

			.ol-control.ol-attribution button {
				display: inline-block
			}

			.ol-control,
			.ol-control:hover {
				background-color: transparent;
				border-radius: 0;
				padding: 0
			}

			.ol-scale-line {
				background: 0 0
			}

			.ol-scale-line-inner {
				border: 1px solid #fff;
				border-top: none;
				color: #fff
			}

			.ol-popup {
				background-color: #fff;
				-webkit-filter: drop-shadow(0 1px 4px rgba(0, 0, 0, .2));
				filter: drop-shadow(0 1px 4px rgba(0, 0, 0, .2));
				padding: 10px;
				border-radius: 10px;
				border: 1px solid #ccc;
				bottom: 12px;
				left: -50px;
				font-size: 11px;
				min-width: 150px
			}

			.ol-popup:after,
			.ol-popup:before {
				top: 100%;
				border: solid transparent;
				content: " ";
				height: 0;
				width: 0;
				position: absolute;
				pointer-events: none
			}

			.ol-popup:after {
				border-top-color: #fff;
				border-width: 10px;
				left: 48px;
				margin-left: -10px
			}

			.ol-popup:before {
				border-top-color: #ccc;
				border-width: 11px;
				left: 48px;
				margin-left: -11px
			}

			.inspect-layer {
				font-weight: 700;
				line-height: 2
			}

			.inspect-layer:not(:first-child) {
				border-top: 1px solid #ccc
			}

			.inspect-row {
				display: table-row;
				line-height: 1.8
			}

			.inspect-name,
			.inspect-value {
				display: table-cell
			}

			.inspect-value {
				padding-left: 10px
			}
		</style>
	</head>
	<body class="mui-plus mui-statusbar mui-statusbar-offset">

		<div id="map" class="map"></div>
		<script>
			// console.log(document.documentElement.clientWidth)
			// console.log(document.documentElement.clientHeight)

			var self = null;

			mui.plusReady(function() {
				plus.navigator.setStatusBarStyle('dark');
				self = plus.webview.currentWebview();
				// mui.fire(plus.webview.getWebviewById("mapAreaEdit.html"),'DataChange');
				mui.fire(plus.webview.getWebviewById("mapBottom.html"), 'DataChange');
				createSubview();
			})


			var mMapView = document.getElementById("map")
			mMapView.style.width = document.documentElement.clientWidth + 'px';
			mMapView.style.height = document.documentElement.clientHeight + 'px';
			//define raster and vector tile url .

			// var rasterTileUrl = '../../../qixincun/raster_tile/{z}/{x}/{y}.jpg';
			// var vectorTileUrl = '../../../qixincun/vector_tile/{z}/{x}/{y}.pbf';
			// var shapeGeoJsonUrl = '../../../qixincun/pengqiaocun.json';


			// var rasterTileUrl = '/sdcard/Android/data/io.dcloud.HBuilder/apps/HBuilder/www/resources/map/pengqiaocun/raster_tile/{z}/{x}/{y}.jpg';
			// var shapeGeoJsonUrl = '/sdcard/Android/data/io.dcloud.HBuilder/apps/HBuilder/www/resources/map/pengqiaocun/pengqiaocun.json';


			// var rasterTileUrl = '/sdcard/Android/data/io.dcloud.HBuilder/dowloads/pengqiaocun/raster_tile/{z}/{x}/{y}.jpg';
			// var shapeGeoJsonUrl = '/sdcard/Android/data/io.dcloud.HBuilder/dowloads/pengqiaocun/pengqiaocun.json'; 

			// var rasterTileUrl = '_downloads/pengqiaocun/raster_tile/{z}/{x}/{y}.jpg';
			// var shapeGeoJsonUrl = '_downloads/pengqiaocun/pengqiaocun.json'; 

			// var rasterTileUrl = "file:///storage/emulated/0/Android/testDownload/pengqiaocun/raster_tile/{z}/{x}/{y}.jpg";
			// var shapeGeoJsonUrl = "file:///storage/emulated/0/Android/testDownload/pengqiaocun/pengqiaocun.json";
			var rasterTileUrl = '../../../pengqiaocun/raster_tile/{z}/{x}/{y}.jpg';
			var shapeGeoJsonUrl = '../../../pengqiaocun/pengqiaocun.json';


			var defaultControl = new ol.control.defaults({
				zoom: false,
				rotate: false,
				attribution: false
			});

			//define map zoom level and initial zoom size 
			var mapMinZoom = 14;
			var mapMaxZoom = 20;
			var zoom = 18;

			//define projection 4326 csr.
			var proj = 'EPSG:4326';
			// var mapExtent = [115.719852, 29.723387, 116.129857, 30.312653];
			// var center = [115.99932, 30.08128];
			var center = [115.94978, 29.78308];

			// define projection 3857 csr.	
			proj = ol.proj.get('EPSG:3857');
			proj = 'EPSG:3857';
			// proj = ol.proj.get('EPSG:4326');
			// mapExtent = ol.proj.transformExtent(mapExtent, 'EPSG:4326', proj);
			center = ol.proj.fromLonLat(center, proj);

			//create raster layer
			var offlineRasterLayer = new ol.layer.Tile({
				source: new ol.source.XYZ({
					url: rasterTileUrl,
					tilePixelRatio: 1,
					minZoom: mapMinZoom,
					maxZoom: mapMaxZoom
				})
			});

			var baseSource = new ol.source.Vector({
				projection: proj,
				url: shapeGeoJsonUrl,
				format: new ol.format.GeoJSON()
			})

			var GeoJsonLayer = new ol.layer.Vector({
				source: baseSource,
				style: new ol.style.Style({
					fill: new ol.style.Fill({ //填充样式
						color: 'rgba(255, 255, 255, 0)'
					}),
					stroke: new ol.style.Stroke({ //线样式
						color: '#ffcc33',
						width: 2
					}),
					image: new ol.style.Circle({ //点样式
						radius: 7,
						fill: new ol.style.Fill({
							color: '#FFFFFF'
						})
					})
				})
			});

			/**
			 * 编辑相关
			 * */

			//创建一个交互选择对象
			var select = new ol.interaction.Select({
				//水平包裹
				//Wrap the world horizontally on the selection overlay
				wrapX: false
			});

			//创建一个交互修改对象
			var modify = new ol.interaction.Modify({
				//设置要素为交互选择对象所获取的要素
				features: select.getFeatures()
			});
			modify.on('modifyend', modifyLs);
			modify.setActive(false)


			//监听Modify函数
			function modifyLs(evt) {
				modifyFeaTure = evt.features.item(0)
				var extent = evt.features.item(0).getGeometry().getCoordinates()
				// console.log(extent);
			}

			/**
			 * 地图容器
			 * */

			var map = new ol.Map({
				interactions: ol.interaction.defaults().extend([select, modify]),
				controls: defaultControl,
				target: 'map',
				view: new ol.View({
					projection: proj,
					center: center,
					zoom: zoom,
					minZoom: mapMinZoom,
					maxZoom: mapMaxZoom,
				})
			});
			map.addLayer(offlineRasterLayer);
			// map.addLayer(offlineVectorLayer);
			map.addLayer(GeoJsonLayer);

			/*
			 * 新增区域
			 * */
			var draw;

			function drawPolygon() {
				map.removeInteraction(draw);
				map.removeInteraction(modify);
				draw = new ol.interaction.Draw({
					source: baseSource,
					type: "Polygon",
				});
				draw.on('drawend', function(event) {
					var feature = event.feature;
					var geometry = feature.getGeometry();
					var coordinate = geometry.getCoordinates();
					var timestamp = parseInt(new Date().getTime() / 1000)
					feature.setId("new" + timestamp)
					console.log("id:" + feature.getId())
					console.log(coordinate)
					// map.removeInteraction(draw);
					select.setActive(false)
					setTimeout(function() {
						select.setActive(true)
					}, 10);

				})
				map.addInteraction(draw);
			}

			/*
			 * 分离
			 * */

			var selectFeaTure = null;
			var modifyFeaTure = null;

			select.on('select', selectFunc);

			function selectFunc(e) {
				if (e.selected != null) {
					var features = e.selected;
					var feature = features[0];
					selectFeaTure = feature
					var geometry = feature.getGeometry();
					var coordinate = geometry.getCoordinates();
					var area = geometry.getArea()
					console.log(getAreaStr(area)); //打印已选择的Feature

					startSeparate();
				}
			}

			function addArea2Source(areadata, targetsource) {
				var coordinatesPolygon = [];
				console.log("areadata:  " + areadata)
				// console.log(areadata[0].length)
				areadata = areadata[0]
				for (var i = 0; i < areadata.length; i++) {
					var pointTransform = ol.proj.transform([areadata[i][0], areadata[i][1]], 'EPSG:3857', 'EPSG:4326');
					// console.log(pointTransform)
					pointTransform = ol.proj.fromLonLat(pointTransform, proj);
					coordinatesPolygon.push(pointTransform);
				}
				console.log("coordinatesPolygon:  " + coordinatesPolygon)

				var plygon = new ol.geom.Polygon([coordinatesPolygon])
				var feature = new ol.Feature({
					geometry: plygon,
				});
				targetsource.addFeature(feature);
				// setTimeout(function() {
				// 	var view = map.getView();
				// 	// 设置地图等级
				// 	view.setZoom(18);
				// 	view.animate({
				// 		center: [115.95068437711754,29.784934432735497],
				// 		duration: 0
				// 	});
				// }, 100);
			}

			// var testArea = [
			// 	[
			// 		[12907571.141992306,3475935.0171492305],
			// 		[12907592.29867108,3475895.638112055],
			// 		[12907614.592801293,3475929.443609843],
			// 		[12907571.141992306,3475935.0171492305]
			// 	]
			// ]

			// setTimeout(function() {
			// 	addArea2Source(testArea, baseSource);
			// }, 100);


			// 			var spearateSource = new ol.source.Vector();
			// 			var spearateVector = new ol.layer.Vector({
			// 				source: spearateSource,
			// 				zIndex: 9,
			// 				style: new ol.style.Style({
			// 					fill: new ol.style.Fill({
			// 						color: 'rgba(255, 255, 0, 1)'
			// 					}),
			// 					stroke: new ol.style.Stroke({
			// 						color: 'red',
			// 						width: 2
			// 					}),
			// 					image: new ol.style.Circle({
			// 						radius: 10,
			// 						fill: new ol.style.Fill({
			// 							color: '#ffcc33'
			// 						})
			// 					})
			// 				})
			// 			});
			// 
			// 			map.addLayer(spearateVector)

			var initSelectArea = [];


			function startSeparate() {
				if (mapState == 4) {
					if (selectFeaTure != null) {
						if (initSelectArea.length == 0) {
							initSelectArea = selectFeaTure.getGeometry().getCoordinates()
							console.log(initSelectFeaTure.getGeometry().getCoordinates());
						}
						// console.log('1234')
						//关闭原油select modify 根据选中feature激活另一个feature的选中修改

						// spearateSource.addFeature(selectFeaTure)
					}

				}
			}

			function endSeparate() {
				if (mapState == 5) {
					if (initSelectArea.length != 0) {
						addArea2Source(initSelectArea, baseSource)
						// console.log(selectFeaTure.getGeometry().getCoordinates().length);
						// console.log(modifyFeaTure.getGeometry().getCoordinates().length);

					}
				}
			}

			/*
			 * 功能函数
			 */

			function mapLocation() {
				var view = map.getView();
				// 设置地图等级
				view.setZoom(18);
				view.animate({
					center: center,
					duration: 0
				});
			}

			function mapSetPoint(point) {
				console.log(point[0] + " | " + point[1])
				// ol.proj.transform(point[0], point[1], 'EPSG:3857', 'EPSG:4326')
				// point = ol.proj.fromLonLat(point, 'EPSG:3857');
				var view = map.getView();
				// 设置地图等级
				view.setZoom(18);
				view.animate({
					center: point,
					duration: 0
				});
			}

			document.addEventListener('mapSetPoint', function() {
				var point = JSON.parse(localStorage.getItem("mapSetPoint"))
				// console.log("mapSetPoint:"+point)
				// console.log("mapSetPoint:"+point)
				mapSetPoint(point)
			})




			var mapState = -1;

			function changeMapState(mapstate) {
				mapState = mapstate
				switch (mapState) {
					case 0: //开启新增
						select.setActive(false)
						// map.removeInteraction(modify);
						drawPolygon();
						break;
					case 1: //关闭新增
						map.removeInteraction(draw);
						select.setActive(true)
						// map.addInteraction(modify);

						break;
					case 2: //开启编辑
						modify.setActive(true)
						map.addInteraction(modify);
						break;
					case 3: //关闭编辑
						modify.setActive(false)
						map.removeInteraction(modify);
						select.setActive(false)
						setTimeout(function() {
							select.setActive(true)
						}, 100);
						break;
					case 4: //开启分离
						modify.setActive(true)
						map.addInteraction(modify);
						startSeparate();
						break;
					case 5: //关闭分离
						modify.setActive(false)
						map.removeInteraction(modify);
						endSeparate();
						select.setActive(false)
						setTimeout(function() {
							select.setActive(true)
						}, 100);
						break;
					default:
						break;
				}
			}


			var wsubTitle
			var wsubArea
			var wsubRightButton
			var wsubBottom

			function createSubview() {
				wsubTitle = plus.webview.create('mapTitle.html', 'mapTitle.html', {
					// top: '0',
					width: '100%',
					height: '66px',
					position: 'absolute',
					scrollIndicator: 'none',
					background: 'transparent'
				});
				wsubArea = plus.webview.create('mapAreaEdit.html', 'mapAreaEdit.html', {
					top: '80px',
					left: '2%',
					width: '96%',
					height: '100px',
					position: 'absolute',
					scrollIndicator: 'none',
					background: 'transparent'
				});
				wsubRightButton = plus.webview.create('mapButton.html', 'sub', {
					right: '2%',
					bottom: '32%',
					width: '45px',
					height: '40%',
					position: 'absolute',
					scrollIndicator: 'none',
					background: 'transparent'
				});
				wsubBottom = plus.webview.create('mapBottom.html', 'mapBottom.html', {
					bottom: '-200px',
					width: '100%',
					height: '410px',
					position: 'absolute',
					scrollIndicator: 'none',
					background: 'transparent'
				});
				self.append(wsubTitle);
				self.append(wsubArea);
				self.append(wsubRightButton);
				self.append(wsubBottom);
			}

			setTimeout(function() {
				var webObj = plus.webview.getWebviewById("mapAreaEdit.html");
				mui.fire(webObj, 'DataChange');
			}, 500);

			/*
			 *田块按钮相关
			 * */
			//田块面积
			function getAreaStr(area) {
				var result = '';
				if (area < 100) {
					result = Math.floor(area * 100) / 100 + '平方米';
				} else {
					area = area * 15 / 10000
					result = Math.floor(area * 100) / 100 + '亩'
				}
				return result
			}

			//初始化相关
			var subtaskId;
			var policyInfo

			function initAreaList() {
				subtaskId = localStorage.getItem("currentSubTaskId")
				var data = areaInfo.getPolicyList(subtaskId)
				// console.log("data:"+JSON.stringify(data))
				var policyId = areaInfo.getCurrentPolicy();
				// console.log(policyId)
				policyInfo = areaInfo.getItemById(data, policyId)
				var areaList = policyInfo.insuredArea

				console.log(JSON.stringify(areaList))

				mui.fire(plus.webview.getWebviewById("mapBottom.html"), 'initData')
				if (areaList.length > 0) {
					// console.log(areaList[0].FeatureId == null)
					if (areaList[0].FeatureId != null) {
						console.log(areaList[0].FeatureId)
						var policyId = areaInfo.getCurrentPolicy();
						for (var i in areaList) {
							var targetFeature = areaData.selectById(GeoJsonLayer, areaList[i].FeatureId)
							areaData.setFeatureStyle(targetFeature)
							areaList[i].center = areaData.getFeatureCenter(targetFeature)
							areaList[i].coordinates = targetFeature.getGeometry().getCoordinates()
							// console.log(areaList[i].center)
						}
						areaInfo.setAreaById(subtaskId, policyId, areaList)
					}
					// console.log(JSON.stringify(areaList))
					mapSetPoint(areaList[0].center)
				}
			}

			setTimeout(function() {
				mToastSet("初始化离线资料中")
				initAreaList()
				// for (var i in areaList) {
				// 	setTimeout(function() {
				// 		console.log(areaList[i].center)
				// 		mapSetPoint(areaList[i].center)
				// 	}, 2000);
				// }
				// console.log(areaList[0].center)

			}, 3000);

			//添加田块
			function addAreaItem() {
				if (selectFeaTure != null) {
					if (selectFeaTure.getId() != null && (selectFeaTure.getStyle() == null)) {
						areaData.setFeatureStyle(selectFeaTure);
						var data = areaInfo.getPolicyList(subtaskId)
						var policyId = areaInfo.getCurrentPolicy();
						policyInfo = areaInfo.getItemById(data, policyId)
						var currentData = policyInfo.insuredArea
						// console.log("currentData"+currentData)
						// console.log(JSON.stringify(currentData))

						var areaJson = {
							"areaName": "田块" + (currentData.length + 1),
							"isEdit": false,
							"area": 0,
							"crop": "",
							"center": areaData.getFeatureCenter(selectFeaTure),
							"FeatureId": selectFeaTure.getId().toString(),
							"imageList": []
						}
						currentData.push(areaJson);
						areaInfo.setAreaById(subtaskId, policyId, currentData)
						localStorage.setItem("mapAddAreaItem", JSON.stringify(areaJson))
						mui.fire(plus.webview.getWebviewById("mapBottom.html"), 'changeData')
						mui.fire(plus.webview.getWebviewById("mapBottom.html"), 'addAreaItem')
					} else {
						// mToastSet("选中田块异常！")
						// throw "选中田块异常！"
						toggleBottomDiv()
					}
				} else {
					// mToastSet("未选中田块区域！")
					toggleBottomDiv()
				}
			}

			var isBottomDivShow = true;

			function toggleBottomDiv() {
				if (isBottomDivShow) {
					isBottomDivShow = false
					wsubBottom.hide()
				} else {
					isBottomDivShow = true
					wsubBottom.show()
				}

			}

			//移出田块
			document.addEventListener("removeAreaItem", removeAreaItem)

			function removeAreaItem() {
				var areaId = localStorage.getItem("mapRemoveAreaItem")
				var targetFeature = areaData.selectById(GeoJsonLayer, areaId)

				var data = areaInfo.getPolicyList(subtaskId)
				var policyId = areaInfo.getCurrentPolicy();
				var currentData = areaInfo.getAreaById(data, policyId)
				console.log("currentData" + currentData)
				for (var i in currentData) {
					if (areaId == currentData[i].FeatureId) {
						currentData.splice(i, 1)
					}
				}
				setTimeout(function() {
					areaInfo.setAreaById(subtaskId, policyId, currentData)
				}, 10);

				mui.fire(plus.webview.getWebviewById("mapBottom.html"), 'changeData')
				targetFeature.setStyle(null);
			}
		</script>
	</body>
</html>
