<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jh.data.mapping.IDsGrowthMapper" >
    <resultMap id="BaseResultMap" type="com.jh.data.entity.DsGrowth" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="region_id" property="regionId" jdbcType="BIGINT" />
        <result column="remark" property="remark" jdbcType="VARCHAR" />
        <result column="data_status" property="dataStatus" jdbcType="CHAR" />
        <result column="del_flag" property="delFlag" jdbcType="CHAR" />
        <result column="create_time" property="createTime" jdbcType="DATE" />
        <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
        <result column="creator" property="creator" jdbcType="INTEGER" />
        <result column="modify_time" property="modifyTime" jdbcType="DATE" />
        <result column="modifier_name" property="modifierName" jdbcType="VARCHAR" />
        <result column="modifier" property="modifier" jdbcType="INTEGER" />
        <result column="crop_id" property="cropId" jdbcType="INTEGER" />
        <result column="lowest" property="lowest" jdbcType="NUMERIC" />
        <result column="lower" property="lower" jdbcType="NUMERIC" />
        <result column="low" property="low" jdbcType="NUMERIC" />
        <result column="normal" property="normal" jdbcType="NUMERIC" />
        <result column="high" property="high" jdbcType="NUMERIC" />
        <result column="higher" property="higher" jdbcType="NUMERIC" />
        <result column="highest" property="highest" jdbcType="NUMERIC" />


        <!--<result column="growth_min" property="growthMin" jdbcType="NUMERIC" />-->
        <!--<result column="growth_max" property="growthMax" jdbcType="NUMERIC" />-->
        <!--<result column="growth_stddev" property="growthStddev" jdbcType="NUMERIC" />-->
        <result column="data_time" property="dataTime" jdbcType="DATE" />
        <result column="data_type" property="dataType" javaType="INTEGER"/>
        <result column="publish_status" property="publishStatus" jdbcType="INTEGER" />
        <result column="publish_time" property="publishTime" jdbcType="DATE" />
        <result column="publisher_name" property="publisherName" jdbcType="VARCHAR" />
        <result column="publisher" property="publisher" jdbcType="INTEGER" />
        <result column="region_name" property="regionName" jdbcType="VARCHAR" />
        <result column="region_code" property="regionCode" jdbcType="VARCHAR" />
        <result column="crop_name" property="cropName" jdbcType="VARCHAR" />
        <result column="dataType_value" property="dataTypeValue" jdbcType="VARCHAR" />
        <result column="resolution" property="resolution" jdbcType="INTEGER" />
        <result column="resolution_value" property="resolutionValue" jdbcType="VARCHAR" />
        <result column="publish_status_name" property="publishStatusName" jdbcType="VARCHAR" />
    </resultMap>
    <sql id="Base_Column_List" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id,region_id,remark,data_status,create_time,creator_name,modify_time,modifier_name,modifier,crop_id,
        lowest,lower,low,normal,high,higher,highest,data_time,data_type,publish_status,publish_time,publisher_name,
        publisher,del_flag,
        (select china_name from init_region where init_region.region_id = ds_growth.region_id) as region_name,
        (select region_code from init_region where init_region.region_id = ds_growth.region_id) as region_code,
        (select data_name from init_dict where init_dict.parent_id = 500 and init_dict.dict_id = ds_growth.crop_id) as crop_name,
        (select data_name from init_dict where init_dict.parent_id = 4000 and init_dict.dict_id = ds_growth.data_type) as dataType_value
    </sql>
    <select id="findByPage" resultMap="BaseResultMap" parameterType="com.jh.data.model.DsGrowthParam" >
        SELECT
        ds.ID,
        ds.region_id,
        ds.remark,
        ds.data_status,
        ds.create_time,
        ds.creator_name,
        ds.modify_time,
        ds.modifier_name,
        ds.modifier,
        ds.crop_id,
        ds.lowest,
        ds.lower,
        ds.low,
        ds.normal,
        ds.high,
        ds.higher,
        ds.highest,
--         ds.growth,
--         ds.growth_min,
--         ds.growth_max,
--         ds.growth_stddev,
        ds.data_time,
        ds.data_type,
        ds.publish_status,
        ds.publish_time,
        ds.publisher_name,
        ds.publisher,
        ds.del_flag,
        (select d.data_name from init_dict d where d.data_status = '1' and d.del_flag = '1' and ds.crop_id = d.dict_id and d.parent_id = 500) AS crop_name,
        r.china_name AS region_name,
        r.region_code,
        ds.resolution,
        (select dr.data_name from init_dict dr where dr.del_flag = '1' and dr.data_status = '1' and ds.resolution = dr.dict_id and dr.parent_id = 4000) AS resolution_value,
        (select dp.data_name from init_dict dp where dp.del_flag = '1' and dp.data_status = '1' and ds.publish_status = dp.dict_id and dp.parent_id = 2200) AS publish_status_name
        FROM
        /*ds_growth ds*/
        (select *  from ds_growth where id in (select max(id) from ds_growth ds GROUP BY region_id,crop_id,data_time,resolution)) ds
        LEFT JOIN init_region r ON ds.region_id = r.region_id
        AND r.del_flag = '1'
        AND r.data_status = '1'
        WHERE
        ds.del_flag = '1'
        AND ds.data_status = '1'
        <if test="id!=null and id!=''">
            AND  ds.id = #{id,jdbcType=INTEGER}
        </if>
        <!--<if test="regionId!=null and regionId!=''">
            AND  ds.region_id = #{regionId,jdbcType=INTEGER}
        </if>-->
        <if test="cropId!=null and cropId!=''">
            AND  ds.crop_id = #{cropId,jdbcType=INTEGER}
        </if>
        <if test="dataType!=null and dataType!=''">
            AND  ds.data_type = #{dataType,jdbcType=INTEGER}
        </if>
        <if test="resolution!=null and resolution!=''">
            AND  ds.resolution = #{resolution,jdbcType=INTEGER}
        </if>
        <if test="publishStatus!=null and publishStatus!=''">
            AND  ds.publish_status = #{publishStatus,jdbcType=INTEGER}
        </if>
        <if test="publisherName!=null and publisherName!=''">
            AND  ds.publisher_name like CONCAT('%', #{publisherName}, '%')
        </if>
        <if test="startTime != null and startTime != '' and endTime != null and endTime != ''">
            AND ds.data_time BETWEEN CAST((#{startTime} || ' 00:00:00') AS  TIMESTAMP)AND CAST((#{endTime} || ' 23:59:59') AS TIMESTAMP)
        </if>
        <if test="regionCode!=null and regionCode!=''">
            AND r.region_code like #{regionCode,jdbcType=VARCHAR} || '%'
        </if>
        ORDER BY
        <choose>
            <when test="sidx != null and sidx != ''">
                ${sidx} ${sord}
            </when>
            <otherwise>
                ds.publish_status DESC, ds.data_time desc
            </otherwise>
        </choose>
    </select>

    <select id="findListByProductId" resultMap="BaseResultMap" parameterType="com.jh.data.model.DsGrowthParam" >
        SELECT
        ds.ID,
        ds.region_id,
        ds.remark,
        ds.data_status,
        ds.create_time,
        ds.creator_name,
        ds.modify_time,
        ds.modifier_name,
        ds.modifier,
        ds.crop_id,
        ds.lowest,
        ds.lower,
        ds.low,
        ds.normal,
        ds.high,
        ds.higher,
        ds.highest,
        ds.data_time,
        ds.data_type,
        ds.publish_status,
        ds.publish_time,
        ds.publisher_name,
        ds.publisher,
        ds.del_flag,
        ds.resolution
        FROM
        ds_growth ds
        WHERE
        ds.del_flag = '1'
        AND ds.data_status = '1'
        AND product_id = #{productId,jdbcType=INTEGER}
        ORDER BY
        <choose>
            <when test="sidx != null and sidx != ''">
                ${sidx} ${sord}
            </when>
            <otherwise>
                ds.region_id
            </otherwise>
        </choose>
    </select>

    <update id="updateDsGrowth" parameterType="com.jh.data.model.DsGrowthParam">
        update  ds_growth
        <set >
            <if test="regionId != null" > region_id = #{regionId}, </if>
            <if test="remark != null" > remark = #{remark},</if>
            <if test="dataStatus != null" > data_status = #{dataStatus},</if>
            <if test="delFlag != null" > del_flag = #{delFlag}, </if>
            modify_time = now(),
            <if test="modifierName != null" > modifier_name = #{modifierName},</if>
            <if test="modifier != null" > modifier = #{modifier}, </if>
            <if test="cropId != null" > crop_id = #{cropId}, </if>

            <if test="lowest != null" > lowest = #{lowest}, </if>
            <if test="lower != null" > lower = #{lower}, </if>
            <if test="low != null" > low = #{low}, </if>
            <if test="normal != null" > normal = #{normal}, </if>
            <if test="high != null" > high = #{high}, </if>
            <if test="higher != null" > higher = #{higher}, </if>
            <if test="highest != null" > highest = #{highest}, </if>

            <!--<if test="growth != null" > growth = #{growth}, </if>-->
            <!--<if test="growthMin != null" > growth_min = #{growthMin}, </if>-->
            <!--<if test="growthMax != null" > growth_max = #{growthMax}, </if>-->
            <!--<if test="growthStddev != null" > growth_stddev = #{growthStddev}, </if>-->
            <if test="dataType != null" > data_type = #{dataType}, </if>
            <if test="publishStatus != null" > publish_status = #{publishStatus}, </if>
            <if test="publishTime != null" > publish_time = to_date(#{publishTime},'yyyy-MM-dd hh24:mi:ss'), </if>
            <if test="publisherName != null" > publish_name = #{publishName}, </if>
            <if test="publisher != null" > publisher = #{publisher}, </if>
        </set>
        where 1=1
        <if test="id!=null and id!=''">
            AND  id = #{id,jdbcType=INTEGER}
        </if>
        <if test="productId!=null and productId!=''">
            AND  product_id = #{productId,jdbcType=INTEGER}
        </if>
    </update>

    <select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
        SELECT
        ds.ID,
        ds.region_id,
        ds.remark,
        ds.data_status,
        ds.create_time,
        ds.creator_name,
        ds.modify_time,
        ds.modifier_name,
        ds.modifier,
        ds.crop_id,
        ds.lowest,
        ds.lower,
        ds.low,
        ds.normal,
        ds.high,
        ds.higher,
        ds.highest,

--         ds.growth,
--         ds.growth_min,
--         ds.growth_max,
--         ds.growth_stddev,
        ds.data_time,
        ds.data_type,
        ds.publish_status,
        ds.publish_time,
        ds.publisher_name,
        ds.publisher,
        ds.del_flag,
        d.data_name AS crop_name,
        r.china_name AS region_name,
        r.region_code,
        dr.data_name AS resolution_value ,
        dp.data_name as publish_status_name
        FROM
        ds_growth ds
        LEFT JOIN init_dict d ON ds.crop_id = d.dict_id
        AND d.parent_id = 500
        LEFT JOIN init_dict dr ON ds.resolution = dr.dict_id
        AND dr.parent_id = 4000
        AND dr.del_flag = '1'
        AND dr.data_status = '1'
        left join init_dict dp on ds.publish_status=dp.dict_id
        and dp.parent_id=2200
        and dp.del_flag='1'
        and dp.data_status='1'
        LEFT JOIN init_region r ON ds.region_id = r.region_id
        AND r.del_flag = '1'
        AND r.data_status = '1'
        WHERE
        ds.del_flag = '1'
        AND ds.data_status = '1'
        AND id = #{id,jdbcType=INTEGER}
    </select>

    <select id="findDsGrowthReportCreateData" resultMap="BaseResultMap" parameterType="com.jh.data.model.ReportCreateParam">
        SELECT
            g.id,
            g.region_id,
            g.remark,
            g.data_status,
            g.create_time,
            g.creator_name,
            g.modify_time,
            g.modifier_name,
            g.modifier,
            g.crop_id,
            g.lowest,
            g.lower,
            g.low,
            g.normal,
            g.high,
            g.higher,
            g.highest,
--             growth,
--             g.growth_min,
--             g.growth_max,
--             g.growth_stddev,
            g.data_time,
            g.data_type,
            g.publish_status,
            g.publish_time,
            g.publisher_name,
            g.publisher,
            g.del_flag,
            r.china_name AS region_name,
            r.region_code AS region_code,
            ( SELECT data_name FROM init_dict WHERE init_dict.parent_id = 500 AND init_dict.dict_id = g.crop_id AND init_dict.data_status = '1' AND init_dict.del_flag = '1' ) AS crop_name,
            ( SELECT data_name FROM init_dict WHERE init_dict.parent_id = 4000 AND init_dict.dict_id = g.resolution AND init_dict.data_status = '1' AND init_dict.del_flag = '1' ) AS resolution_value
        FROM
            ds_growth g LEFT JOIN init_region r ON g.region_id = r.region_id
        WHERE
            g.data_status = '1' AND r.data_status = '1' AND g.del_flag = '1' AND r.del_flag = '1' AND g.publish_status = 2201
            <if test="regionId!=null and regionId!=''">
                AND (g.region_id = #{regionId,jdbcType=INTEGER} OR r.parent_id = #{regionId,jdbcType=INTEGER})
            </if>
            <if test="cropId!=null and cropId!=''">
                AND g.crop_id = #{cropId,jdbcType=INTEGER}
            </if>
            <if test="resolution!=null and resolution!=''">
                AND g.resolution = #{resolution,jdbcType=INTEGER}
            </if>
            <if test="startTime != null and startTime != '' and endTime != null and endTime != ''">
                and to_char(to_date(cast(g.data_time as varchar),'yyyy-mm-dd'), 'yyyy-mm-dd') BETWEEN cast(#{startTime} as VARCHAR) and cast(#{endTime} as VARCHAR)
            </if>
        ORDER BY g.region_id, g.crop_id, g.id
    </select>
    <update id="publish" parameterType="com.jh.data.model.DsGrowthParam" >
        update  ds_growth
        <set >
            <if test="publishStatus != null" > publish_status = #{publishStatus}, </if>
            publish_time  = now(),
            <if test="publisherName != null" > publisher_name = #{publisherName}, </if>
            <if test="publisher != null" > publisher = #{publisher}, </if>
        </set>
        where id in
        <foreach collection="idList" index="index" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="queryDateTimeList" resultMap="BaseResultMap" parameterType="com.jh.data.model.ReportCreateParam">
        SELECT DISTINCT data_time FROM ds_growth
        WHERE data_status = '1' AND del_flag = '1' AND publish_status = 2201
        <if test="regionId != null">
            AND region_id = #{regionId,jdbcType=INTEGER}
        </if>
        <if test="cropId != null">
            AND crop_id = #{cropId,jdbcType=INTEGER}
        </if>
        <if test="resolution != null">
            AND resolution = #{resolution,jdbcType=INTEGER}
        </if>
        ORDER BY data_time DESC
    </select>

    <!--根据任务ID删除数据集明细-->
    <delete id="deleteByProductId" parameterType="java.lang.Integer" >
        delete from ds_growth
        where product_id = #{producId,jdbcType=INTEGER}
    </delete>
</mapper>