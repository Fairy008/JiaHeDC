<!--发布明细 @version 2018-05-16 wl : Created.-->
<style type="text/css">
    .dropdown-menu ul {
        padding:0px 10px 0px 10px;
    }
    .dropdown-menu .scroll {
        overflow-y:auto;
        position:relative;
    }
    .dropdown-menu ul li {
        width:auto;
        text-align:left;
        height:32px;
        margin-top:6px;
        border-bottom:1px #ccc dashed;
    }
    .dropdown-menu ul li a {
        text-decoration:none;
        color:#666;
        float: left;
    }
    .dropdown-menu ul li input {
        width:14px;
        height:14px;
        display:inline-block;
        border:none;
        margin-right:5px;
        padding-left:0;
    }
    #dsId input{
        width: 14px !important;
        float: left;
    }
    /***选项卡样式***/
    .btLabelLeft span{background:#3FC7F7;color:#fff;display:block;width:135px;text-align:center;border-bottom:1px solid #fff;cursor:pointer;height: 28px; line-height: 28px;}
    .btLabelLeft .on{background:#00A7ED !important;border-bottom-right-radius: 15px;border-top-right-radius: 15px;width: 145px !important;}
    .btLabelTop{height: 28px;}
    .btLabelTop span{float: left;width: 12%; height: 28px; line-height: 28px;background:#3FC7F7;color:#fff;display:block;width:135px;text-align:center;border-right: 1px solid #fff;cursor:pointer;}
    .btLabelTop .on{background:#00A7ED !important;}
    .textareaStyle{width:94%;font-size:12px;border-radius:3px;border:1px solid #dfdfdf;resize:none;margin-top:4px;padding:4px;color:#000000}.outerDiv
</style>
<div class="content" style="height: 100%">
    <div class="searchItems">
        <div class="searchRow">
            <div class="searchBGleft" >
                <div>
                    <span class="label2">区域：</span>
                    <span><input id = "txtArea" class="input" type="text" placeholder="请选择区域" readonly/></span>
                </div>
                <div>
                    <span class="label2">作物：</span>
                    <span><select id = "search_cropId" class="input"></select></span>
                </div>
                <div>
                    <span class="label2">精度：</span>
                    <span><select id = "search_resolution" class="input"></select></span>
                </div>
                <div>
                    <span class="label2">数据时间：</span>
                    <span><input type="text" class="input" id="search_dataTime" readonly/></span>
                </div>
            </div>
            <div class="searchBGright">
                <input type="button" class="btn " value="查询" id="queryBtn" />&nbsp;&nbsp;
                <input type="button" class="btn " id="resetBtn" value="重置" />
            </div>
        </div>
        <div class="searchRow">
            <div class="searchBGleft" >
                <div>
                    <span class="label2">发布人：</span>
                    <span><input type="text" class="input" id="search_publisherName"/></span>
                </div>
                <div>
                    <span class="label2">发布状态：</span>
                    <span><select id = "search_publishStatus" name = "search_publishStatus" class="input"></select></span>
                </div>
            </div>

        </div>
    </div>

   <!-- <div class="contentBottom">
        <div class="gridRight">

        </div>
    </div>
-->
    <!--上面选项卡-->
   <!-- <div class="btLabelTop">
        <span class="on t1" target="gridData" tip="dataTip" data-id="1">数据</span>
        <span class="t2" target="gridLayer" tip="layerTip" data-id="2">图层</span>
        &lt;!&ndash;<span class="t2" target="gridThematic" tip="thematicTip" data-id="3">专题图</span>&ndash;&gt;
    </div>-->
    <div class="grid" id="grid">
        <table id="yieldGrid"></table>
        <div id="pager2"></div>
    </div>

        <div class="form" id="yieldInfo" style="display:none;">
            <table>
                <tr>
                    <td class="four_td1">区域:</td>
                    <td class="four_td2">
                        <input type="text" id="yieldRegionId" class="inputType" readonly style="background-color: rgb(245, 245, 245)"/>
                        <span id="view_yieldRegionId" class="viewType"></span>
                    </td>
                    <td class="four_td1">作物:</td>
                    <td class="four_td2" >
                        <input type="text" class="inputType" id="yieldCropId" readonly style="background-color: rgb(245, 245, 245)"/>
                        <span id="view_yieldCropId" class="viewType"></span>
                    </td>
                </tr>
                <tr>
                    <td class="four_td1">精度:</td>
                    <td class="four_td2">
                        <input type="text" class="inputType" id="yieldResolution" readonly style="background-color: rgb(245, 245, 245)"/>
                        <span id="view_yieldResolution" class="viewType"></span>
                    </td>
                    <td class="four_td1"><span class="txtRequired">*</span>估产(亩):</td>
                    <td class="four_td2" >
                        <input type="text" class="inputType" id="yield" />
                        <span id="view_yield" class="viewType"></span>
                    </td>
                </tr>

                <tr rows="5">
                    <td class="four_td1"><div class="justify">备注:<span class='p'></span></div></td>
                    <td colspan="3">
                        <textarea class="textareaStyle"  id = "yieldRemark" cols="30" rows="5"></textarea>
                        <span id="view_yieldRemark" class="viewType"></span>
                    </td>
                </tr>
            </table>
        </div>
        <div id="delDialog" class="dialogStyle"></div>
        <div id="showDialog" class="dialogStyle" style="display:none">
        </div>
    </div>
    <script type="text/javascript">

        require(["jquery","jqGrid","jqueryUi","dateUtil","BaseAjax","ztree","formVerfication","RegionModule","PopWin","commons","custom_settings"],function($,jqGrid,jqueryUi,dateUtil, BaseAjax, ztree,formVerfication,RegionModule,PopWin,commons,custom_settings){
            var dataSet = 1801;//设置默认初始化数据集:1801表示分布,
            var tabSet = 1;//设置默认初始化值:1表示数据,2表示图层,3表示专题图

            var init = function(){
                dateFun();//初始化日期控件
                RegionSelectFun("txtArea","search_cropId");//加载区域
                initResolutionFun(4000);
                //initDataSetFun(1800);//初始化数据集下拉框
                commons.findDictList(1800,"dataSet");
                // initCropIdFun(500);//初始化作物下拉框
                //initPublishStatusFun(2200);//初始化发布状态的下拉框
                commons.findDictList(2200,"search_publishStatus",2202);//初始化发布状态的下拉框,默认未发布
                $("#resetBtn").on("click",resetFun);
                $("#queryBtn").on("click",searchFun);
              //  $("#search_publishStatus").on("change",searchFun);
                titleRightSelectFun();//右边选项卡切换

                loaderGrid(dataSet, tabSet);//加载gird

                //点击事件控件 关闭区域控件
                $("#search_dataTime").on("click",function(){
                    if($("#divArea").css("display")== "block"){
                        $("#divArea").css("display","none")
                    }
                })

                $(window).resize(function(){
                    $("#yieldGrid").setGridWidth($(".rightMain").width() - 30);
                    chanageTableCss();
                });
                chanageTableCss();
                //setwidth();
            }

            var chanageTableCss = function(){
                var divObj = $('#yieldGrid').parent('div');
                divObj.addClass('tableStyle');
                divObj.css({'maxHeight':($(".rightMain").height()-$(".searchItems").height()-$(".ui-jqgrid-hdiv").height())-$("#pager2").height()-50+"px"});
            }

            /**
             * 加载gird
             * var1: 数据集
             * var2: table页签
             * @version<1> 2018-05-17 wl :created.
             */
            var loaderGrid = function(var1, var2){
                var txtArea = document.getElementById("txtArea");
                var areaId = txtArea.getAttribute("regionId");
                var areaCode = txtArea.getAttribute("regioncode");
                $("#yieldGrid").jqGrid({
                    url: getGridUrl(var1, var2),
                    datatype: "json",
                    postData:{
                        dataSet: var1,
                        //regionId: areaId,//区域id
                        regionCode:areaCode,//区域code
                        cropId: $("#search_cropId").val(),//作物
                        resolution: $("#search_resolution").val(),//分辨率
                        creator:$("#search_creator").val(),//创建人
                        publisherName:$("#search_publisherName").val(),//发布人
                        publishStatus:$("#search_publishStatus").val(),//发布状态
                        startTime: (($("#search_dataTime").val().trim()).split('至')) [0],
                        endTime: (($("#search_dataTime").val().trim()).split('至')) [1]
                    },
                    mtype:'POST',
                    jsonReader: {
                        root: "list",
                        total: "pages",
                        page: "page",
                        records: "total",
                        repeatitems: false
                    },
                    rownumbers: true,
                    multiselect: false,//复选框
                    colNames: getGridColNames(var1, var2),
                    colModel: getGridColModel(var1, var2),
                    width:'100%',
                    autowidth:true,
                    height:'100%',
                    rowNum:15,
                    rowList:[15,30],
                    pager: '#pager2',
                    viewrecords: true,
                    loadComplete:function(){
                        commons.isNextDisable();
                        $("#yieldGrid").setGridWidth($(".rightMain").width() - 30);
                        //$("#pager2_left").html('<input type="button" value="批量发布" id="publishBtn" class="btn btn_grey" />&nbsp;&nbsp;&nbsp;<input type="button" value="批量撤回" id="cancelBtn" class="btn btn_grey"  />');
                        tableEvent();
                    },
                    onSelectAll:function(rowid, status) { //rowid 数组
                        btnStyle();
                    },
                    onSelectRow:function(rowid, e){
                        btnStyle();
                    }
                });
            };

            /**
             * Description: 批量按钮样式
             * @version <1> 2018-6-11 wangli: Created.
             */
            var btnStyle = function(){
                var ids = $("#yieldGrid").jqGrid("getGridParam", "selarrrow");
                var rowNum = $("#yieldGrid").jqGrid('getRowData').length; //获取当前页显示的行数
                if(ids.length == rowNum){//全选
                    $("input[type='checkbox']").prop("checked",true);
                }
                var ids2201 = [];
                var ids2202 = [];
                //遍历这个集合,存放reportId
                $(ids).each(function (index, id){
                    //由id获得对应数据行
                    var row = $("#yieldGrid").jqGrid('getRowData', id);

                    var areaId = row.id;//
                    var publishStatus = row.publishStatus;//获取发布状态
                    if(publishStatus == 2201){//如果此条报告信息的发布状态为已发布2201
                        ids2201.push(areaId)
                    }else if(publishStatus == 2202){
                        ids2202.push(areaId)
                    }
                });
                if(ids.length == 0){
                    $("#publishBtn").addClass("btn_grey");
                    $("#cancelBtn").addClass("btn_grey");
                }else if(ids2201.length > 0 && ids2202.length <= 0){
                    $("#publishBtn").addClass("btn_grey");
                    $("#cancelBtn").removeClass("btn_grey");
                }else if(ids2202.length > 0 && ids2201.length <= 0){
                    $("#publishBtn").removeClass("btn_grey");
                    $("#cancelBtn").addClass("btn_grey");
                }else if(ids2201.length > 0 && ids2202.length > 0){
                    $("#publishBtn").removeClass("btn_grey");
                    $("#cancelBtn").removeClass("btn_grey");
                }
            };

            /**
             * 绑定table表格操作事件
             * @version <1> 2018-05-17 wl : Created.
             */
            var tableEvent = function(){
                $(".editBtn,.seeBtn,.delBtn,.publishBtn,.cancelBtn,.statusBtn,#publishBtn,#cancelBtn").off("click");
                $(".editBtn").on("click",function(){//编辑
                    editDsYieldFun($(this).attr("data-id"))
                })

                $(".seeBtn").on("click",function(){
                    showFun($(this).attr("data-id"))
                })

                $(".delBtn").on("click",function(){//删除
                    deleteFun($(this).attr("data-id"))
                })

                $(".publishBtn").on("click", function () {//单个发布
                    detailPublishById($(this).attr("data-id"));
                });

                $(".cancelBtn").on("click", function () {//单个撤销
                    detailCancelById($(this).attr("data-id"));
                });

                $(".statusBtn").on("click",function () {
                    var reporterId = $(this).attr("data-id");//
                    var audisState = $(this).attr("data-status");
                    var ids = [];
                    ids.push(reporterId);
                    statusFun(ids,audisState);
                });//发布状态

                /*if(!$(this).hasClass("btn_grey")){
                    $("#publishBtn").on("click",detailPublish);//发布数据集明细
                    $("#cancelBtn").on("click",detailCancel);//撤销发布信息
                }*/
                $("#publishBtn").on("click",function(){//发布数据集明细
                    if(!$(this).hasClass("btn_grey")){
                        detailPublish();
                    }
                });

                $("#cancelBtn").on("click",function(){//撤销发布信息
                    if(!$(this).hasClass("btn_grey")){
                        detailCancel();
                    }
                });

            }

            /**
             * 查看详情
             * @param id
             * @version <1> 2018-6-14 wl : created.
             */
            var showFun = function(id){
                var ajax = new BaseAjax();
                ajax.opts.url = DS_YIELD.getById_url + "?id=" + id;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false; //同步请求
                ajax.opts.successFun = function(result){
                    //$("#view_regionId").attr('title',permPerson.email);
                    $("#view_yieldRegionId").html(result.data.regionName == null ? "" :result.data.regionName );
                    $("#view_yieldCropId").html(result.data.cropName == null ? "" : result.data.cropName );
                    $("#view_yield").text(result.data.yield == null ? "" : result.data.yield );
                    $("#view_yieldResolution").text(result.data.resolutionValue == null ? "" : result.data.resolutionValue);
                    $("#view_yieldRemark").text(result.data.remark == null ? "" : result.data.remark);
                    if(result.data.remark!=null){
                        $("#view_yieldRemark").attr('title',result.data.remark);
                    }
                    // $("#view_resolution").html(permPerson.dataStatus == '1' ? "正常" : "禁用");
                    showDialog(id,3,"估产明细信息");
                };
                ajax.run();
            };

            /**
             * 隐藏input输入框，显示信息查看
             */
            var viewTypeShow = function(){
                $(".txtRequired").hide();
                $(".inputType2,.inputType,.label,.selectType,.textareaStyle").css("display","none");
                $(".viewType,.viewType2").css("display","block");
            }

            /**
             * 显示input输入框，隐藏信息查看
             */
            var inputTypeShow = function(){
                $(".txtRequired").show();
                $(".viewType,.viewType2").css("display","none");
                $(".inputType2,.inputType,.label,.selectType,.textareaStyle").css("display","block");
            };


            /**
             * 更新启用或禁用状态
             *
             * @version <1> 2018-06-11 wangli： Created
             */
            var statusFun = function(ids,audisState) {
                var detailPublishParam = {};//参数
                detailPublishParam.dataSet = dataSet;//单个数据集
                detailPublishParam.publishStatus=audisState;
                detailPublishParam.idList=ids;
                var ajax = new BaseAjax();
                switch(tabSet){
                    case 1://分布
                    case "1":
                        ajax.opts.url = DS_YIELD.publish_url;
                        break;
                    case 2://估产
                    case "2":
                        ajax.opts.url = DS_LAYER.publish_url;
                        break;
                    case 3://长势
                    case "3":
                        break;
                }

                ajax.opts.data = JSON.stringify(detailPublishParam);
                ajax.opts.successFun = function(data){
                    if(data.flag){
                        $("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                        loaderGrid(dataSet, tabSet);
                        if(audisState==2201){
                            PopWin.showMessageWin("发布成功");
                        }else{
                            PopWin.showMessageWin("撤回成功");
                        }
                    }else{
                        PopWin.showMessageWin(data.msg);
                    }
                };
                ajax.opts.failureFun = function(){

                }
                ajax.run();
            }

            /**
             * 删除估产明细
             * @version <1> 2018-06-07 wl: created.
             */
            var deleteFun= function(id){
                var delDialog = $("#delDialog");
                delDialog.html("是否确认删除所选记录？");
                delDialog.dialog({
                    autoOpen: false,
                    title:'系统提示',
                    height: 160,
                    width: 410,
                    modal: true,
                    buttons:[{
                        text:"是",
                        click:function(){
                            var ajax = new BaseAjax();
                            ajax.opts.url = DS_YIELD.del_url + "?id=" + id;
                            ajax.opts.contentType = "application/json";
                            ajax.opts.successFun=function(result){
                                if(result.flag){
                                    $("#yieldGrid").trigger("reloadGrid");
                                    delDialog.dialog("close");
                                    PopWin.showMessageWin("记录行删除成功");
                                }else{
                                    PopWin.showMessageWin("记录行删除失败");
                                }
                            };
                            ajax.opts.errorFun = function(){
                                PopWin.showMessageWin("记录行删除失败");
                            };
                            ajax.run();
                        }},{
                        text:"否",
                        click:function(){
                            $(this).dialog("close");
                        }
                    }]
                });
                delDialog.dialog("open");
            };

            /**
             * 修改估产明细
             * @version <1> 2018-05-11 wl: created.
             */
            var editDsYieldFun = function(id){
                var ajax = new BaseAjax();
                ajax.opts.url = DS_YIELD.getById_url + "?id=" + id;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false; //同步请求
                ajax.opts.successFun = function(result){
                    var regionId = document.getElementById("regionId");

                    $("#yield").val(result.data.yield);
                    $("#yieldResolution").val(result.data.resolutionValue);
                    $("#yieldCropId").val(result.data.cropName);
                    $("#yieldRegionId").val(result.data.regionName);
                    $("#yieldRemark").val(result.data.remark);
                    showDialog(id,2,"估产明细信息");
                };
                ajax.run();
            };



            /**
             * 弹出框
             * @param type  : 编辑
             * @version <1> 2018-05-09 wl: created.
             */
            var showDialog = function(id,type,title){
                var Dialog =  $("#yieldInfo");
                var dialogParent = Dialog.parent();
                var dialogOwn = Dialog.clone();
                if(type==3){
                    viewTypeShow();
                    Dialog.dialog({
                        autoOpen: false,
                        title:title,
                        height: 240,
                        width: 550,
                        modal: true,
                        close:function(){
                            dialogOwn.appendTo(dialogParent);
                            $(this).dialog("destroy").remove();
                        },
                        buttons:[{
                            text:"关闭",
                            click:function(){
                                $(this).dialog("close");
                            }
                        }]
                    });
                }else{
                    inputTypeShow();
                    Dialog.dialog({
                        autoOpen: false,
                        title:title,
                        height: 330,
                        width: 550,
                        modal: true,
                        close:function(){
                            dialogOwn.appendTo(dialogParent);
                            $(this).dialog("destroy").remove();
                        },
                        buttons:[
                            {
                                text: "保存",
                                click: function () {
                                    editYieldSaveFun(Dialog,id);
                                }
                            },{
                                text: "取消",
                                click: function () {
                                    $(this).dialog("close");
                                }
                            }
                        ]
                    });
                }


                Dialog.dialog("open");
            };

            var formVerf = function(){//分布验证
                var yieldInfo = $('#yieldInfo');
                if(formVerfication.checkDsInputLength(1,20,$('#yield'),yieldInfo,'面积字符数不能超过20位','面积整数值不能超过18位')){
                    return false;
                }
                if(formVerfication.checkInputIsNumber($('#yield'),yieldInfo,'面积只能输入正整数')){
                    return false;
                }
                return true;
            }

            /**
             * 修改估产信息保存
             * @param dsYieldDialog
             */
            var editYieldSaveFun = function(yieldDialog, id ){
                if(!formVerf()){
                 return ;
                 }
                var dsYield = {};

                dsYield.yield=$("#yield").val().trim();
                dsYield.remark=$("#yieldRemark").val().trim();
                dsYield.id = id;
                var ajax = new BaseAjax();
                ajax.opts.url = DS_YIELD.edit_url;
                ajax.opts.contentType = "application/json";
                ajax.opts.data = JSON.stringify(dsYield);
                ajax.opts.successFun = function(result){
                    if(result.flag){
                        yieldDialog.dialog("close");

                        $("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                        loaderGrid(dataSet,tabSet);//加载gird

                        PopWin.showMessageWin("修改成功");
                    }else{
                        PopWin.showMessageWin("修改失败，没有符合条件的数据");
                    }
                };
                ajax.opts.errorFun = function (result) {
                    PopWin.showMessageWin("修改失败");
                };
                ajax.run();
            };


            /**
             * 设置grid url属性
             * var1: 数据集
             * var2: table页签
             * @version<1> 2018-05-09 zhangshen :created.
             */
            var getGridUrl = function(var1, var2){
                var url = "";
                if(var2 == 1){//估产-----数据
                    url = DS_YIELD.findByPage_url;
                }else if(var2 == 2){//估产-----图层
                    url = DS_LAYER.findByPage_url;
                }else if(var2 == 3){//估产-----专题图
                    url = "";
                }
                return url;
            };

            /**
             * 设置grid colNames属性
             * var1: 数据集
             * var2: table页签
             * @version<1> 2018-05-09 zhangshen :created.
             */
            var getGridColNames = function(var1, var2){
                var colNames = [];
                if( var2 == 1){//估产-----数据
                    colNames = ['ID', '区域', '区域编码', '作物', '精度', '数据时间', '产量（吨）','发布人', '发布时间','发布状态id', '发布状态'];
                }else if(var2 == 2){//估产-----图层
                    colNames = ['ID', '区域', '区域编码', '作物', '精度', '数据时间', '文件', '图层地址','发布人', '发布时间','发布状态id', '发布状态','操作'];
                }else if( var2 == 3){//专题图
                    colNames = ['ID', '区域', '区域编码', '精度', '数据时间', '文件', '地址','操作'];
                }
                return colNames;
            };

            /**
             * 设置grid colModel属性
             * var1: 数据集
             * var2: table页签
             * @version<1> 2018-05-09 zhangshen :created.
             */
            var getGridColModel = function(var1, var2){
                var colModel = [];
                if(var2 == 1){//估产-----数据
                    colModel = [
                        {name:'id',index:'id', align:'center',hidden:true},
                        {name:'regionName',index:'region_name', align:'center', width:'15%'},
                        {name:'regionCode',index:'regionCode', align:'center',hidden:true},
                        {name:'cropName',index:'crop_name', align:'center', width:'15%'},
                        {name:'resolutionValue',index:'resolution_value', align:'center', width:'15%'},
                        {name:'dataTime',index:'data_time', align:'center', width:'10%'},
                        {name:'yield',index:'yield', align:'right', width:'10%'},
                        {name:'publisherName',index:'publisher_name', align:'center', width:'10%',formatter:function (cellvalue,options,rowObject) {
                            var str="";
                            if(rowObject.publishStatus == 2201){
                                str=cellvalue == null ? "" : cellvalue;
                            }
                            return str;
                        }},
                        {name:'publishTime',index:'publish_time', align:'center', width:'10%',formatter:function (cellvalue,options,rowObject) {
                            var str="";
                            if(rowObject.publishStatus == 2201){
                                str=cellvalue == null ? "" : cellvalue.substring(0,10);
                            }
                            return str;
                        }},
                        {name: 'publishStatus', index:'publish_status', hidden:true},
                        {name:'publishStatusName',index:'publish_status_name', align:'center', width:'5%',formatter:function (cellvalue,options,rowObject) {
                            var str = "";
                            if (rowObject.publishStatus == 2201) {
                                str += "<span class='statusStyle'>已发布</span>"
                                        //<img src='images/public/Ton.png' class='statusBtn' data-id='" + rowObject.id + "' data-status='2202' title='已发布' >";
                            } else {
                                str += "<span class='statusStyle'>待发布</span>"//<img src='images/public/Toff.png' class='statusBtn' data-id='" + rowObject.id + "' data-status='2201' title='待发布' >";
                            }
                            return str;
                        }},
                        /*{name:'cz',index:'cz', width:'5%',align:"center", sortable:false,formatter:function(cellvalue, options, rowObject){
                            var str="";
                            if(rowObject.publishStatus==2201){//已经发布的数据不可修改  只能撤销
                                str+= //"<img src='images/public/TeditG.png' title='编辑' >" +
                                        "<img src='images/public/Twatch.png' class='seeBtn' data-id='"+ rowObject.id +"' title='查看' >"
                                        //"<img src='images/public/TdeleteG.png'  title='删除' >";
                            }else {
                                str+= //"<img src='images/public/Tedit.png'  class='editBtn' data-id='" + rowObject.id + "'   title='编辑' >" +
                                        "<img src='images/public/Twatch.png' class='seeBtn' data-id='"+ rowObject.id +"' title='查看' >"
                                        //"<img src='images/public/Tdelete.png' class='delBtn'  data-id='" + rowObject.id + "'  title='删除' >";
                            }
                            return str;
                        }}*/
                    ];
                } else if(var2 == 2){//估产-----图层
                    colModel = [
                        {name:'id',index:'id', align:'left', width:'5%',hidden:true},
                        {name:'regionName',index:'regionName', align:'center', width:'8%'},
                        {name:'regionCode',index:'regionCode', align:'center', width:'8%',hidden:true},
                        {name:'cropName',index:'cropName', align:'center', width:'8%'},
                        {name:'resolutionValue',index:'resolution_value', align:'center', width:'8%'},
                        {name:'dataTime',index:'dataTime', align:'center', width:'8%'},
                        {name:'typeName',index:'typeName', align:'center', width:'5%'},
                        {name:'url',index:'url', align:'center', width:'10%'},
                        {name:'publishStatusName',index:'publishStatusName', align:'center', width:'5%'},
                        {name:'publishTime',index:'publish_time', align:'center', width:'5%'},
                        {name:'publisherName',index:'publisherName', align:'center', width:'5%'},
                        {name:'cz',index:'cz', width:'20%',align:"center", hidden:true,sortable:false,formatter:function(cellvalue, options, rowObject){
                            var str="";
                            if(rowObject.publishStatus==2201){//已经发布的数据不可修改  只能撤销
                                str+= "<img src='images/public/shareG.png' title='发布' >"+
                                        "<img src='images/public/back.png' class='cancelBtn'  data-id='" + rowObject.id + "'  title='撤销' >";
                            }else {
                                str+= "<img src='images/public/share.png'  class='publishBtn' data-id='" + rowObject.id + "'   title='发布' >"+
                                        "<img src='images/public/backG.png'  title='撤销' >";
                            }
                            return str;
                        }}
                    ];
                }else if(var2 == 3){//估产-----图层
                    colModel = [
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'fileName',index:'fileName', align:'left', width:'5%'},
                        {name:'cz',index:'cz', width:'10%',align:"center", sortable:false,formatter:function(cellvalue, options, rowObject){
                            var str="";
                            if(rowObject.publishStatus==2201){//已经发布的数据不可修改  只能撤销
                                str+= "<img src='images/public/shareG.png' title='发布' >" +
                                        "<img src='images/public/back.png' class='cancelBtn'  data-id='" + rowObject.id + "'  title='撤销' >";
                            }else {
                                str+= "<img src='images/public/share.png'  class='publishBtn' data-id='" + rowObject.id + "'   title='发布' >" +
                                        "<img src='images/public/backG.png'  title='撤销' >";
                            }
                            return str;
                        }}
                    ];
                }
                return colModel;
            };

            /**
             * 查询
             * @version<1> 2018-05-18 wl :created.
             */
            var searchFun = function(){
                /*$("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                loaderGrid(dataSet, tabSet);//加载gird*/
                var txtArea = document.getElementById("txtArea");
                var areaId = txtArea.getAttribute("regionId");
                var areaCode = txtArea.getAttribute("regioncode");
                $("#yieldGrid").jqGrid('setGridParam', {
                    datatype: 'json',
                    postData: {
                        dataSet: dataSet,
                        //regionId: areaId,//区域id
                        regionCode:areaCode,//区域code
                        cropId: $("#search_cropId").val(),//作物
                        resolution: $("#search_resolution").val(),//分辨率
                        creator:$("#search_creator").val(),//创建人
                        publisherName:$("#search_publisherName").val(),//发布人
                        publishStatus:$("#search_publishStatus").val(),//发布状态
                        startTime: (($("#search_dataTime").val().trim()).split('至')) [0],
                        endTime: (($("#search_dataTime").val().trim()).split('至')) [1]
                    },
                    page: 1
                }).trigger("reloadGrid");
            }

            /**
             * 重置
             * @version<1> 2018-05-03 lcw :created.
             */
            var resetFun = function(){
                $(".searchItems .input").val("");
                //$("#txtArea").removeAttr("regionid");
                $("#txtArea").val(custom_settings.main_search_region_name).attr("regionid", custom_settings.main_search_region_id).attr("regioncode", custom_settings.main_search_region_code);
                queryCropFun(document.getElementById("txtArea").getAttribute("regionid"), "search_cropId");
                $("#search_publishStatus option[value='2202']").attr("selected","selected");
            }

            /**
             * 初始化日期控件
             * @version<1> 2018-05-18 wl :Created.
             */
            var dateFun = function(){
                $("#search_dataTime").jeDate({
                    //isinitVal:true,
                    multiPane:false,
                    //minDate:getNowFormatDate(),
                    //maxDate:$.nowDate({DD:"0"}),
                    isToday:false,
                    format: 'YYYY-MM-DD',
                    range:"至"
                });
            };

            var getNowFormatDate= function() {
                var date = new Date();
                var seperator1 = "-";
                var year = date.getFullYear()-1;
                var month = date.getMonth() + 1;
                var strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                var currentdate = year + seperator1 + month + seperator1 + strDate;
                return currentdate;
            }

            /**
             * 区域选择控件
             * @version<1> 2018-05-03 lcw :Created.
             */
            /**
             * 区域选择控件
             * @param regionIdName 区域ID
             * *@param cropIdName 作物ID
             * @version <1> 2018-4-17 cxw : created.
             */
            var RegionSelectFun = function(regionIdName,cropIdName){
                var txtArea = document.getElementById(regionIdName);
                txtArea.value = custom_settings.main_search_region_name;
                txtArea.setAttribute("regionid", custom_settings.main_search_region_id);
                txtArea.setAttribute("regioncode", custom_settings.main_search_region_code);
                txtArea.onclick = function(){
                    var opts = {colNum:3,width:400,url:REGION_CONFIG.findRegion_url,closeFun:function(){
                        var regionId = txtArea.getAttribute("regionId");
                        if(regionId!=null)
                        {
                            queryCropFun(regionId,cropIdName)
                        }
                        else{
                            $('#'+cropIdName).html('<option value="">--请选择--</option>');
                        }
                    }};
                    var regionSelector = new RegionModule.RegionSelector(regionIdName,opts);
                    regionSelector.show();
                }
                queryCropFun(txtArea.getAttribute("regionid"), cropIdName);
            }

            //区域缓存
            var cropCache = [];
            /**
             * 通过区域获取作物
             * @version<1> 2018-05-03 lcw :Created.
             */
            var queryCropFun = function(regionId,cropIdName){
                var ajax = new BaseAjax();
                ajax.opts.url = CROP_CONFIG.queryCropListByRegionId_url+"?regionId="+regionId;
                ajax.opts.contentType = "application/json";
                ajax.opts.successFun = function (data) {
                    var crop = data.data;
                    // cropCache = crop;
                    initCropFun(crop,cropIdName);
                };
                ajax.run();

            }

            /**
             * 初始化作物下拉框
             * @param crop 查询出的作物对象集合
             * @version<1> 2018-05-03 lcw :Created.
             */
            var initCropFun = function(crop,cropIdName){
                var result;
                result = '<option value="">--请选择--</option>';
                if(crop!=null)
                {
                    $.each(crop,function(i,o){
                        result += '<option value = "' + o.cropId + '">' + o.cropName + '</option>';
                    });
                }
                $('#'+cropIdName).html(result);
            };


            /**
             * 右边选项卡切换
             * @version<1> 2018-05-14 wl :Created.
             */
            var titleRightSelectFun = function(){
                $(".btLabelTop span").on("click", function(){
                    $(this).addClass("on");
                    $(this).siblings().removeClass("on");
                    tabSet = $(this).attr("data-id");
                    $("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                    loaderGrid(dataSet, tabSet);
                })
            };

            /**
             * 批量发布明细
             * @version<1> 2018-05-14 wl :Created.
             */
            var detailPublish = function(){
                var ajax = new BaseAjax();
                var detailPublishParam = {};//参数
                detailPublishParam.dataSet = dataSet;//单个数据集
                detailPublishParam.publishStatus=2201;
                var ids = $("#yieldGrid").jqGrid("getGridParam", "selarrrow");
                detailPublishParam.idList= ids;//批量发布id
                if(tabSet==1){
                    ajax.opts.url = DS_YIELD.publish_url;
                }else{
                    ajax.opts.url = DS_LAYER.publish_url;
                }

                ajax.opts.data = JSON.stringify(detailPublishParam);
                ajax.opts.successFun = function(data){
                    if(data.flag){
                        $("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                        loaderGrid(dataSet, tabSet);
                        PopWin.showMessageWin("发布成功");
                    }else{
                        PopWin.showMessageWin(data.msg);
                    }
                };
                ajax.opts.failureFun = function(){

                }
                ajax.run();

            };

            /**
             * 单条明细发布
             * @version<1> 2018-05-14 wl :Created.
             */
            var detailPublishById = function(id){
                var detailPublishParam = {};//参数
                detailPublishParam.dataSet = dataSet;//单个数据集
                detailPublishParam.publishStatus=2201;
                var idList=[];
                idList.push(id);
                detailPublishParam.idList=idList;
                var ajax = new BaseAjax();
                switch(tabSet){
                    case 1://分布
                    case "1":
                        ajax.opts.url = DS_YIELD.publish_url;
                        break;
                    case 2://估产
                    case "2":
                        ajax.opts.url = DS_LAYER.publish_url;
                        break;
                    case 3://长势
                    case "3":
                        break;
                }

                ajax.opts.data = JSON.stringify(detailPublishParam);
                ajax.opts.successFun = function(data){
                    if(data.flag){
                        $("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                        loaderGrid(dataSet, tabSet);
                        PopWin.showMessageWin("发布成功");
                    }else{
                        PopWin.showMessageWin(data.msg);
                    }
                };
                ajax.opts.failureFun = function(){

                }
                ajax.run();

            };

            /**
             * 撤销发布
             * @version<1> 2018-05-14 wl :Created.
             */
            var detailCancel = function(){
                var ajax = new BaseAjax();
                var detailPublishParam = {};//参数
                detailPublishParam.dataSet = dataSet;//单个数据集
                detailPublishParam.publishStatus=2202;
                var ids = $("#yieldGrid").jqGrid("getGridParam", "selarrrow");
                detailPublishParam.idList= ids;//批量发布id
                switch(tabSet){
                    case 1://分布
                    case "1":
                        ajax.opts.url = DS_YIELD.publish_url;
                        break;
                    case 2://估产
                    case "2":
                        ajax.opts.url = DS_LAYER.publish_url;
                        break;
                    case 3://长势
                    case "3":
                        break;
                }
                ajax.opts.data = JSON.stringify(detailPublishParam);
                ajax.opts.successFun = function(data){
                    if(data.flag){
                        $("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                        loaderGrid(dataSet, tabSet);
                        PopWin.showMessageWin("撤回成功");
                    }else{
                        PopWin.showMessageWin(data.msg);
                    }
                };
                ajax.opts.failureFun = function(){

                }
                ajax.run();

            };


            /**
             * 单条明细撤销
             * @version<1> 2018-05-18 wl :Created.
             */
            var detailCancelById = function(id){
                var detailPublishParam = {};//生成报告参数
                detailPublishParam.dataSet = dataSet;//单个数据集
                detailPublishParam.publishStatus=2202;
                var idList=[];
                idList.push(id);
                detailPublishParam.idList=idList;
                var ajax = new BaseAjax();
                switch(tabSet){
                    case 1://分布
                    case "1":
                        ajax.opts.url = DS_YIELD.publish_url;
                        break;
                    case 2://估产
                    case "2":
                        ajax.opts.url = DS_LAYER.publish_url;
                        break;
                    case 3://长势
                    case "3":
                        break;
                }

                ajax.opts.data = JSON.stringify(detailPublishParam);
                ajax.opts.successFun = function(data){
                    if(data.flag){
                        $("#grid").html('<table id="yieldGrid"></table><div id="pager2"></div>');
                        loaderGrid(dataSet, tabSet);
                        PopWin.showMessageWin("撤回成功");
                    }else{
                        PopWin.showMessageWin(data.msg);
                    }
                };
                ajax.opts.failureFun = function(){

                }
                ajax.run();

            };

            var dataSetCache=[];
            /**
             * 获取数据集下拉框数据
             * @param parentId = 1800
             * @version <1> 2018-05-09 wl: created.
             */
            var initDataSetFun = function(parentId){
                var ajax = new BaseAjax();
                ajax.opts.url = DICT_COFING.queryDictByParentId_url;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false;
                ajax.opts.data = JSON.stringify({'parentId' : parentId});

                ajax.opts.successFun = function(result){
                    var str = "";
                    if(result.flag){
                        dataSetCache = result.data;
                      /*  $.each(result.data, function(index, element){
                            str += "<option value='"+ element.dictId+"'>"+ element.dataName +"</option>";
                        })
                        $("#dataSet").append(str);
                        $("#search_dataSet").append(str);*/
                    }
                }
                ajax.run();
            }


            //作物缓存
            var cropIdCache=[];
            /**
             * 获取作物下拉框数据
             * @param parentId = 500
             * @version <1> 2018-05-09 wl: created.
             */
            var initCropIdFun=function (parentId) {
                var ajax = new BaseAjax();
                ajax.opts.url = DICT_COFING.queryDictByParentId_url;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false;
                ajax.opts.data = JSON.stringify({'parentId' : parentId});

                ajax.opts.successFun = function(result){
                    var str = "<option value=''>--请选择--</option>";
                    if(result.flag){
                        cropIdCache = result.data;
                        $.each(result.data, function(index, element){
                            str += "<option value='"+ element.dictId+"'>"+ element.dataName +"</option>";
                        })
                        /*  $("#cropId").append(str);
                         $("#growthCropId").append(str);*/
                        $("#search_cropId").append(str);
                    }
                }
                ajax.run();
            }


            //分辨率缓存
            var resolutionCache = [];

            /**
             * 获取分辨率下拉框数据
             * @param parentId = 4000
             * @version <1> 2018-05-09 wl: created.
             */
            var initResolutionFun = function(parentId){
                var ajax = new BaseAjax();
                ajax.opts.url = DICT_COFING.queryDictByParentId_url;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false;
                ajax.opts.data = JSON.stringify({'parentId' : parentId});

                ajax.opts.successFun = function(result){
                    var str = "<option value=''>--请选择--</option>";
                    if(result.flag){
                        resolutionCache = result.data;
                        $.each(result.data, function(index, element){
                            str += "<option value='"+ element.dictId+"'>"+ element.dataName +"</option>";
                        })
                        $("#search_resolution").append(str);
                    }
                }
                ajax.run();
            }

            var publishStatusCache=[];
            /**
             * 获取发布状态下拉框数据
             * @version <1> 2018-05-21 wl: created.
             */
            var initPublishStatusFun = function(parentId){
                var ajax = new BaseAjax();
                ajax.opts.url = DICT_COFING.queryDictByParentId_url;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false;
                ajax.opts.data = JSON.stringify({'parentId' : parentId});
                ajax.opts.successFun = function(result){
                    var str = "<option value=''>--请选择--</option>";
                    if(result.flag){
                        publishStatusCache = result.data;
                        $.each(result.data, function(index, element){
                            str += "<option value='"+ element.dictId+"'>"+ element.dataName +"</option>";

                        })
                        $("#search_publishStatus").append(str);
                        $("#search_publishStatus option[value='2202']").attr("selected","selected");
                    }
                }
                ajax.run();
            }

            // 遍历jqgrid 使其序号列宽度为45
            var setwidth = function() {
                $("table[role='grid']").each(function () {//jqgrid 创建的表格都有role属性为grid
                    $('.' + $(this).attr("class") + ' tr:first th:first').css("width", "36"); //使表头的序号列宽度为40
                    $('.' + $(this).attr("class") + ' tr:first td:first').css("width", "36"); // 使表体的序号列宽度为40
                });
            }


            init();

        })
    </script>