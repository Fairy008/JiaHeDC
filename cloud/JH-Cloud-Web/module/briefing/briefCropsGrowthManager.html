<style>
    .timeRang{
        float: left;
    }
    table.dataintable {
        margin-top:15px;
        border-collapse:collapse;
        border:1px solid #efefef;
        width:100%;
    }
    table.dataintable th {
        vertical-align:baseline;
        background-color:#1f4350;
        border:1px solid #efefef;
        text-align:left;
        color:#fff;
        font-style: normal;
        line-height: 27px;
    }
    table.dataintable td {
        vertical-align:text-top;
    }
    table.dataintable tr:nth-child(odd) {
        background-color:#F5F5F5;
    }
    table.dataintable tr:nth-child(even) {
        background-color:#fff;
    }
    .diseaseName{
        padding: 0px 5px;
        width: 94% !important;
        margin-left: 5px;
    }
    .diseaseMeasure{
        padding: 0px 5px;
        width: 96% !important;
        margin-left: 5px;
    }
    .instruction{
        padding: 0px 5px;
        margin-left: 5px;
        width: 95% !important;
    }
    .tempRange{
        padding: 0px 5px;
        margin-left: 5px;
    }
</style>
<div class="content">
    <div class="searchItems">
        <div class="searchRow">
            <div class="searchBGleft" >
                <div>
                    <span class="label">作物：</span>
                    <span><select id = "search_cropId" class="input"></select></span>
                </div>
                <div>
                    <span class="label">生育期名称：</span>
                    <span><input id="search_growthName" type="text" class="input" /></span>
                </div>
            </div>
            <div class="searchBGright">
                <input type="button" class="btn " value="查询" id="queryBtn" />
                <input type="button" class="btn " id="resetBtn" value="重置" />
                <input name="Input" type="button" class="btn " id="addBtn" value="新增" />
            </div>
        </div>
    </div>
    <div class="grid">
        <table id="cropsGrowthManagerGrid"></table>
        <div id="pager2"></div>
    </div>

    <div id="dataTypeInfo" class="form" style="display: none;">
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle">
            <span id="ui-id-1" class="ui-dialog-title">作物生育期配置</span>
        </div>
        <div>
            <table>
                <tr>
                    <td class="four_td1"><span class="txtRequired">*</span>作物:</td>
                    <td class="four_td2">
                        <select id = "cropsId" name="cropsId" class="selectType two_selectType"></select>
                    </td>
                    <td class="four_td1"><span class="txtRequired">*</span>生育期名称:</td>
                    <td class="four_td2">
                        <input name="growthName" id="growthName" class="inputType" type="text" />
                    </td>
                </tr>
                <tr>
                    <td class="four_td1"><span class="txtRequired">*</span>是否播种期:</td>
                    <td class="four_td2">
                        <select id="ifGrowthStart" class="selectType two_selectType">
                            <option value="0" selected="selected">否</option>
                            <option value="1" >是</option>
                        </select>
                    </td>
                </tr>
                <!--<tr>
                    <td class="four_td1">备注:</td>
                    <td class="four_td2" colspan="3">
                        <textarea name="remark" id="remark" class="inputType" style="width:96%;height: 123px;"></textarea>
                    </td>
                </tr>-->
            </table>
        </div>
        <div id="showError" style="margin-bottom: 10px;">
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;">
            <span id="ui-id-2" class="ui-dialog-title">病害配置</span>
        </div>
        <div id="diseaseDiv">
            <table class="dataintable">
                <tr><th style="width: 35%;text-align:center;">病害名称</th><th style="width: 62%;text-align:center;">防治措施</th><th style="width: 3%;text-align:center;"> <img src="images/public/addrow.png"  id="addTr1" style='margin-top: 2px;'></th></tr>
                <tr>
                    <!--<td style="width: 30%"></td>
                    <td style="width: 60%"></td>
                    <td style="width: 10%;text-align:center;"></td>-->
                </tr>
                <tbody id="paramsList1">
                </tbody>
            </table>
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;margin-top:10px;">
            <span id="ui-id-4" class="ui-dialog-title">虫害配置</span>
        </div>
        <div id="bugDiseaseDiv">
            <table class="dataintable">
                <tr><th style="width: 35%;text-align:center;">虫害名称</th><th style="width: 62%;text-align:center;">防治措施</th><th style="width: 3%;text-align:center;"> <img src="images/public/addrow.png"  id="addTr2" style='margin-top: 2px;'></th></tr>
                   <!-- <tr>
                        <td style="width: 35%"></td>
                        <td style="width: 62%"></td>
                        <td style="width: 3%;text-align:center;"></td>
                    </tr>-->
                <tbody id="paramsList2">
                </tbody>
            </table>
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;margin-top:10px;">
            <span id="ui-id-5" class="ui-dialog-title">生育期与地温配置</span>
        </div>
        <div id="conditionDiv">
            <table class="dataintable">
                <tr><th style="width: 18%;text-align:center;">开始范围</th><th style="width: 18%;text-align:center;">结束范围</th><th style="width: 16%;text-align:center;">是否均值</th><th style="width: 45%;text-align:center;">说明</th><th style="width: 3%;text-align:center;"> <img src="images/public/addrow.png"  id="addTr3" style='margin-top: 2px;;text-align:center;'></th></tr>
                <!--<tr>
                    <td style="width: 15%"></td>
                    <td style="width: 15%"></td>
                    <td style="width: 15%"></td>
                    <td style="width: 45%"></td>
                    <td style="width: 10%;text-align:center;"><img src="images/public/addrow.png"  id="addTr3" style='margin-top: 2px;;text-align:center;'></td>
                </tr>-->
                <tbody id="paramsList3">
                </tbody>
            </table>
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;margin-top:10px;">
            <span  class="ui-dialog-title">备注</span>
        </div>
        <div style="margin-top:10px;">
            <!--<span>备注:</span>-->
            <span>
                <textarea name="remark" id="remark" class="inputType" style="width:100%;height: 123px;"></textarea>
            </span>
        </div>
        <div id="showError2" style="margin-bottom: 10px; margin-left: -75px;">
    </div>

    <div id="showDetailDialog" class="form" style="display: none;">
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle">
            <span id="ui-id-3" class="ui-dialog-title">生育期配置</span>
        </div>
        <div>
            <table>
                <tr>
                    <td class="four_td1">作物:</td>
                    <td class="four_td2">
                        <span id="cropsId_V"></span>
                    </td>
                    <td class="four_td1">生育期名称:</td>
                    <td class="four_td2">
                        <span id="growthName_V"></span>
                    </td>
                </tr>
                <tr>
                    <td class="four_td1">是否播种期:</td>
                    <td class="four_td2">
                        <span id="ifGrowthStart_V"></span>
                    </td>
                    <!--<td class="four_td1">备注:</td>
                    &lt;!&ndash;td class="four_td2" colspan="3">
                        <div id="remark_V">
                        </div>
                    </td>-->
                </tr>
            </table>
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;">
            <span id="ui-id-22" class="ui-dialog-title">病害配置</span>
        </div>
        <div>
            <table class="dataintable">
                <tr><th style="width: 30%;text-align:center;">病害名称</th><th style="width: 70%;text-align:center;">防治措施</th></tr>
                <tbody id="paramsListV1">
                </tbody>
            </table>
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;margin-top:10px;">
            <span id="ui-id-44" class="ui-dialog-title">虫害配置</span>
        </div>
        <div>
            <table class="dataintable">
                <tr><th style="width: 30%;text-align:center;">虫害名称</th><th style="width: 70%;text-align:center;">防治措施</th></tr>
                <tbody id="paramsListV2">
                </tbody>
            </table>
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;margin-top:10px;">
            <span id="ui-id-55" class="ui-dialog-title">生育期与地温配置</span>
        </div>
        <div>
            <table class="dataintable">
                <tr><th style="width: 15%;text-align:center;">开始范围</th><th style="width: 15%;text-align:center;">结束范围</th><th style="width: 15%;text-align:center;">是否均值</th><th style="width: 55%;text-align:center;">说明</th></tr>
                <tbody id="paramsListV3">
                </tbody>
            </table>
        </div>
        <div class="ui-dialog-titlebar ui-corner-all ui-widget-header ui-helper-clearfix ui-draggable-handle" style="margin-bottom:10px;margin-top:10px;">
            <span  class="ui-dialog-title">备注</span>
        </div>
        <div style="margin-top:10px;">
            <!--<span>备注:</span>-->
            <span id="remark_V"></span>
        </div>
    </div>

    <div id="confirmDialog" class="dialogStyle" style="display:none">
    </div>

</div>
    <script>
        require(["jquery", "jqGrid", "BaseAjax", "formVerfication","PopWin","commons","multiselect","RegionModule"], function ($, jqGrid, BaseAjax, formVerfication,PopWin,commons,multiselect,RegionModule) {

            /*
             * 初始化
             */
            var init = function(){
                initCropIdFun(500, "search_cropId");//初始化作物下拉框
                cropsGrowthManagerGrid();//初始化grid
                $("#addBtn").bind("click",addFun);
                $("#queryBtn").bind("click",searchFun);//查询
                $("#resetBtn").on("click",resetFun);//重置

                $(window).resize(function(){
                    $("#cropsGrowthManagerGrid").setGridWidth($(".rightMain").width() - 30);
                    chanageTableCss();
                });
                chanageTableCss();
            };

            /**
             * 获取作物下拉框数据
             * @param parentId = 500
             * @version <1> 2018-05-09 wl: created.
             */
            var initCropIdFun=function (parentId, name) {
                var ajax = new BaseAjax();
                ajax.opts.url = DICT_COFING.queryDictByParentId_url;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false;
                ajax.opts.data = JSON.stringify({'parentId' : parentId});

                ajax.opts.successFun = function(result){
                    var str = "<option value=''>--请选择--</option>";
                    if(result.flag){
                        $.each(result.data, function(index, element){
                            str += "<option value='"+ element.dictId+"'>"+ element.dataName +"</option>";
                        });
                        $("#"+name).html('').append(str);
                    }
                };
                ajax.run();
            };

            /**
             * 重置
             * @version<1> 2018-06-21 cxw :created.
             */
            var resetFun = function(){
                $(".input").val("");
                $("#txtArea").removeAttr("regionid");
                $('#cropId').html('<option value="">--请选择--</option>');
            }

            /**
             * 物候期与地温关系动态添加行
             * @version <1> 2018-05-22 lxy： Created.
             */
            var addGrowthRelative=function(index){
                var tables = $('#paramsList'+index);
                var row = $("<tr class='paramsTr'>"+
                        "<td><input type='text' name='tempRangeStart' class='inputType tempRange'  /></td>"+
                        "<td><input type='text' name='tempRangeEnd' class='inputType tempRange'/></td>"+
                        "<td><select name='ifavg' class='inputType tempRange'><option value='1' selected='selected'>是</option><option value='0' >否</option></select></td>"+
                        "<td><input type='text' name='instruction' class='inputType instruction'  /></td>"+
                        "<td style='text-align:center;'><img src='images/public/reduce.png' class='removeTr' style='margin-top: 2px;' ></td>"+
                        "</tr>");
                row.appendTo(tables);
                $(".removeTr").click(function(){//点击动态移除一行
                    $(this).parent().parent().remove();
                });
            };

            /**
             * 病虫害动态添加
             * @param index 索引
             * @version <1> 2018-05-21 lxy： Created.
             */
            var addBugDiseaseRow=function(index){
                var tables = $('#paramsList'+index);
                var row = $("<tr class='paramsTr'>"+
                        "<td><input type='text' name='diseaseName' class='inputType diseaseName' /></td>"+
                        "<td><input type='text' name='diseaseMeasure' class='inputType diseaseMeasure' /></td>"+
                        "<td style='text-align:center;'><img src='images/public/reduce.png' class='removeTr' style='margin-top: 2px;' ></td>"+
                        "</tr>");
                row.appendTo(tables);
                $(".removeTr").click(function(){//点击动态移除一行
                    $(this).parent().parent().remove();
                });
            };

            /**
             * 点击编辑或者新增按钮时
             * 先清空原本的弹出框算法参数信息，并移除除了第一行之外的
             * @param index 索引
             * @version <1> 2018-05-21 lxy：Created.
             */
            var showTr=function(index){
                //对话框弹打开后，就是可以删除了。
                $(".removeTr").click(function(){//点击动态移除一行
                    $(this).parent().parent().remove();
                });
                //除了算法参数的第一行其余的清除 并清除第一行数据
                $("#paramsList"+index+" tr").remove();
                $("#paramsList"+index+" tr input").val("");//清空
                $("#paramsList"+index+" tr select").find("option[value='1']").attr("selected",true);//初始化select框
                //绑定增加行事件
                $("#addTr"+index).bind("click",function () {
                    if(index<3)
                        addBugDiseaseRow(index);//病虫害
                    else
                        addGrowthRelative(index);//地温条件
                });
            };

            /**
             * 封装所有数据
             * @version <1> 2018-05-21 lxy：Created.
             */
            var wrapEachTrValues = function(){
                var growthData = {};
                var diseases = [];//装载病虫害病虫害容器
                //获取病害配置
                $("#paramsList1").find("tr").each(function(){
                    var tdArr = $(this).children();
                    var diseaseName = tdArr.eq(0).find("input").val();//病虫害名称
                    var diseaseMeasure = tdArr.eq(1).find("input").val();//病虫害防治措施
                    if(diseaseName!="" || diseaseMeasure!=""){
                        var disease = {'diseaseName':diseaseName,'diseaseMeasure':diseaseMeasure,'diseaseType':1};
                        diseases.push(disease);//添加病虫害
                    }
                });

                //获取虫害配置
                $("#paramsList2").find("tr").each(function(){
                    var tdArr = $(this).children();
                    var diseaseName = tdArr.eq(0).find("input").val();//病虫害名称
                    var diseaseMeasure = tdArr.eq(1).find("input").val();//病虫害防治措施
                    if(diseaseName!="" || diseaseMeasure!=""){
                        var disease = {'diseaseName':diseaseName,'diseaseMeasure':diseaseMeasure,'diseaseType':2};
                        diseases.push(disease);//添加病虫害
                    }
                });

                var growthConditions=[];//装载地温条件容器
                //获取地温条件
                $("#paramsList3").find("tr").each(function(){
                    var tdArr = $(this).children();
                    var tempRangeStart = tdArr.eq(0).find("input").val();//开始范围
                    var tempRangeEnd = tdArr.eq(1).find("input").val();//结束范围
                    var ifavg = tdArr.eq(2).find("select").val();//是否均值
                    var instruction = tdArr.eq(3).find("input").val();//条件说明
                    if(tempRangeStart != "" || tempRangeEnd != "" || instruction != ""){
                        var growthCondition = {'tempRangeStart':tempRangeStart,'tempRangeEnd':tempRangeEnd,'ifavg':ifavg,'instruction':instruction};
                        growthConditions.push(growthCondition);//添加地温条件
                    }
                });
                growthData["diseases"]=diseases;//病虫害数据
                growthData["growthConditions"]=growthConditions;//地温条件
                return growthData;
            };

            //修改时候填充所有数据
            var initEachTrValues = function (growthData) {
                var diseases = growthData.diseases;//病害
                var diseasesTable = $('#paramsList1');//病害表
                $(diseases).each(function(i,disease){
                    var row = $("<tr class='paramsTr'>"+
                            "<td><input type='text' name='diseaseName' class='inputType diseaseName' value='"+disease.diseaseName+"'/></td>"+
                            "<td><input type='text' name='diseaseMeasure' class='inputType diseaseMeasure' value='"+disease.diseaseMeasure+"'/></td>"+
                            "<td style='text-align:center;'><img src='images/public/reduce.png' class='removeTr' style='margin-top: 2px;' ></td>"+
                            "</tr>");
                    row.appendTo(diseasesTable);
                    $(".removeTr").click(function(){//点击动态移除一行
                        $(this).parent().parent().remove();
                    });
                });

                var bugDiseases = growthData.bugDiseases;//虫害
                var bugDiseasesTable = $('#paramsList2');//虫害表
                $(bugDiseases).each(function(i,disease){
                    var row = $("<tr class='paramsTr'>"+
                            "<td><input type='text' name='diseaseName' class='inputType diseaseName' value='"+disease.diseaseName+"'/></td>"+
                            "<td><input type='text' name='diseaseMeasure' class='inputType diseaseMeasure' value='"+disease.diseaseMeasure+"'/></td>"+
                            "<td style='text-align:center;'><img src='images/public/reduce.png' class='removeTr' style='margin-top: 2px;' ></td>"+
                            "</tr>");
                    row.appendTo(bugDiseasesTable);
                    $(".removeTr").click(function(){//点击动态移除一行
                        $(this).parent().parent().remove();
                    });

                });
                var growthConditions = growthData.growthConditions;//生长条件
                var growthConditionTable = $("#paramsList3");//地温条件表
                $(growthConditions).each(function (i,growthCondition) {
                    var tempRangeStart = growthCondition.tempRangeStart+"";
                    tempRangeStart = tempRangeStart.replace("null","");
                    var tempRangeEnd = growthCondition.tempRangeEnd+"";
                    tempRangeEnd = tempRangeEnd.replace("null","");
                    var options="";//options的处理
                    var ifAvg = growthCondition.ifavg;
                    if(ifAvg == "1"){
                        options="<option value='1' selected='selected'>是</option><option value='0' >否</option>";
                    }else{
                        options="<option value='1' >是</option><option value='0' selected='selected'>否</option>";
                    }
                    var row = $("<tr class='paramsTr'>"+
                            "<td><input type='text' name='tempRangeStart' class='inputType tempRange'  value='"+tempRangeStart+"'/></td>"+
                            "<td><input type='text' name='tempRangeEnd' class='inputType tempRange' value='"+tempRangeEnd+"'/></td>"+
                            "<td><select name='ifavg' class='inputType tempRange'>"+options+"</select></td>"+
                            "<td><input type='text' name='instruction' class='inputType instruction' value='"+growthCondition.instruction+"'/></td>"+
                            "<td style='text-align:center;'><img src='images/public/reduce.png' class='removeTr' style='margin-top: 2px;' ></td>"+
                            "</tr>");
                    row.appendTo(growthConditionTable);
                    $(".removeTr").click(function(){//点击动态移除一行
                        $(this).parent().parent().remove();
                    });
                })

            };

            /**
             * 初始化作物下拉框
             * @param crop 查询出的作物对象集合
             * @param cropIdName 区域名称Id
             * @version <1> 2018-04-18 cxw : created.
             */
            var initCropFun = function(crop,cropIdName){
                var result;
                result = '<option value="">--请选择--</option>';
                if(crop!=null)
                {
                    $.each(crop,function(i,o){
                        result += '<option value = "' + o.cropId + '">' + o.cropName + '</option>';
                    });
                    if(result!='')
                    {
                        $('#'+cropIdName).html(result);
                    }
                    else{
                        $('#'+cropIdName).html('<option value="">--请选择--</option>');
                    }
                }
                else{
                    $('#'+cropIdName).html('<option value="">--请选择--</option>');
                }
            };

            /**
             * 开始月范围触发事件加载日范围
             * @version <1> 2018-4-20 cxw : created.
             */
            var arrMon = ['01','03','05','07','08','10','12']; //包含31天的月份数组
            var arrDayForLeast = ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29'];
            var arrDayForMiddle = ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30'];
            var arrDayForMost = ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31'];
            var dateStartEvent = function(){
                var startMonth = $('#rangeStartMonth').val();
                initDateRange('#rangeStartDay',startMonth);
            };

            /**
             * 结束月范围触发事件加载日范围
             * @version <1> 2018-4-20 cxw : created.
             */
            var dateEndEvent = function(){
                var endMonth = $('#rangeEndMonth').val();
                initDateRange('#rangeEndDay',endMonth);
            };

            /**
             * 结束月范围触发事件加载日范围
             * @param obj 要加载的select框对象
             * @param dateVal 月范围值
             * @version <1> 2018-4-20 cxw : created.
             */
            var initDateRange = function (obj,dateVal) {
                var result;
                //如果是包含31天的月份加载日范围为31天
                if(isInArray(arrMon,dateVal)){
                    for(var index in arrDayForMost){
                        result += '<option value = "' + arrDayForMost[index] + '">' + arrDayForMost[index]+"日" + '</option>';
                    }
                }
                //如果是包含29天的月份加载日范围为29天
                else if(dateVal=='02'){
                    for(var index in arrDayForLeast){
                        result += '<option value = "' + arrDayForLeast[index] + '">' + arrDayForLeast[index]+"日" + '</option>';
                    }
                }
                //如果是包含30天的月份加载日范围为30天
                else{
                    for(var index in arrDayForMiddle){
                        result += '<option value = "' + arrDayForMiddle[index] + '">' + arrDayForMiddle[index]+"日" + '</option>';
                    }
                }
                $(obj).html(result);
                initJumpYear();
            };

            /**
             * 加载是否跨年
             * @version <1> 2018-4-20 cxw : created.
             */
            var initJumpYear = function(){
                var  rangeStartMonth =  $('#rangeStartMonth').val();
                var  rangeEndMonth =  $('#rangeEndMonth').val();
                var select = document.getElementById('ifspan');
                if(rangeStartMonth>rangeEndMonth){
                    for (var i = 0; i < select.options.length; i++){
                        if (select.options[i].value == '1'){
                            select.options[i].selected = true;
                            break;
                        }
                    }
                }
                else{
                    for (var i = 0; i < select.options.length; i++){
                        if (select.options[i].value == '0'){
                            select.options[i].selected = true;
                            break;
                        }
                    }
                }

            };

            /**
             * 判断数组是否包含某个值
             * @param arr 数组
             * @param value 是否包含的值
             * @version <1> 2018-4-20 cxw : created.
             */
            var  isInArray = function(arr,value){
                var index = $.inArray(value,arr);
                if(index >= 0){
                    return true;
                }
                return false;
            };

            /**
             * 农作物生育周期记录的渲染
             * @version <1> 2018-04-13 lxy： Created.
             * @version <2> 2018-04-18 cxw： update:增加区域和作物
             */
            var cropsGrowthManagerGrid = function () {
                $("#cropsGrowthManagerGrid").jqGrid({
                    url: CROPS_GROWTH_MANAGER.findByPage_url,
                    datatype: "json",
                    postData: {
                        "cropsGrowthManager":{}
                    },
                    mtype: 'POST',
                    jsonReader: {
                        root: "list",
                        total: "pages",
                        page: "page",
                        records: "total",
                        repeatitems: false
                    },
                    rownumbers: true,
                    colNames: ['id', '作物', '生育期名称','是否播种期','创建时间', '修改时间','操作'],
                    colModel: [
                        {name: 'id', index: 'id', hidden: true},
                        {name: 'cropsName', index: 'crops_id', align: 'center', width: '20%'},
                        {name: 'growthName', index: 'growth_name', align: 'center', width: '20%'},
                        {name: 'ifGrowthStartName', index: 'if_growth_start', align: 'center', width: '20%'},
                        {name: 'createTime', index: 'period.create_time', align: 'center', width: '15%'},
                        {name: 'modifyTime', index: 'period.modify_time', align: 'center', width: '15%'},
                        {
                            name: 'cz',
                            index: 'cz',
                            width: '20%',
                            align: "center",
                            sortable: false,
                            formatter: function (cellvalue, options, rowObject) {
                                var str = "<img src='images/public/Tedit.png' class='editBtn' data-id='" + rowObject.id + "' title='编辑' style='margin-right: 3px;'>"+
                                        "<img src='images/public/Twatch.png' class='seeBtn' data-id='"+ rowObject.id +"' title='查看明细' >"+
                                        "<img src='images/public/Tdelete.png' class='delBtn' data-id='" + rowObject.id + "' title='删除' >";
                                return str;
                            }
                        }
                    ],
                    width: '100%',
                    autowidth: true,
                    height: '100%',
                    rowNum: 15,
                    rowList: [15,30],
                    pager: '#pager2',
                    //sortname: 'id',
                    viewrecords: true,
                    //sortorder: "desc",
                    loadComplete: function () {
                        commons.isNextDisable();
                        $(".editBtn,.delBtn,.seeBtn").off("click");
                        $(".editBtn").on("click", function () {
                            editFun($(this).attr("data-id"));
                        });
                        $(".seeBtn").on("click", function () {
                            seeFun($(this).attr("data-id"));
                        });
                        $(".delBtn").on("click", function () {
                            deleteFun($(this).attr("data-id"));
                        });
                    }
                });
            };

            /**
             * 查看农情配置详情
             * @version <1> 2018-04-18 lxy : Created.
             */
            var seeFun = function (growthId) {
                var height = $(document.body).height()*0.80;//高度
                var width = $(document.body).width()*0.70;//宽度
                var ajax = new BaseAjax();
                ajax.opts.url = CROPS_GROWTH_MANAGER.findById_url+"?growthId="+growthId;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false; //同步请求
                ajax.opts.successFun = function(result) {
                    initDataDetail(result.data);
                    var showDetailDialog = $("#showDetailDialog");//生育期配置详情
                    var dialogParent = showDetailDialog.parent();
                    var dialogOwn = showDetailDialog.clone();
                    showDetailDialog.dialog({
                        autoOpen: false,
                        title: '生育期配置详情',
                        height: height,
                        width: width,
                        modal: true,
                        close:function(){
                            dialogOwn.appendTo(dialogParent);
                            $(this).dialog("destroy").remove();
                        },
                        buttons: [
                            {
                                text:"关闭",
                                click:function(){
                                    $(this).dialog("close");
                                }
                            }
                        ]
                    });
                    showDetailDialog.dialog("open");
                };
                ajax.run();

            };

            /**
             * 根据指定的查询条件，查询对应的记录并重新渲染
             * @version <1> 2018-04-13 lxy： Created.
             * @version <2> 2018-04-18 cxw： update:增加区域和作物查询条件.
             */
            var searchFun = function () {
                var growthName = $.trim($("#search_growthName").val());//生育期
                var cropsId = $.trim($("#search_cropId").val());//作物id
                $("#cropsGrowthManagerGrid").jqGrid('setGridParam', {
                    datatype: 'json',
                    postData: {'growthName': growthName, 'cropsId': cropsId},
                    page: 1
                }).trigger("reloadGrid");
            };

            /**
             * 获取表单新增或者修改的数据
             * @version <1> 2018-04-18 cxw： Created.
             * @version <2> 2018-05-22 lxy： updated. 新增了修改其他生育期相关的数据
             */
            var getGrowthData = function() {
                //获取生育期的数据
                var growthName = $.trim($("#growthName").val());
                var cropsId = $.trim($("#cropsId").val());
                var ifGrowthStart = $('#ifGrowthStart').val();
                var remark = $('#remark').val();
                //获取生育期封装的其他数据
                var growthData = wrapEachTrValues();
                //封装生育期的数据
                growthData["growthManager"] = {
                    growthName: growthName,
                    cropsId: cropsId,
                    cropsName: $.trim($("#cropsId option:selected").text()) || '',
                    remark:remark,
                    ifGrowthStart:ifGrowthStart
                };
                return growthData;
            };

            /**
             * 新增生育期页
             * @version <1> 2018-08-10 zhangshen： Created.
             */
            var addFun = function() {
                clearInput();//清空数据
                var height = $(document.body).height()-150;//高度
                var width = $(document.body).width()*0.60;//宽度
                showTr(1);//病害
                showTr(2);//虫害
                showTr(3);//地温关系
                initCropIdFun(500, "cropsId");//初始化作物下拉框
                //document.getElementById("rangeStartMonth").onchange = dateStartEvent;
                //document.getElementById("rangeEndMonth").onchange = dateEndEvent;
                var cropsGrowthPeriodDialog =  $("#dataTypeInfo");
                var dialogParent = cropsGrowthPeriodDialog.parent();
                var dialogOwn = cropsGrowthPeriodDialog.clone();
                cropsGrowthPeriodDialog.dialog({
                    autoOpen: false,
                    title:'生育期配置信息',
                    height: height,
                    width: width,
                    modal: true,
                    close:function(){
                        dialogOwn.appendTo(dialogParent);
                        $(this).dialog("destroy").remove();
                    },
                    buttons: [{
                        text:"保存",
                        click:function(){
                            addSaveFun(cropsGrowthPeriodDialog);
                        }},{
                        text:"取消",
                        click:function(){
                            $(this).dialog("close");
                        }
                    }]
                });
                cropsGrowthPeriodDialog.dialog("open");
            };

            /**
             * 保存生育期信息
             * @param cropsGrowthPeriodDialog 弹框对象
             * @version <1> 2018-04-12 lxy： Created.
             * *@version <2> 2018-04-18 cxw： update:完善注释及更改提示信息
             */
            var addSaveFun = function(cropsGrowthPeriodDialog) {
                //校验输入框信息
                if (!formVerf()) {
                    return;
                }
                var baseAjax = new BaseAjax();
                baseAjax.opts.url = CROPS_GROWTH_MANAGER.save_url;
                baseAjax.opts.async = false; //同步
                baseAjax.opts.contentType = "application/json";
                baseAjax.opts.data = JSON.stringify(getGrowthData());
                baseAjax.opts.successFun = function (result) {
                    if (result.flag) {
                        $("#cropsGrowthManagerGrid").trigger("reloadGrid");
                        cropsGrowthPeriodDialog.dialog("close");
                        PopWin.showMessageWin("新增成功");
                    } else {
                        PopWin.showMessageWin("新增失败："+result.msg);
                    }
                };
                baseAjax.opts.errorFun = function (result) {
                    PopWin.showMessageWin("新增失败："+result.msg);
                };
                baseAjax.run();
            };

            /**
             * 删除生育期信息
             * @param id 生育期主键
             * @version <1> 2018-04-12 lxy： Created.
             * @version <2> 2018-04-18 cxw： update:1.原参数传递为生育期对象，现改为传递生育期主键.;2.完善注释及更改提示信息
             */
            var deleteFun = function (id) {
                var confirmDialog = $("#confirmDialog");
                confirmDialog.html("是否确认删除所选记录？");
                confirmDialog.dialog({
                    autoOpen: false,
                    title: '系统提示',
                    height: 160,
                    width: 410,
                    modal: true,
                    buttons: [{
                        text:"是",
                        click:function(){
                            var ajax = new BaseAjax();
                            ajax.opts.url = CROPS_GROWTH_MANAGER.del_url+"?growthId="+id;
                           // ajax.opts.data = JSON.stringify({'growthId':id});
                            ajax.opts.contentType = "application/json";
                            ajax.opts.successFun = function (result) {
                                if (result.flag) {
                                    $("#cropsGrowthManagerGrid").trigger("reloadGrid");
                                    confirmDialog.dialog("close");
                                    PopWin.showMessageWin("删除成功");
                                } else {
                                    PopWin.showMessageWin("删除失败");
                                }
                            };
                            ajax.opts.errorFun = function () {
                                PopWin.showMessageWin("删除失败");
                            };
                            ajax.run();
                        }},{
                        text:"否",
                        click:function(){
                            $(this).dialog("close");
                        }
                    }]
                });
                confirmDialog.dialog("open");
            };

            /**
             * 修改生育期页
             * @param id 生育期主键
             * @version <1> 2018-04-12 lxy： Created.
             * @version <2> 2018-04-18 cxw： update:1.加载初始化区域控件；2.完善注释
             */
            var editFun = function (id) {
                var height = $(document.body).height()-150;//高度
                var width = $(document.body).width()*0.60;//宽度
                showTr(1);//病害
                showTr(2);//虫害
                showTr(3);//地温关系
                //document.getElementById("rangeStartMonth").onchange = dateStartEvent;
                //document.getElementById("rangeEndMonth").onchange = dateEndEvent;
                var ajax = new BaseAjax();
                ajax.opts.url = CROPS_GROWTH_MANAGER.findById_url+"?growthId="+id;
                ajax.opts.contentType = "application/json";
                ajax.opts.async = false; //同步请求
                ajax.opts.successFun = function(result) {
                    if (result.flag) {
                        initData(result.data);//填充数据
                        var configDialog =  $("#dataTypeInfo");
                        var dialogParent = configDialog.parent();
                        var dialogOwn = configDialog.clone();
                        configDialog.dialog({
                            autoOpen: false,
                            title:'生育期配置信息',
                            height: height,
                            width: width,
                            modal: true,
                            close:function(){
                                dialogOwn.appendTo(dialogParent);
                                $(this).dialog("destroy").remove();
                            },
                            buttons:[
                                {
                                    text:"保存",
                                    click:function(){
                                        if (!formVerf()) {
                                            return;
                                        }
                                        var param = getGrowthData();
                                        param.growthId = id;
                                        update(configDialog, param);
                                    }},{
                                    text:"取消",
                                    click:function(){
                                        $(this).dialog("close");
                                    }
                                }
                            ]
                        });
                        configDialog.dialog("open");
                    }
                };
                ajax.run();
            };

            /**
             * 保存更新内容
             * @param configDialog 弹框对象
             * @param param 生育期更新参数对象
             * @version <1> 2018-04-13 lxy： Created.
             * @version <1> 2018-04-18 cxw： update:完善注释及更改提示信息
             */
            var update = function(configDialog, param) {
                var baseAjax = new BaseAjax();
                baseAjax.opts.url = CROPS_GROWTH_MANAGER.update_url;
                baseAjax.opts.async = false; //同步
                baseAjax.opts.contentType = "application/json";
                baseAjax.opts.data = JSON.stringify(param);
                baseAjax.opts.successFun = function (result) {
                    if (result.flag) {
                        $("#cropsGrowthManagerGrid").trigger("reloadGrid");
                        configDialog.dialog("close");
                        PopWin.showMessageWin("修改成功");
                    } else {
                        PopWin.showMessageWin("修改失败");
                    }
                };
                baseAjax.opts.errorFun = function (result) {
                    PopWin.showMessageWin("修改失败");
                };
                baseAjax.run();
            };

            /**
             * 弹出修改页面时初始化加载当前修改对象信息
             * @param data 生育期对象信息
             * @version <1> 2018-04-18 cxw： Created.
             */
            var initData = function(data) {
                var growthManagerData = data.growthManager;//生育期数据
                $("#growthName").val(growthManagerData.growthName);
                initCropIdFun(500, "cropsId");
                $("#cropsId").val(growthManagerData.cropsId);
                $('#remark').val(growthManagerData.remark);
                $("#ifGrowthStart").find("option[value = '"+growthManagerData.ifGrowthStart+"']").attr("selected","selected");
                //初始化生育期其他数据
                initEachTrValues(data);
            };

            /**
             * 加载详细页面
             * @param data 生育期对象信息
             * @version <1> 2018-06-13 lxy： Created.
             */
            var initDataDetail = function(data) {
                var growthManagerData = data.growthManager;//生育期数据
                $("#growthName_V").html(growthManagerData.growthName);
                $("#cropsId_V").html(growthManagerData.cropsName);
                $('#remark_V').html(growthManagerData.remark);
                $('#ifGrowthStart_V').html(growthManagerData.ifGrowthStart=='1'?"是":"否");
                //初始化生育期其他数据
                initEachViewTrValues(data);
            };

            //修改时候填充所有数据
            var initEachViewTrValues = function (growthData) {
                var diseases = growthData.diseases;//病害
                var diseasesTable = $('#paramsListV1');//病害表
                diseasesTable.html("");//清空原来数据
                $(diseases).each(function(i,disease){
                    var row = $("<tr class='paramsTr'>"+
                            "<td><span>"+disease.diseaseName+"</span></td>"+
                            "<td><span>"+disease.diseaseMeasure+"</span></td>"+
                            "</tr>");
                    row.appendTo(diseasesTable);
                });

                var bugDiseases = growthData.bugDiseases;//虫害
                var bugDiseasesTable = $('#paramsListV2');//虫害表
                bugDiseasesTable.html("");//清空原来数据
                $(bugDiseases).each(function(i,disease){
                    var row = $("<tr class='paramsTr'>"+
                            "<td><span>"+disease.diseaseName+"</span></td>"+
                            "<td><span>"+disease.diseaseMeasure+"</span></td>"+
                            "</tr>");
                    row.appendTo(bugDiseasesTable);
                });
                var growthConditions = growthData.growthConditions;//生长条件
                var growthConditionTable = $("#paramsListV3");//地温条件表
                growthConditionTable.html("");//清空原来数据
                $(growthConditions).each(function (i,growthCondition) {
                    var tempRangeStart = growthCondition.tempRangeStart+"";
                    tempRangeStart = tempRangeStart.replace("null","");
                    var tempRangeEnd = growthCondition.tempRangeEnd+"";
                    tempRangeEnd = tempRangeEnd.replace("null","");
                    var options="";//options的处理
                    var ifAvg = growthCondition.ifavg;
                    if(ifAvg == "1"){
                        options="是";
                    }else{
                        options="否";
                    }
                    var row = $("<tr class='paramsTr'>"+
                            "<td><span>"+tempRangeStart+"</span></td>"+
                            "<td><span>"+tempRangeEnd+"</span></td>"+
                            "<td><span>"+options+"</span></td>"+
                            "<td><span>"+growthCondition.instruction+"</span></td>"+
                            "</tr>");
                    row.appendTo(growthConditionTable);
                });

            };


            /**
             * 校验input框输入信息
             * @version <1> 2018-04-17 cxw： Created.
             */
            var formVerf = function () {
                var errorDiv = $('#showError');
                var errorDiv2 = $('#showError2');
                //初始化去掉错误样式
                $(".formErrorInfo").remove();
                $("input").removeClass("formInputHighlight");
                if(formVerfication.checkInputIsEmpty($('#cropsId'),errorDiv,'作物不能为空')){
                    return false;
                }
                if(formVerfication.checkInputIsEmpty($('#growthName'),errorDiv,'生育期名称不能为空')){
                    return false;
                }
                var growthName=$('#growthName').val();
                if(growthName != ""){
                    if(formVerfication.checkInputLength(1,25,$('#growthName'),errorDiv,"生育期名称长度不能超过25个字符")){
                        return false;
                    }
                }
                var growthName=$('#remark').val();
                if(remark != ""){
                    if(formVerfication.checkInputLength(0,500,$('#remark'),errorDiv2,"备注长度不能超过500个字符")){
                        return false;
                    }
                }
                if(!verifyDisease()){
                    return false;
                }
                if(!verifyBugDisease()){
                    return false;
                }
                if(!verifyCondition()){
                    return false;
                }
                return true;
            };

            //验证病害
            var verifyDisease = function(){
                var flag = true;
                //获取地温条件的div
                var diseaseDiv = $("#diseaseDiv");
                //循环遍历所有的病害信息
                $("#paramsList1").find("tr").each(function(){
                    var tdArr = $(this).children();
                    var diseaseName = tdArr.eq(0).find("input").val();//病害名称
                    var diseaseMeasure = tdArr.eq(1).find("input").val();//病害防治措施
                    if(diseaseName != ""){
                        if(formVerfication.checkInputLength(1,100,tdArr.eq(0).find("input"),diseaseDiv,"病害名称字符不能超过100位")){
                            flag=false;
                            return flag;
                        }
                    }
                    if(diseaseMeasure != ""){
                        if(formVerfication.checkInputLength(1,500,tdArr.eq(1).find("input"),diseaseDiv,"防治措施字符不能超过500位")){
                            flag=false;
                            return flag;
                        }
                    }
                });
                return flag;
            };

            //验证虫害
            var verifyBugDisease = function(){
                var flag = true;
                //获取地温条件的div
                var bugDiseaseDiv = $("#bugDiseaseDiv");
                //循环遍历所有的病害信息
                $("#paramsList2").find("tr").each(function(){
                    var tdArr = $(this).children();
                    var diseaseName = tdArr.eq(0).find("input").val();//病害名称
                    var diseaseMeasure = tdArr.eq(1).find("input").val();//病害防治措施
                    if(diseaseName != ""){
                        if(formVerfication.checkInputLength(1,100,tdArr.eq(0).find("input"),bugDiseaseDiv,"虫害名称字符不能超过100位")){
                            flag=false;
                            return flag;
                        }
                    }
                    if(diseaseMeasure != ""){
                        if(formVerfication.checkInputLength(1,500,tdArr.eq(1).find("input"),bugDiseaseDiv,"防治措施字符不能超过500位")){
                            flag=false;
                            return flag;
                        }
                    }
                });
                return flag;
            };

            //验证地温条件
            var verifyCondition = function(){
                var flag = true;
                //获取地温条件的div
                var conditionDiv = $("#conditionDiv");
                //循环遍历所有的条件范围
                $("#paramsList3").find("tr").each(function(){
                    var tdArr = $(this).children();
                    var tempRangeStart = tdArr.eq(0).find("input").val();//开始范围
                    var tempRangeEnd = tdArr.eq(1).find("input").val();//结束范围
                    var instruction = tdArr.eq(3).find("input").val();//条件说明
                    if(tempRangeStart != ""){
                        if(formVerfication.checkInputIsPlusMinusNumber(tdArr.eq(0).find("input"),conditionDiv,"开始范围为正整数")){
                            flag=false;
                            return flag;
                        }
                    }

                    if(tempRangeStart != ""){
                        if(formVerfication.checkInputLength(1,5,tdArr.eq(0).find("input"),conditionDiv,"开始范围数字不能超过5位")){
                            flag=false;
                            return flag;
                        }
                    }

                    if(tempRangeEnd != ""){
                        if(formVerfication.checkInputIsPlusMinusNumber(tdArr.eq(1).find("input"),conditionDiv,"结束范围为正整数")){
                            flag=false;
                            return flag;
                        }

                    }
                    if(tempRangeEnd != ""){
                        if(formVerfication.checkInputLength(1,5,tdArr.eq(1).find("input"),conditionDiv,"结束范围数字不能超过5位")){
                            flag=false;
                            return flag;
                        }
                    }
                    if(instruction != ""){
                        if(formVerfication.checkInputLength(1,100,tdArr.eq(3).find("input"),conditionDiv,"条件说明字符不能超过100位")){
                            flag=false;
                            return flag;
                        }
                    }
                });
                return flag;
            };

            /**
             * 加载新增页时清空文本输入内容
             * @version <1> 2018-04-17 cxw： Created.
             */
            var clearInput = function() {
                $(".inputType").val("");
                $("#cropsId").html("<option value=''>--请选择--</option>");
                $("#ifGrowthStart").find("option").first().attr("selected", "selected");
            };

            var chanageTableCss = function(){
                var divObj = $('#cropsGrowthManagerGrid').parent('div');
                divObj.addClass('tableStyle');
                divObj.css({'maxHeight':($(".rightMain").height()-$(".searchItems").height()-$(".ui-jqgrid-hdiv").height())-$("#pager2").height()-50+"px"});
            };

            init();
        });
    </script>
</div>