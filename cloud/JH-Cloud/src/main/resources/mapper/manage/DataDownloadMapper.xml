<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jh.manage.download.mapping.IDataDownloadMapper" >
  <resultMap id="BaseResultMap" type="com.jh.manage.download.entity.DataDownload" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="download_id" property="downloadId" jdbcType="INTEGER" />
    <result column="data_status" property="dataStatus" jdbcType="CHAR" />
    <result column="del_flag" property="delFlag" jdbcType="CHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
    <result column="creator" property="creator" jdbcType="INTEGER" />
    <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
    <result column="modifier_name" property="modifierName" jdbcType="VARCHAR" />
    <result column="modifier" property="modifier" jdbcType="INTEGER" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="download_meta_id" property="downloadMetaId" jdbcType="INTEGER" />
      <result column="download_meta_value" property="downloadMetaValue" jdbcType="VARCHAR" />
    <result column="download_name" property="downloadName" jdbcType="VARCHAR" />
    <result column="region_id" property="regionId" jdbcType="BIGINT" />
    <result column="start_date" property="startDate" jdbcType="TIMESTAMP" />
    <result column="end_date" property="endDate" jdbcType="TIMESTAMP" />
    <result column="total_num" property="totalNum" jdbcType="INTEGER" />
    <result column="ok_num" property="okNum" jdbcType="INTEGER" />
    <result column="download_status" property="downloadStatus" jdbcType="INTEGER" />
    <result column="storage_path" property="storagePath" jdbcType="VARCHAR" />
    <result column="download_name" property="downloadName" jdbcType="VARCHAR" />
    <result column="reason" property="reason" jdbcType="VARCHAR" />
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    download_id, data_status, del_flag, create_time, creator_name, creator, modify_time, 
    modifier_name, modifier, remark, download_meta_id,download_meta_value, download_name, region_id, start_date,
    end_date, total_num, ok_num,download_status,storage_path,download_name,reason
  </sql>

  <select id="getById" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from man_download_task
    where download_id = #{downloadId,jdbcType=INTEGER}
  </select>

  <insert id="save" useGeneratedKeys="true" keyProperty="downloadId" parameterType="com.jh.manage.download.entity.DataDownload" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into man_download_task
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="dataStatus != null" >data_status,</if>
      <if test="delFlag != null" >del_flag,</if>
      <if test="createTime != null" >create_time,</if>
      <if test="creatorName != null" >creator_name,</if>
      <if test="creator != null" >creator,</if>
      <if test="modifyTime != null" >modify_time,</if>
      <if test="modifierName != null" >modifier_name,</if>
      <if test="modifier != null" >modifier,</if>
      <if test="remark != null" >remark,</if>
      <if test="downloadMetaId != null" >download_meta_id,</if>
      <if test="downloadMetaValue != null">download_meta_value,</if>
      <if test="regionId != null" >region_id,</if>
      <if test="startDate != null" >start_date,</if>
      <if test="endDate != null" >end_date,</if>
      <if test="totalNum != null" >total_num,</if>
      <if test="okNum != null" >ok_num,</if>
      <if test="downloadStatus != null" >download_status,</if>
      <if test="storagePath != null" >storage_path,</if>
      <if test="downloadName != null" >download_name,</if>
      <if test="reason != null and reason !=''" >reason,</if>
      <if test="dataType != null and dataType !=''" >data_type,</if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="dataStatus != null" >#{dataStatus,jdbcType=CHAR},</if>
      <if test="delFlag != null" > #{delFlag,jdbcType=CHAR},</if>
      <if test="createTime != null" > #{createTime,jdbcType=DATE},</if>
      <if test="creatorName != null" >#{creatorName,jdbcType=VARCHAR},</if>
      <if test="creator != null" >#{creator,jdbcType=INTEGER},</if>
      <if test="modifyTime != null" >#{modifyTime,jdbcType=DATE}, </if>
      <if test="modifierName != null" >#{modifierName,jdbcType=VARCHAR},</if>
      <if test="modifier != null" >#{modifier,jdbcType=INTEGER}, </if>
      <if test="remark != null" >#{remark,jdbcType=VARCHAR},</if>
      <if test="downloadMetaId != null" >#{downloadMetaId,jdbcType=INTEGER},</if>
      <if test="downloadMetaValue != null">#{downloadMetaValue,jdbcType=VARCHAR},</if>
      <if test="regionId != null" >#{regionId,jdbcType=BIGINT},</if>
      <if test="startDate != null" >#{startDate,jdbcType=DATE},</if>
      <if test="endDate != null" > #{endDate,jdbcType=DATE},</if>
      <if test="totalNum != null" >#{totalNum,jdbcType=INTEGER},</if>
      <if test="okNum != null" >#{okNum,jdbcType=INTEGER},</if>
      <if test="downloadStatus != null" >#{downloadStatus,jdbcType=INTEGER},</if>
      <if test="storagePath != null" >#{okNum,jdbcType=VARCHAR},</if>
      <if test="downloadName != null" >#{downloadName,jdbcType=VARCHAR},</if>
      <if test="reason != null and reason != ''" >#{reason,jdbcType=VARCHAR},</if>
      <if test="dataType != null and dataType != ''" >#{dataType,jdbcType=VARCHAR},</if>
    </trim>
  </insert>

  <update id="update" parameterType="com.jh.manage.download.entity.DataDownload" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update man_download_task
    <set >
      <if test="dataStatus != null" >
        data_status = #{dataStatus,jdbcType=CHAR},
      </if>
      <if test="delFlag != null" >
        del_flag = #{delFlag,jdbcType=CHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=DATE},
      </if>
      <if test="creatorName != null" >
        creator_name = #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=INTEGER},
      </if>
      <if test="modifyTime != null" >
        modify_time = #{modifyTime,jdbcType=DATE},
      </if>
      <if test="modifierName != null" >
        modifier_name = #{modifierName,jdbcType=VARCHAR},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="downloadMetaId != null" >
        download_meta_id = #{downloadMetaId,jdbcType=INTEGER},
      </if>
      <if test="downloadMetaValue != null">
        download_meta_value = #{downloadMetaValue,jdbcType=VARCHAR},
      </if>
      <if test="regionId != null" >
        region_id = #{regionId,jdbcType=BIGINT},
      </if>
      <if test="startDate != null" >
        start_date = #{startDate,jdbcType=DATE},
      </if>
      <if test="endDate != null" >
        end_date = #{endDate,jdbcType=DATE},
      </if>
      <if test="totalNum != null" >
        total_num = #{totalNum,jdbcType=INTEGER},
      </if>
      <if test="okNum != null" >
        ok_num = #{okNum,jdbcType=INTEGER},
      </if>
      <if test="downloadStatus != null">
        download_status = #{downloadStatus,jdbcType=INTEGER},
      </if>
      <if test="storagePath != null">
        storage_path = #{storagePath,jdbcType=VARCHAR},
      </if>
      <if test="downloadName != null">
        download_name = #{downloadName,jdbcType=VARCHAR},
      </if>
      <if test="reason != null">
        reason = #{reason,jdbcType=VARCHAR},
      </if>
    </set>
    where download_id = #{downloadId,jdbcType=INTEGER}
  </update>

  <update id="updateDownload" parameterType="com.jh.manage.download.model.DownloadParam">
    update man_download_task
    <set >
      <if test="modifyTime != null" >
        modify_time = #{modifyTime,jdbcType=DATE},
      </if>
      <if test="modifierName != null" >
        modifier_name = #{modifierName,jdbcType=VARCHAR},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=INTEGER},
      </if>
      <if test="downloadStatus != null">
        download_status = #{downloadStatus,jdbcType=INTEGER},
      </if>
    </set>
    where download_id = #{downloadId,jdbcType=INTEGER}
  </update>

  <!--
  根据条件查询下载任务
  -->
  <select id="findByParam" parameterType="com.jh.manage.download.model.DownloadParam" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from man_download_task where del_flag = '1' and data_status = '1'
      <if test="downloadStatus != null">
        and download_status = #{downloadStatus,jdbcType=INTEGER}
      </if>
    ORDER BY create_time ASC
  </select>

  <!--
  分业查询下载任务
  -->
  <select id="queryByPage" parameterType="com.jh.manage.download.model.DownloadParam" resultType="com.jh.manage.download.model.DownloadParam">
      SELECT
      c.*,
      d.china_name AS regionChinaName
      FROM
      (
      SELECT
      a.download_id AS downloadId,
      a.create_time AS createTime,
      a.creator AS creator,
      a.creator_name AS creatorName,
      a.download_name AS downloadName,
      a.region_id,
      a.start_date AS startDate,
      a.end_date AS endDate,
      a.total_num AS totalNum,
      a.ok_num AS okNum,
      a.download_status AS downloadStatus,
      a.reason AS reason,
      a.download_meta_id as satId,
      a.download_meta_value as downloadMetaValue,
      a.data_type as dataType
      FROM
      man_download_task a
      WHERE
      a.del_flag = '1'
      AND a.data_status = '1'
      <if test="satId != null"> and a.download_meta_id = #{satId,jdbcType=INTEGER}</if>
      <if test="regionId != null">AND a.region_id = #{regionId,jdbcType=INTEGER}</if>
      <if test="searchStartTime != null and searchStartTime != '' and searchEndTime != null and searchEndTime != ''">
          AND NOT (a.end_date &lt; CAST(#{searchStartTime} AS TIMESTAMP ) OR a.start_date &gt; CAST(#{searchEndTime} AS TIMESTAMP))
      </if>
      <if test="downloadStatus != null">
          AND a.download_status = #{downloadStatus,jdbcType=INTEGER}
      </if>
      <!--添加当前登录人信息查询-->
      <if test="creator != null">
          and a.creator = #{creator,jdbcType=INTEGER}
      </if>
      ORDER BY
      a.create_time DESC
      ) AS c
      LEFT JOIN init_region d ON c.region_id = d.region_id
  </select>

    <select id="findDownloadById" resultType="com.jh.manage.download.model.DownloadParam" parameterType="java.lang.Integer">
        SELECT
          a.download_id AS downloadId,
          a.create_time AS createTime,
          a.creator AS creator,
          a.creator_name AS creatorName,
          a.download_name AS downloadName,
          a.region_id as regionId,
          a.start_date AS startDate,
          a.end_date AS endDate,
          a.download_status AS downloadStatus,
          a.reason AS reason,
          a.data_type as dataType
        FROM
        man_download_task a
        WHERE
        a.download_id = #{downloadId,jdbcType=INTEGER}
    </select>
  
 <!-- <select id="findDownloadById" resultType="com.jh.manage.download.model.DownloadParam" parameterType="java.lang.Integer">
    SELECT
	e.download_name AS downloadName,
	e.reason AS reason,
	e.remark,
	e.create_time AS createTime,
	e.download_status AS downloadStatus,
	e.total_num AS totalNum,
	e.ok_num AS okNum,
	e.download_id AS downloadId,
	e.region_code AS regionCode,
	e.china_name AS regionChinaName,
	e.region_id AS regionId,
	e.sat_id AS satId,
	e.metaValue as downloadMetaValue,
	f.data_code AS dataCode,
	e.start_date AS startDate,
	e.end_date AS endDate,
	e.create_time AS createTime,
	e.creator_name AS creatorName,
	e.strip_number AS stripNumber
    FROM
	(
    SELECT
	c.*,
	d.region_code,
	d.china_name,
	d.strip_number
    FROM
	(
    SELECT
	a.download_name,
	a.reason,
	a.remark,
	a.download_status,
	a.total_num,
	a.ok_num,
	a.download_id,
	a.region_id,
	a.download_meta_id as sat_id,
	a.download_meta_value as metaValue,
	a.start_date,
	a.end_date,
	a.create_time,
	a.creator_name
    FROM
	man_download_task a
    WHERE
	a.download_id = #{downloadId,jdbcType=INTEGER}
	) c left join init_region d on c.region_id = d.region_id) e
	JOIN init_dict f ON e.sat_id = f.dict_id
  </select>-->

  <!--<select id="getEchartsDownloadData" resultType="map">-->
    <!--select-->
    <!--#{beginTime} as date,-->
    <!--c.dict_id AS id,-->
        <!--c.data_name AS NAME,-->
        <!--COALESCE ( h.VALUE,0) AS VALUE-->
    <!--from init_dict c left join-->
    <!--(select g.name, count(1) as value from-->
    <!--(select sat_id, name from (-->
    <!--select c.sat_id, (select d.data_value from init_dict d where d.parent_id = 400 and d.dict_id = c.sat_id) as name from man_download_detail d-->
    <!--left join man_download_task t-->
    <!--on d.download_id = t.download_id-->
    <!--left join man_download_config c-->
    <!--on t.download_meta_id = c.download_meta_id-->
    <!--where t.download_status = 803-->
    <!--&#45;&#45; and d.download_time-->
    <!--<if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''"  >-->
      <!--and d.download_time between cast(#{beginTime} ||' 00:00:00' as timestamp) and cast(#{endTime}||' 23:59:59' as timestamp)-->
    <!--</if>-->
    <!--) as f where f.name in ('GF1', 'GF2', 'GF3', 'GF4')) g group by g.name) h-->
    <!--ON h.NAME = c.data_name-->
        <!--WHERE-->
        <!--c.del_flag = '1'-->
        <!--AND c.data_status = '1'-->
        <!--AND c.parent_id = 400-->
            <!--AND c.data_value in ('GF1', 'GF2', 'GF3', 'GF4')-->
        <!--ORDER BY-->
        <!--c.order_no-->
  <!--</select>-->



  <select id="getEchartsDownloadData" resultType="map">
      SELECT
          #{beginTime} AS DATE,
          A.dict_id AS ID,
          A.data_value AS NAME,
          COALESCE ( B.VALUE, 0 ) AS
      VALUE

      FROM
          (
          SELECT
              dic.dict_id,
              dic.data_value
          FROM
              init_dict dic
          WHERE
          dic.data_code IN ( 'GF1', 'GF2', 'GF3', 'GF4' ))
          A LEFT JOIN (
          SELECT
              dic.dict_id AS ID,
              s.satellite AS NAME,
              COUNT ( * ) AS
          VALUE

          FROM
              man_order_detail d,
              man_order_task T,
              data_storage s,
              init_dict dic
          WHERE
              T.data_status = '1'
              AND T.del_flag = '1'
              AND T.audit_status = 1104
              <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''"  >
                AND T.audit_time BETWEEN CAST ( #{beginTime} || ' 00:00:00' AS TIMESTAMP )
                AND CAST ( #{endTime} || ' 23:59:59' AS TIMESTAMP )
              </if>
              AND d.order_id = T.order_id
              AND d.storage_id = s.storage_id
              AND s.satellite IN ( 'GF1', 'GF2', 'GF3', 'GF4' )
              AND s.satellite = dic.data_code
          GROUP BY
              ID,
      NAME
          ) B ON A.dict_id = B.ID
  </select>

  
  <select id="queryDownloadEchartsTotal" resultType="int">
      SELECT COUNT
          ( 0 )
      FROM
          man_order_detail d,
          man_order_task T,
          data_storage s
      WHERE
          T.data_status = '1'
          AND T.del_flag = '1'
          AND T.audit_status = 1104
          AND d.order_id = T.order_id
          AND d.storage_id = s.storage_id
          AND s.satellite IN (
              'GF1',
              'GF2',
              'GF3',
              'GF4'
          )
  </select>
</mapper>