<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jh.manage.loader.mapping.IDataLoaderMapper" >
  <resultMap id="BaseResultMap" type="com.jh.manage.loader.entity.DataLoader" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="loader_id" property="loaderId" jdbcType="INTEGER" />
    <result column="data_status" property="dataStatus" jdbcType="CHAR" />
    <result column="del_flag" property="delFlag" jdbcType="CHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
    <result column="creator" property="creator" jdbcType="INTEGER" />
    <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
    <result column="modifier_name" property="modifierName" jdbcType="VARCHAR" />
    <result column="modifier" property="modifier" jdbcType="INTEGER" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="loader_name" property="loaderName" jdbcType="VARCHAR" />
    <result column="total_num" property="totalNum" jdbcType="INTEGER" />
    <result column="ok_num" property="okNum" jdbcType="INTEGER" />
    <result column="loader_type" property="loaderType" jdbcType="INTEGER" />
    <result column="data_storage_path" property="dataStoragePath" jdbcType="VARCHAR" />
    <result column="storage_type" property="storageType" jdbcType="INTEGER" />
    <result column="loader_status" property="loaderStatus" jdbcType="INTEGER" />
    <result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="reason" property="reason" jdbcType="VARCHAR" />

  </resultMap>

  <resultMap id="LoaderDetailResult" type="com.jh.manage.loader.entity.DataLoaderDetail">
    <id column="loader_detail_id" property="loaderDetailId" jdbcType="INTEGER" />
    <result column="loader_id" property="loaderId" jdbcType="INTEGER" />
    <result column="file_name" property="fileName" jdbcType="VARCHAR" />
    <result column="file_size" property="fileSize" jdbcType="VARCHAR" />
    <result column="file_path" property="filePath" jdbcType="VARCHAR" />
    <result column="loader_status" property="loaderStatus" jdbcType="INTEGER" />
    <result column="storage_id" property="storageId" jdbcType="INTEGER" />
    <result column="reason" property="reason" jdbcType="VARCHAR" />
  </resultMap>

  <sql id="Base_Column_List" >
    loader_id, data_status, del_flag, create_time, creator_name, creator, modify_time,
    modifier_name, modifier, remark, total_num, ok_num, loader_type, data_storage_path, 
    storage_type,loader_status,loader_name,reason,end_time
  </sql>

  <!--入库明细字段-->
  <sql id="Detail_Column_list">
    loader_detail_id, loader_id, file_name, file_size,file_path,loader_status,storage_id,reason
  </sql>

  <select id="findByPage" parameterType="LoaderParam" resultMap="BaseResultMap" >
    select
    <include refid="Base_Column_List" />
    from man_loader_task where del_flag = '1'
    <if test="loaderType != null and loaderType != ''">
      and loader_type = #{loaderType,jdbcType=INTEGER}
    </if>
    <if test="loaderStatus != null and loaderStatus != ''">
      and loader_status =#{loaderStatus,jdbcType=INTEGER}
    </if>
    <if test="creatorName != null and creatorName != ''">
      and creator_name like '%' ||#{creatorName,jdbcType=VARCHAR} || '%'
    </if>
    <if test="loaderName != null and loaderName != ''">
      and loader_name like '%' ||#{loaderName,jdbcType=VARCHAR} || '%'
    </if>
    <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''">
     and create_time BETWEEN cast(#{beginTime} || ' 00:00:00' as timestamp) and cast(#{endTime} || ' 23:59:59' as timestamp)
    </if>
    <!--添加当前登录人信息查询-->
    <if test="creator != null">
      and creator = #{creator,jdbcType=INTEGER}
    </if>
    ORDER BY
    <choose>
      <when test="sidx != null and sidx != ''">
        ${sidx} ${sord}
      </when>
      <otherwise>
        loader_status, create_time DESC
      </otherwise>
    </choose>

  </select>

  <!--根据任务ID获取入库信息-->
  <select id="getById" parameterType="Integer" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from man_loader_task where del_flag = '1' and loader_id = #{loaderId,jdbcType=INTEGER}
  </select>

  <!--保存入库任务-->
  <insert id="save" parameterType="DataLoader">
    insert into man_loader_task
    <trim prefix="(" suffix=")" suffixOverrides="," >
        create_time,
      <if test="creatorName != null and creatorName != ''" >
        creator_name,
      </if>
      <if test="creator != null" >
        creator,
      </if>
      <if test="remark != null and remark != ''" >
        remark,
      </if>
      <if test="totalNum != null" >
        total_num,
      </if>
      <if test="okNum != null" >
        ok_num,
      </if>
      <if test="loaderType != null" >
        loader_type,
      </if>
      <if test="dataStoragePath != null and dataStoragePath != ''" >
        data_storage_path,
      </if>
      <if test="storageType != null" >
        storage_type,
      </if>
      <if test="loaderStatus != null" >
        loader_status,
      </if>
      <if test="startTime != null" >
        start_time,
      </if>
      <if test="endTime != null" >
        end_time,
      </if>
      <if test="loaderName != null" >
        loader_name,
      </if>
      <if test="reason != null and reason != ''" >
        reason,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
       now(),
      <if test="creatorName != null and creatorName != ''" >
        #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=INTEGER},
      </if>
      <if test="remark != null and remark != ''" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="totalNum != null" >
        #{totalNum,jdbcType=INTEGER},
      </if>
      <if test="okNum != null" >
        #{okNum,jdbcType=INTEGER},
      </if>
      <if test="loaderType != null" >
        #{loaderType,jdbcType=INTEGER},
      </if>
      <if test="dataStoragePath != null and dataStoragePath != ''" >
        #{dataStoragePath,jdbcType=VARCHAR},
      </if>
      <if test="storageType != null" >
        #{storageType,jdbcType=INTEGER},
      </if>
      <if test="loaderStatus != null" >
        #{loaderStatus,jdbcType=INTEGER},
      </if>
      <if test="startTime != null" >
        #{startTime,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        #{endTime,jdbcType=TIMESTAMP},
      </if>
      <if test="loaderName != null and loaderName != ''" >
        #{loaderName,jdbcType=VARCHAR},
      </if>
      <if test="reason != null and reason != ''" >
        #{reason,jdbcType=VARCHAR},
      </if>
    </trim>

  </insert>

  <!--根据入库任务ID查询入库明细-->
  <select id="findDataLoaderDetailById" parameterType="Integer" resultMap="LoaderDetailResult">
    select <include refid="Detail_Column_list" />
    from man_loader_detail where loader_id = #{loaderId,jdbcType=INTEGER}
  </select>

  <!--更新入库状态-->
  <update id="updateStatus" parameterType="DataLoader">
    update  man_loader_task
    <set >
      <if test="loaderStatus != null" >  loader_status = #{loaderStatus,jdbcType=INTEGER}, </if>
      modify_time = now(),
      <if test="modifierName != null" >  modifier_name = #{modifierName,jdbcType=VARCHAR}, </if>
      <if test="modifier != null" >  modifier = #{modifier,jdbcType=INTEGER}, </if>
      reason = '',
    </set>
    where loader_id = #{loaderId,jdbcType=INTEGER}
  </update>

  <!--保存明细-->
  <insert id="saveOrderDetail" parameterType="List">
    insert into man_loader_task(loader_id,storage_id,product_name,product_size)
    values
    <foreach collection="list" item="item" index="index" separator=",">
      (#{item.loaderId,jdbcType=INTEGER},
      #{item.storageId,jdbcType=INTEGER},
      #{item.productName,jdbcType=VARCHAR},
      #{item.productSize,jdbcType=VARCHAR}
      )
    </foreach>
  </insert>



  <select id="queryLoaderSateSumEcharts" parameterType="LoaderParam" resultType="map">
    SELECT
    c.dict_id AS id,
    c.data_name AS NAME,
    g.VALUE AS VALUE
    FROM
    (
    SELECT
    f.satellite AS NAME,
    count( 1 ) AS VALUE
    FROM
    (
    SELECT DISTINCT
    b.satellite,
    a.storage_id
    FROM
    man_loader_detail a LEFT JOIN man_loader_task t on a.loader_id = t.loader_id
    LEFT JOIN data_storage b ON a.storage_id = b.storage_id
    WHERE
    a.loader_status = 903
    AND a.storage_id IS NOT NULL
    <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''"  >
      and t.end_time between cast(#{beginTime} ||' 00:00:00' as timestamp) and cast(#{endTime}||' 23:59:59' as timestamp)
    </if>
    ) f
    GROUP BY
    f.satellite
    ) g
    LEFT JOIN init_dict c ON g.NAME = c.data_name
    WHERE
    c.del_flag = '1'
    AND c.data_status = '1'
    AND c.parent_id = 400
    ORDER BY
    c.order_no
  </select>

  <select id="queryLoaderSateSumTableEcharts" parameterType="LoaderParam" resultType="map">
    SELECT
    c.dict_id AS id,
    c.data_name AS NAME,
    COALESCE ( g.VALUE,0) AS VALUE
    FROM
    init_dict c LEFT JOIN
    (
    SELECT
    f.satellite AS NAME,
    count( 1 ) AS VALUE
    FROM
    (
    SELECT DISTINCT
    b.satellite,
    a.storage_id
    FROM
    man_loader_detail a LEFT JOIN man_loader_task t on a.loader_id = t.loader_id
    LEFT JOIN data_storage b ON a.storage_id = b.storage_id
    WHERE
    a.loader_status = 903
    AND a.storage_id IS NOT NULL
    <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''"  >
      and t.end_time between cast(#{beginTime} ||' 00:00:00' as timestamp) and cast(#{endTime}||' 23:59:59' as timestamp)
    </if>
    ) f
    GROUP BY
    f.satellite
    ) g
    ON g.NAME = c.data_name
    WHERE
    c.del_flag = '1'
    AND c.data_status = '1'
    AND c.parent_id = 400
    ORDER BY
    c.order_no
  </select>

  <select id="queryLoaderEcharts" parameterType="LoaderParam" resultType="map">
    SELECT
    #{beginTime} as date,
    c.dict_id AS id,
    c.data_name AS NAME,
    COALESCE ( g.VALUE,0) AS VALUE
    FROM
    init_dict c LEFT JOIN
    (
    SELECT
    f.satellite AS NAME,
    count( 1 ) AS VALUE
    FROM
    (
    SELECT DISTINCT
    b.satellite,
    a.storage_id
    FROM
    man_loader_detail a LEFT JOIN man_loader_task t on a.loader_id = t.loader_id
    LEFT JOIN data_storage b ON a.storage_id = b.storage_id
    WHERE
    a.loader_status = 903
    AND a.storage_id IS NOT NULL
    AND b.satellite in ('GF1', 'GF2', 'GF3', 'GF4')
    <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''"  >
      and t.end_time between cast(#{beginTime} ||' 00:00:00' as timestamp) and cast(#{endTime}||' 23:59:59' as timestamp)
    </if>
    ) f
    GROUP BY
    f.satellite
    ) g
    ON g.NAME = c.data_name
    WHERE
    c.del_flag = '1'
    AND c.data_status = '1'
    AND c.parent_id = 400
    AND c.data_value in ('GF1', 'GF2', 'GF3', 'GF4')
    ORDER BY
    c.order_no
  </select>
  
  <select id="queryLoaderEchartsTotal" resultType="int">
    SELECT COUNT(1) FROM
      (SELECT DISTINCT
      b.satellite,
      a.storage_id
      FROM
      man_loader_detail a LEFT JOIN man_loader_task t on a.loader_id = t.loader_id
      LEFT JOIN data_storage b ON a.storage_id = b.storage_id
      WHERE
      a.loader_status = 903
      AND a.storage_id IS NOT NULL
      AND b.satellite in ('GF1', 'GF2', 'GF3', 'GF4')) as q
  </select>

</mapper>