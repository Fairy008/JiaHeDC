<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jh.forum.bbs.mapping.IForumDownloadDataMapper" >
  <resultMap id="BaseResultMap" type="com.jh.forum.bbs.entity.ForumDownloadData" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="data_id" property="dataId" jdbcType="INTEGER" />
    <result column="data_status" property="dataStatus" jdbcType="CHAR" />
    <result column="del_flag" property="delFlag" jdbcType="CHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
    <result column="creator" property="creator" jdbcType="INTEGER" />
    <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
    <result column="modifier_name" property="modifierName" jdbcType="VARCHAR" />
    <result column="modifier" property="modifier" jdbcType="INTEGER" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="region_id" property="regionId" jdbcType="BIGINT" />
    <result column="region_code" property="regionCode" jdbcType="VARCHAR" />
    <result column="crop_id" property="cropId" jdbcType="INTEGER" />
    <result column="push_status" property="pushStatus" jdbcType="INTEGER" />
    <result column="accuracy" property="accuracy" jdbcType="INTEGER" />
    <result column="data_classify" property="dataClassify" jdbcType="INTEGER" />
    <result column="data_time" property="dataTime" jdbcType="DATE" />
    <result column="data_path" property="dataPath" jdbcType="VARCHAR" />
    <result column="data_flag" property="dataFlag" jdbcType="INTEGER" />
    <result column="data_introduction" property="dataIntroduction" jdbcType="VARCHAR" />
    <result column="data_content" property="dataContent" jdbcType="VARCHAR" />
    <result column="data_title" property="dataTitle" jdbcType="VARCHAR" />
    <result column="sonType" property="sonType" jdbcType="VARCHAR" />
    <result column="parentType" property="parentType" jdbcType="VARCHAR" />
    <result column="price" property="price" jdbcType="NUMERIC" />
    <result column="data_type" property="dataType" jdbcType="VARCHAR" />
    <result column="download_num" property="downloadNum" jdbcType="INTEGER" />
    <result column="collect_num" property="collectNum" jdbcType="INTEGER" />
    <result column="data_package_path" property="dataPackagePath" jdbcType="VARCHAR" />
  </resultMap>

  <!--BaseResultVoMap-->
  <resultMap id="BaseResultVoMap" type="com.jh.forum.bbs.vo.DownloadDataVo"  extends="BaseResultMap">

  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    data_id, data_status, del_flag, create_time, creator_name, creator, modify_time,
    modifier_name, modifier, remark, region_id, crop_id, accuracy, data_classify, data_time,
    data_path, data_flag, data_introduction, data_content,data_title,region_code,push_status,price,data_type,download_num,collect_num
  </sql>


  <select id="getListByCombination" resultMap="BaseResultVoMap">

    select
    data_id,create_time, creator_name,region_id,crop_id, accuracy, data_classify, data_time,
    data_path, data_flag, data_introduction, data_content,data_title,push_status
    from forum_download_data where del_flag = '1' and data_status = '1' and data_type is not null and data_type != '4'

    <!--<if test="regionId != null">-->
      <!--and region_id = #{regionId,jdbcType=BIGINT}-->
    <!--</if>-->

    <if test="regionCode != null">
      and region_code like #{regionCode,jdbcType=VARCHAR}  ||'%'
    </if>

    <if test="cropId != null">
      and crop_id = #{cropId,jdbcType=INTEGER}
    </if>
<!--    <if test="accuracyBegin !=null ">-->
<!--      <![CDATA[ and accuracy >= #{accuracyBegin,jdbcType=INTEGER} ]]>-->
<!--    </if>-->
<!--    <if test="accuracyEnd !=null ">-->
<!--      <![CDATA[ and accuracy < #{accuracyEnd,jdbcType=INTEGER} ]]>-->
<!--    </if>-->
     <if test="accuracy!=null">
       and accuracy=#{accuracy,jdbcType=INTEGER}
     </if>
     <if test="fileList != null and fileList.size() > 0 ">
        and accuracy in
       <foreach item="item" index="index" collection="fileList" open="(" separator="," close=")">
            #{item}
       </foreach>
     </if>

    <if test="startDate != null">
      <![CDATA[ and data_time >= #{startDate,jdbcType=DATE} ]]>
    </if>
    <if test="endDate != null">
      <![CDATA[ and data_time <= #{endDate,jdbcType=DATE} ]]>
    </if>

    <if test="dataClassify != null and dataClassify != ''">
      and data_classify = #{dataClassify,jdbcType=INTEGER}
    </if>


    <if test="pushStatus != null">
      and push_status = #{pushStatus,jdbcType=INTEGER}
    </if>

      <if test="creatorName != null and creatorName != ''" >
          and creator_name like '%' || #{creatorName,jdbcType=VARCHAR} || '%'
      </if>

      <if test="dataTitle != null and dataTitle != ''" >
          and data_title like '%' || #{dataTitle,jdbcType=VARCHAR} || '%'
      </if>
    order by push_status,create_time desc

  </select>


  <select id="findHotDataList" parameterType="com.jh.forum.bbs.vo.DownloadDataVo" resultMap="BaseResultVoMap">
    select data_id, data_title from forum_download_data where del_flag = '1' and data_status = '1'
    <if test="dataTime != null">
      and create_time >= #{dataTime,jdbcType=DATE}
    </if>
  </select>

  <select id="findAgriculturalData" parameterType="com.jh.forum.bbs.vo.DownloadDataVo" resultMap="BaseResultVoMap">
      SELECT
      A.data_id,
      A.data_status,
      A.del_flag,
      A.create_time,
      A.creator_name,
      A.creator,
      A.modify_time,
      A.modifier_name,
      A.modifier,
      A.remark,
      A.region_id,
      A.crop_id,
      A.accuracy,
      A.data_classify,
      A.data_time,
      A.data_path,
      A.data_flag,
      A.data_introduction,
      A.data_content,
      A.data_title,
      A.region_code,
      A.push_status,
      A.collect_num,
      A.download_num,
      b.data_name as sonType,
      c.data_name as parentType
      FROM
      forum_download_data A
      LEFT JOIN init_dict b ON A.data_classify = b.dict_id
      left join init_dict c on b.parent_id = c.dict_id
      left JOIN init_dict d on a.accuracy = d.dict_id
      WHERE
      A.del_flag = '1'
      AND A.data_status = '1'
      AND A.data_type != '4'
      AND A.push_status = 12004
    /*关键词搜索*/
    <if test="keyWords!=null and keyWords !=''">
      AND data_title like CONCAT('%','${keyWords}','%')
    </if>
      /*类别  作物  区域  精度  时间*/
    <if test="dataClassify != null">
      and (data_classify = #{dataClassify,jdbcType=INTEGER} or b.parent_id = #{dataClassify,jdbcType=INTEGER})
    </if>
    <if test="cropId != null and cropId != ''">
      and crop_id = #{cropId,jdbcType=INTEGER}
    </if>
   <!-- <if test="regionId != null and regionId != ''">
      and region_id = #{regionId,jdbcType=INTEGER}
    </if>-->
    <if test="regionCode != null">
      AND region_code like #{regionCode,jdbcType=VARCHAR}  ||'%'
    </if>
    <if test="dictId != null and dictId != ''">
      and accuracy = #{dictId,jdbcType=INTEGER}
    </if>

    <if test="startDate != null ">
      and  data_time &gt;= #{startDate}
    </if>
    <if test="endDate !=null ">
      and   data_time &lt;= #{endDate}
    </if>
      ORDER BY
    a.recommend,
    a.create_time DESC
    <if test="checkNum != null and checkNum != ''">
      LIMIT #{checkNum}
    </if>
  </select>

  <select id="confirmationOfOrder" resultMap="BaseResultVoMap" parameterType="java.util.List">
    SELECT
        data_id,
        data_status,
        del_flag,
        create_time,
        creator_name,
        creator,
        modify_time,
        modifier_name,
        modifier,
        remark,
        region_id,
        region_code,
        crop_id,
        accuracy,
        data_classify,
        data_time,
        data_path,
        data_flag,
        data_title,
        data_introduction,
        data_content,
        push_status,
        recommend,
        price,
        data_package_path
    FROM
        forum_download_data
    where data_id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
          #{item}
        </foreach>
  </select>

  <select id="totalPriceForOrder" parameterType="java.util.List" resultType="java.math.BigDecimal">
    SELECT
      sum(a.price)
    FROM
    forum_download_data a left join init_dict b on a.accuracy = b.dict_id
    where data_id in
    <foreach collection="list" item="item" open="(" separator="," close=")">
      #{item}
    </foreach>
  </select>

  <select id="getById" resultMap="BaseResultVoMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
      SELECT
      a.data_id,
      a.data_status,
      a.del_flag,
      a.create_time,
      a.creator_name,
      a.creator,
      a.modify_time,
      a.modifier_name,
      a.modifier,
      a.remark,
      a.region_id,
      a.crop_id,
      a.accuracy,
      a.data_classify,
      a.data_time,
      a.data_path,
      a.data_flag,
      a.data_introduction,
      a.data_content,
      a.data_title,
      a.region_code,
      a.push_status,
      a.price
      FROM
      forum_download_data  a
      WHERE
      data_id = #{ dataId,jdbcType = INTEGER}
  </select>

  <select id="getSimilarData" parameterType="Integer" resultMap="BaseResultVoMap">
    SELECT
      a.data_id,
      a.data_status,
      a.del_flag,
      a.create_time,
      a.creator_name,
      a.creator,
      a.modify_time,
      a.modifier_name,
      a.modifier,
      a.remark,
      a.region_id,
      a.crop_id,
      a.accuracy,
      a.data_classify,
      a.data_time,
      a.data_path,
      a.data_flag,
      a.data_introduction,
      a.data_content,
      a.data_title,
      a.region_code,
      a.push_status,
      a.price ,
      b.data_name as accuracyName
      FROM
      forum_download_data  a  left join init_dict b on a.accuracy = b.dict_id
      WHERE a.data_type = '1' AND A.push_status = 12004 and
      data_classify = #{classify,jdbcType = INTEGER}
      limit 4
  </select>

  <select id="findById" resultMap="BaseResultVoMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <include refid="Base_Column_List" />
    from forum_download_data
    where data_id = #{dataId,jdbcType=INTEGER}
  </select>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from forum_download_data
    where data_id = #{dataId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.jh.forum.bbs.entity.ForumDownloadData" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into forum_download_data (data_id, data_status, del_flag, 
      create_time, creator_name, creator, 
      modify_time, modifier_name, modifier, 
      remark, region_id, crop_id, 
      accuracy, data_classify, data_time, 
      data_path, data_flag, data_introduction, 
      data_content)
    values (#{dataId,jdbcType=INTEGER}, #{dataStatus,jdbcType=CHAR}, #{delFlag,jdbcType=CHAR}, 
      #{createTime,jdbcType=TIMESTAMP}, #{creatorName,jdbcType=VARCHAR}, #{creator,jdbcType=INTEGER},
      #{modifyTime,jdbcType=TIMESTAMP}, #{modifierName,jdbcType=VARCHAR}, #{modifier,jdbcType=INTEGER},
      #{remark,jdbcType=VARCHAR}, #{regionId,jdbcType=BIGINT}, #{cropId,jdbcType=INTEGER}, 
      #{accuracy,jdbcType=INTEGER}, #{dataClassify,jdbcType=INTEGER}, #{dataTime,jdbcType=DATE}, 
      #{dataPath,jdbcType=VARCHAR}, #{dataFlag,jdbcType=INTEGER}, #{dataIntroduction,jdbcType=VARCHAR}, 
      #{dataContent,jdbcType=VARCHAR})
  </insert>
  <insert id="save" parameterType="com.jh.forum.bbs.entity.ForumDownloadData" useGeneratedKeys="true" keyProperty="dataId">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into forum_download_data
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="dataId != null" >
        data_id,
      </if>
      <if test="dataStatus != null" >
        data_status,
      </if>
      <if test="delFlag != null" >
        del_flag,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="creatorName != null" >
        creator_name,
      </if>
      <if test="creator != null" >
        creator,
      </if>
      <if test="modifyTime != null" >
        modify_time,
      </if>
      <if test="modifierName != null" >
        modifier_name,
      </if>
      <if test="modifier != null" >
        modifier,
      </if>
      <if test="remark != null" >
        remark,
      </if>
      <if test="regionId != null" >
        region_id,
      </if>
      <if test="regionCode != null">
        region_code,
      </if>

      <if test="cropId != null" >
        crop_id,
      </if>
      <if test="accuracy != null" >
        accuracy,
      </if>
      <if test="dataClassify != null" >
        data_classify,
      </if>
      <if test="dataTime != null" >
        data_time,
      </if>
      <if test="dataPath != null" >
        data_path,
      </if>
      <if test="dataFlag != null" >
        data_flag,
      </if>
      <if test="dataIntroduction != null" >
        data_introduction,
      </if>
      <if test="dataContent != null" >
        data_content,
      </if>
      <if test="dataTitle != null" >
        data_title,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="dataId != null" >
        #{dataId,jdbcType=INTEGER},
      </if>
      <if test="dataStatus != null" >
        #{dataStatus,jdbcType=CHAR},
      </if>
      <if test="delFlag != null" >
        #{delFlag,jdbcType=CHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="creatorName != null" >
        #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=INTEGER},
      </if>
      <if test="modifyTime != null" >
        #{modifyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="modifierName != null" >
        #{modifierName,jdbcType=VARCHAR},
      </if>
      <if test="modifier != null" >
        #{modifier,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="regionId != null" >
        #{regionId,jdbcType=BIGINT},
      </if>
      <if test="regionCode != null">
        #{regionCode,jdbcType=VARCHAR},
      </if>

      <if test="cropId != null" >
        #{cropId,jdbcType=INTEGER},
      </if>
      <if test="accuracy != null" >
        #{accuracy,jdbcType=INTEGER},
      </if>
      <if test="dataClassify != null" >
        #{dataClassify,jdbcType=INTEGER},
      </if>
      <if test="dataTime != null" >
        #{dataTime,jdbcType=DATE},
      </if>
      <if test="dataPath != null" >
        #{dataPath,jdbcType=VARCHAR},
      </if>
      <if test="dataFlag != null" >
        #{dataFlag,jdbcType=INTEGER},
      </if>
      <if test="dataIntroduction != null" >
        #{dataIntroduction,jdbcType=VARCHAR},
      </if>
      <if test="dataContent != null" >
        #{dataContent,jdbcType=VARCHAR},
      </if>
      <if test="dataTitle != null" >
        #{dataTitle,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateDownloadData" parameterType="DownloadDataVo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update forum_download_data
    <set >
      <if test="dataStatus != null" >
        data_status = #{dataStatus,jdbcType=CHAR},
      </if>
      <if test="delFlag != null" >
        del_flag = #{delFlag,jdbcType=CHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="creatorName != null" >
        creator_name = #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=INTEGER},
      </if>
      <if test="modifyTime != null" >
        modify_time = #{modifyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="modifierName != null" >
        modifier_name = #{modifierName,jdbcType=VARCHAR},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="regionId != null" >
        region_id = #{regionId,jdbcType=BIGINT},
      </if>
      <if test="regionCode != null" >
        region_code = #{regionCode,jdbcType=VARCHAR},
      </if>
      <if test="cropId != null" >
        crop_id = #{cropId,jdbcType=INTEGER},
      </if>
      <if test="accuracy != null" >
        accuracy = #{accuracy,jdbcType=INTEGER},
      </if>
      <if test="dataClassify != null" >
        data_classify = #{dataClassify,jdbcType=INTEGER},
      </if>
      <if test="dataTime != null" >
        data_time = #{dataTime,jdbcType=DATE},
      </if>
      <if test="dataPath != null" >
        data_path = #{dataPath,jdbcType=VARCHAR},
      </if>
      <if test="dataFlag != null" >
        data_flag = #{dataFlag,jdbcType=INTEGER},
      </if>
      <if test="dataIntroduction != null" >
        data_introduction = #{dataIntroduction,jdbcType=VARCHAR},
      </if>
      <if test="dataContent != null" >
        data_content = #{dataContent,jdbcType=VARCHAR},
      </if>
      <if test="dataTitle != null">
        data_title = #{dataTitle,jdbcType=VARCHAR},
      </if>
      <if test="pushStatus != null">
        push_status = #{pushStatus ,jdbcType=INTEGER},
      </if>
      <if test="price != null">
        price = #{price ,jdbcType=NUMERIC},
      </if>
    </set>
    where 1 = 1
    <if test="dataId != null">
      and data_id = #{dataId,jdbcType=INTEGER}
    </if>
    <if test="dataIds!=null">
      and data_id in
      <foreach collection="dataIds" item="id" separator="," open="(" close=")">
        #{id}
      </foreach>
    </if>
  </update>
  <update id="updateByPrimaryKey" parameterType="com.jh.forum.bbs.entity.ForumDownloadData" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update forum_download_data
    set data_status = #{dataStatus,jdbcType=CHAR},
      del_flag = #{delFlag,jdbcType=CHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      creator_name = #{creatorName,jdbcType=VARCHAR},
      creator = #{creator,jdbcType=INTEGER},
      modify_time = #{modifyTime,jdbcType=TIMESTAMP},
      modifier_name = #{modifierName,jdbcType=VARCHAR},
      modifier = #{modifier,jdbcType=INTEGER},
      remark = #{remark,jdbcType=VARCHAR},
      region_id = #{regionId,jdbcType=BIGINT},
      crop_id = #{cropId,jdbcType=INTEGER},
      accuracy = #{accuracy,jdbcType=INTEGER},
      data_classify = #{dataClassify,jdbcType=INTEGER},
      data_time = #{dataTime,jdbcType=DATE},
      data_path = #{dataPath,jdbcType=VARCHAR},
      data_flag = #{dataFlag,jdbcType=INTEGER},
      data_introduction = #{dataIntroduction,jdbcType=VARCHAR},
      data_content = #{dataContent,jdbcType=VARCHAR}
    where data_id = #{dataId,jdbcType=INTEGER}
  </update>

    <select id="downloadExample" resultType="com.jh.forum.bbs.vo.DownloadDataVo">
        select
        <include refid="Base_Column_List" />
        from forum_download_data
        where data_id = #{dataId,jdbcType=INTEGER}
    </select>

    <select id="freeDownloadData" resultType="com.jh.forum.bbs.vo.DownloadDataVo">
        select
        <include refid="Base_Column_List" />
        from forum_download_data
        where data_id = #{dataId,jdbcType=INTEGER}
    </select>
  
  <update id="downloadStatistc" parameterType="java.lang.Integer">
      update forum_download_data set download_num = download_num+1 where data_id = #{dataId,jdbcType=INTEGER}
  </update>

  <update id="collectStatistc" parameterType="java.lang.Integer">
    update forum_download_data set collect_num = collect_num+1 where data_id = #{dataId,jdbcType=INTEGER}
  </update>

  <update id="cancelCollectStatistic" parameterType="java.lang.Integer">
    update forum_download_data set collect_num = collect_num-1 where data_id = #{dataId,jdbcType=INTEGER}
  </update>

  <!--更新下载量和收藏量-->
  <update id="updateNum">
    UPDATE forum_download_data
    SET download_num = ( download_num + random() * 10 ),
    collect_num = ( collect_num + random() * 10 );
  </update>

  <update id="calculateForOne" parameterType="java.util.List">
  UPDATE forum_download_data
    SET price = 1
    WHERE push_status = 12002 and  data_classify in
    <foreach collection="list" item="item" open="(" separator="," close=")">
      #{item}
    </foreach>
  </update>

  <update id="calculateForTen" parameterType="java.util.List">
    UPDATE forum_download_data
    SET price = 10
    WHERE push_status = 12002 and data_classify in
    <foreach collection="list" item="item" open="(" separator="," close=")">
      #{item}
    </foreach>
  </update>

</mapper>