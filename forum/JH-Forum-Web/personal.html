<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link type="text/css" rel="stylesheet" href="css/base.css"/>
    <style>
        body{background-color: #f4f4f4;}

        html{overflow-y: scroll;}
        :root {overflow-x: hidden;overflow-y: auto}
        :root body {position: absolute;}
        body {width: 100vw;overflow: hidden;}
        :root .rightTop {position: absolute;}

        .content2{ width: 993px;margin:0 auto;}
        /*.content2 .rightMain{overflow: scroll;}*/
        /*左侧轮播*/
        .content2 .conMain2{ width: 755px; float: right; border-radius:5px;min-height:743px;}

        .rightMain{width: 220px;float:left;text-align: center;margin-bottom:20px;}
        .rightMain .personDiv{width: 220px;height:206px;float:left;background-color: #ffffff;text-align: center;padding-bottom:36px;border-radius:5px;margin-top: 35px}
        .rightMain .personDiv img{width: 70px;height: 70px;border-radius: 50%;margin-top: 32px;cursor: pointer;}

        #p_userName{display: block;font-size: 18px;margin-top: 17px;font-size: 18px;font-weight: bold;width: 100%;}
        #p_introduction{display: block;font-size: 12px;text-indent: 5px;  color: #7c7c7c;    margin: 15px 5px 0px 5px;text-align: center;line-height:18px;}

        .rightMain .menuDiv{width: 220px;height: 580px;background-color: #ffffff;font-size: 14px;margin-top:18px;border-radius:5px;}
        /*.menuDiv dt{display: table-cell;vertical-align: middle;}*/
        .rightMain .menuDiv dt:not(:last-child){border-bottom:1px solid #EEEEEE;}
        .rightMain .menuDiv dt p{text-align: left;padding-left: 31px;line-height: 35px;cursor: pointer;}
        .rightMain .menuDiv dt p.on{border-left: 4px solid #007bc3}

        .rightMain .myTask{height: 94px;}
        .rightMain .myFollow{height: 94px;}
        /*.rightMain .myArticle{height: 200px;}*/
        .rightMain .myAccount{height: 94px;}

        .rightMain .myTask div{
            height: 47px;
            display: flex;align-items:center
        }

        .rightMain .myFollow div{
            height: 47px;
            display: flex;align-items:center
        }

        .rightMain .myArticle div{
            height: 47px;
            display: flex;align-items:center
        }

        .rightMain .myAccount div{
            height: 47px;
            display: flex;align-items:center
        }
        #listTitle{font-size: 30px;margin-bottom: 30px;}

        /*农业*/
        span.lab.agriculture{ background: #65d763;}
        /*气象*/
        span.lab.meteorology{ background: #00a5da;}
        /*遥感*/
        span.lab.remotesensing{ background: #daa900;}
        /*期货*/
        span.lab.futures{ background: #dbab00;}
        /*保险*/
        span.lab.insurance{ background: #0c6e86;}

        .viewType{text-overflow: ellipsis;white-space:nowrap;overflow: hidden;width:165px;}

        .viewTypeName{text-overflow: ellipsis;white-space:nowrap;overflow: inherit;width:165px;}


       .personal_body{
           height:100%;
           min-height: 500px;
           background-color: #ededed;
           margin-top: 200px;
       }
    </style>
    <title></title>
</head>
<body>

<div  class="personal_body">
    <div class="content2">
        <div class="rightMain">
            <!--专家个人信息-->
            <div class="personDiv">
                <img id="p_photoUrl" src="images/public/forum/userImg.png" title="更换头像" onclick="path.click()">
                <a id="p_userName" class="viewTypeName"></a>
                <a id="p_accountId" hidden="hidden"></a>
                <a id="p_introduction" >简介：暂无</a>
                <div style="margin-top: 10px;">
                    <span id="p_industry"></span>
                </div>
                <input type="text" size="20" name="upfile" id="upfile" style="display:none" disabled="true">
                <!--<input type="button" class="button_style" value="修改头像" onclick="path.click()" >-->
                <input type="file" name="path" id="path" style="display:none" accept="image/gif,image/jpeg,image/png">
            </div>
            <div style="clear:both" ></div>
            <!--左侧底部侧边栏-->
            <div class="menuDiv">
                <dl>
                    <dt class="shoppingCar">
                        <div>
                            <p class="on" url="shoppingCar.html">我的购物车</p>
                        </div>
                        <div>
                             <p class="myOrder_href" url="myOrder.html">我的订单</p>
                        </div>
                        <div>
                            <p class="shoppingCollection_url" url="shoppingCollection.html">商品收藏</p>
                        </div>
                    </dt>
                    <dt class="myTask">
                        <div>
                            <p  url="module/personal/myCollectionTask.html">我的任务</p>
                        </div>
                        <div>
                            <p url="module/personal/myTemplate.html">我的模板</p>
                        </div>
                    </dt>
                    <dt class="myFollow">
                        <div>
                            <p url="module/personal/myFollowPersonList.html">我的关注</p>
                        </div>
                        <div>
                            <p url="module/personal/myFollowArticleList.html">我的收藏</p>
                        </div>
                    </dt>
                    <dt class="myArticle">
                        <div>
                            <p url="module/personal/myArticleList.html" articleType="11001">我的报告</p>
                        </div>
                        <!--<div>-->
                            <!--<p url="module/personal/myArticleList.html" articleType="11004">我的分享</p>-->
                        <!--</div>-->
                        <div>
                            <p url="module/personal/myArticleList.html" articleType="11003">我的问答</p>
                        </div>
                        <div>
                            <p url="module/personal/myArticleList.html" articleType="11002">我的调研</p>
                        </div>
                        <div>
                            <p url="module/personal/myOrderData.html">我的定制数据</p>
                        </div>
                    </dt>
                    <dt class="myAccount">
                        <div>
                            <p url="module/personal/myInfo.html">基本信息</p>
                        </div>
                        <div>
                            <p url="module/personal/mySecurity.html">安全设置</p>
                        </div>
                    </dt>
                </dl>
            </div>
        </div>

        <div class="conMain2" style="background-color: #ffffff;margin-top: 35px">
        </div>
        <!--<a class="returnTop"></a>-->
    </div>
    <!--个人中心菜单内容显示-->
    <div id="menuInfo" style="display:none;"></div>
    <div style="clear: both"></div>
</div>
<!--右边结束-->
<script type="text/javascript" src="js/lib/require/require.js"></script>
<script type="text/javascript" src="js/url_config.js"></script>
<script type="text/javascript" src="js/config.js"></script>
<script type="text/javascript">
    require(["jquery","Marquee","BaseAjax","UserModule","commons"],function($,Marquee,BaseAjax,UserModule,commons){

        var expertId = null;
        var init = function(){

            $(".loadContent").css({"margin-top":"146px"})
            //隐藏搜索框并修改样式
            $("#indexRightTop").css({"height":"115px"});
            $("#headRightTop").css({"height":"85px"});
            // $(".liA li:last-child").css({"display":"none"})
            $(".searchContentBox").css({"display":"none"})

            //消除头部active样式
            var obj =  $(".liA li a");
            for(var i=0;i<obj.length;i++){
                $(obj[i]).removeClass("on")
            }

            //检查用户是否登录
            commons.checkForumLoginStatus();
            //初始化默认加载左侧有on的选项
            $('.conMain2').load($('.menuDiv dl dt p.on').attr("url"));


            //查看更多标签
            lookMore();
            //tab切换
            tabFun();
            //左侧底部tab切换
            leftTabFun();
            //获取用户信息
            generateUserInfo();
            //头像绑定change事件
            $("#path").change(function(){
                $("#upfile").val(this.value);
                previewImage(this);
            });
            //初始化我的订单页面
            goMyorder()
        }

        //支付订单成功后 从home页面调到personal页面里面的个人订单页面
        var goMyorder = function(){
            var payOrder = JSON.parse(localStorage.getItem('creatOrder'));
            if(payOrder!=null){
                $(".myOrder_href").trigger("click");
                localStorage.clear();
                // localStorage.removeItem('creatOrder');
            }
        }

        var lookMore = function(){
            $('.lookMore a').on('click',function(){
                $('.tags').css('height','auto');
                $('.lookMore').hide();
            });
        };

        //右侧列表区域tab切换
        var tabFun = function(){
            $('.list h1 a').on('click',function(){
                $(this).addClass('on').siblings('a').removeClass('on');
            });
        };

        //左侧底部菜单tab切换
        var leftTabFun = function(){
            $('.menuDiv dl dt p').on('click',function () {
                if (commons.checkForumLoginStatus()) {
                    $('.menuDiv dl dt p').removeClass('on');
                    $(this).addClass('on');
                    //加载标签对应的页面
                    var url = $(this).attr("url");
                    $('.conMain2').load(url);
                }
            });
        };

        /**
         * 生成用户信息
         * @param
         * @return
         * @version <1> 2019/3/19 mason:Created.
         */
        var generateUserInfo = function(){
            var currentUser = commons.getCurrentUser();
            var accountId = currentUser.accountId;
            $("#p_accountId").val(accountId);

            //查询专家信息
            // var user = commons.findExpertByAccountId(accountId)

            // if (JSON.stringify(user) == '{}'){
            var user = commons.getUserByAccountId(accountId);
            // }else {
            //     expertId = user.expertId;
            // }

            if (null != user.photoUrl && '' != user.photoUrl)  $('#p_photoUrl').attr('src',download_config.DOWNLOD_URL + user.photoUrl);
            // var accountName = commons.queryAccountName(accountId);
            // $('#p_userName').text(accountName);//用户名
            // $('#p_userName').attr('title',accountName);
            var userMessage = commons.isLogion();
            var accountName = JSON.parse(userMessage.data).nickName||JSON.parse(userMessage.data).personName||JSON.parse(userMessage.data).accountName||JSON.parse(userMessage.data).accountCode
            $('#p_userName').text(accountName);//用户名
            $('#p_userName').attr('title',accountName);

            var intro = user.introduction;

            if(user.introduction != null && user.introduction != "" && user.introduction.length > 15){
                intro = user.introduction.substring(0,15) + "..."
            }

            $('#p_introduction').text(intro);//用户简介
            $('#p_introduction').attr("title", user.introduction)
            if (null != user.industry && '' != user.industry){
                $('#p_industry').text(user.industry);//用户行业
                $('#p_industry').addClass('lab ' + user.industryCode);//行业样式
            } else {
                $('#p_industry').hide();
            }
        }

        /**
         * 本地图片在上传之前的预览效果
         * @param file 图片文件
         * @return
         * @version <1> 2019/3/28 mason:Created.
         */
        var previewImage =  function(file){

            if (file.files && file.files[0]){
                var img = document.getElementById('p_photoUrl');
                img.onload = function(){

                }
                var reader = new FileReader();
                //读取file完成之后加载
                reader.onload = function(evt){
                    img.src = evt.target.result;
                }
                //开始读取file
                reader.readAsDataURL(file.files[0]);
                //调用后台方法上传图片
                uploadUserPhoto();
            }

        }

        /**
         * 调用后台方法更换用户头像
         * @param
         * @return
         * @version <1> 2019/3/28 mason:Created.
         */
        var uploadUserPhoto = function(){
            //图片文件
            var photoFile = $('#path')[0].files[0];
            var formData = new FormData();
            formData.append('photoFile', $('#path')[0].files[0]);
            formData.append('accountId',$("#p_accountId").val());


            //1、调用后台上传图片，更新person表
            $.ajax({
                url: USER_CONFIG.editPersonPhoto_url,
                type: 'POST',
                cache: false,
                data: formData,
                processData: false,
                contentType: false,
                headers: {"AccessToken": commons.getAccessToken()},
                success:function(result){
                    if (result.flag) {
                        commons.tipMessageShow("保存成功", 3000, true);
                        if (null != result.msg && '' != result.msg){
                            //刷新页面顶部地头像
                            $("#userPhoto").attr('src',download_config.DOWNLOD_URL +result.msg);
                        }
                    }else {
                        commons.tipMessageShow("保存失败", 3000, false);
                    }
                },
                error:function () {
                    commons.tipMessageShow("保存失败", 3000, false);
                }
            });

            //2、如果是专家，还需要同步更新专家表地照片
            if (expertId){
                var formData = new FormData();
                formData.append('photoFile', $('#path')[0].files[0]);
                if(expertId!=null&&expertId!==''){
                    formData.append('expertId', expertId);
                }
                $.ajax({
                    url: CMS_MANAGE.editExpert_url,
                    type: 'POST',
                    cache: false,
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {"AccessToken": commons.getAccessToken()},
                    success:function(result){
                        if(result.flag){

                        }else{

                        }
                    }
                });
            }

        }

        init();

    })
</script>
</body>
</html>
