    <style>
        .content2 .conMain2{min-height: 730px;}
        .taskMain #listTitle{font-size: 18px;margin-bottom: 20px;border-bottom: 1px solid #ccc;padding-bottom: 20px;width: 90%;}

        .addButton{
            position: absolute;right: 0;top: 0;cursor:pointer;width: 88px;height:30px;color:#fff;border-radius:10px;background:#65d763;line-height: 30px;text-align:center
        }
        .addTaskForm{
            width: 80%;
            min-height: 400px;}
        #addTaskForm ul li {
            height: 50px;
            width: 77%;
            line-height: 50px;
            margin:0 auto;
            padding-bottom: 10px;
            color: #717171;
            font-size: 14px;
        }
        #addTaskForm ul li:last-child{
            height:90px;
        }
        #addTaskForm ul li span label{
            color:red;
            padding:2px 8px;
            vertical-align: middle;

        }
        #addTaskForm ul li span input{
            height: 36px;
            width: 211px;
            border: 1px solid #eaeaea;
            border-radius: 5px;
            margin-left: 28px;
        }
        .multipleInputForm input{
            height: 15px!important;
            width: 15px!important;
        }
        .multipleInputForm input{
            margin-left: 0px!important;
            font-size: 12px!important;
        }
        .multipleInputForm li{
            margin: 0 0!important;
        }
        .ms-choice{
            height: 36px!important;
            line-height: 36px!important;
        }
        .multipleInputForm label{
            color:#717171!important;
            padding:0px 0px!important;
            vertical-align: middle;

        }
        .multipleInputForm li{
            height: 30px!important;
            width: 92%!important;
            line-height: 30px!important;
            padding-bottom: 0px!important;
        }
        .userIdSelect{
            height: 36px;
            width: 211px;
            border: 1px solid #eaeaea;
            border-radius: 5px;
            margin-left: 28px;
        }
        #addTaskForm ul li span select{
            height: 36px;
            width: 211px;
            border: 1px solid #eaeaea;
            border-radius: 5px;
            margin-left: 28px;
         }
        #addTaskForm ul li span textarea{
            height: 56px;
            width: 392px;
            margin-top: 17px;
            border: 1px solid #eaeaea;
            border-radius: 5px;
            resize: none;
            margin-left: 28px;
        }
        .cancelBtn{
            width: 171px;
            height: 38px;
            border: 1px solid #007bc4;
            color: #007bc4;
            display: inline-block;
            border-radius: 5px;
            text-align: center;
            line-height: 40px;
            cursor: pointer;
            font-size: 14px;
        }
        .saveBtn{
            width: 173px;
            height: 40px;
            background-color: #007bc4;
            color: #f3f6f6;
            display: inline-block;
            border-radius: 5px;
            text-align: center;
            line-height: 40px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .publishBtn{
            width: 173px;
            height: 40px;
            background-color: #FABA17;
            color: #fff;
            display: inline-block;
            border-radius: 5px;
            text-align: center;
            line-height: 40px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        .errorBorder{
            border:1px solid red!important;
        }
        #workspaceId{width: 392px !important;}

        .ms-drop{
            /*scroll-y:auto!important;
            max-height:200px!important;
            overflow : auto!important;*/
        }
        .ms-drop ul{
            max-height:200px!important;
            overflow : auto!important;
            scroll-y:auto!important;
            scroll-x:hidden!important
        }
        .ms-drop ul::-webkit-scrollbar {/*滚动条整体样式*/
            width: 4px;     /*高宽分别对应横竖滚动条的尺寸*/
            height: 4px;
            scrollbar-arrow-color:red;

        }
        .ms-drop ul::-webkit-scrollbar-thumb {/*滚动条里面小方块*/
            border-radius: 5px;
            -webkit-box-shadow: inset 0 0 1px rgba(0,0,0,0.2);
            background: rgba(100,100,100,0.2);
            scrollbar-arrow-color:red;
        }
        .ms-drop ul::-webkit-scrollbar-track {/*滚动条里面轨道*/
            -webkit-box-shadow: inset 0 0 1px rgba(0,0,0,0.2);
            border-radius: 0;
            background: rgba(255,255,255,0.1);
        }
        .multipleInputForm .selected {
            background-color: #f3f1f1 !important;
        }
        .multipleInputForm ul li:hover{
            background-color: #f3f1f1!important;
            cursor: pointer;
        }
    </style>
    <link href="js/lib/multiple-select/multiple-select.css" rel="stylesheet"/>
    <div class="taskMain" style="background-color: #ffffff;">
        <div style="padding-left: 38px;">
            <p id="listTitle">新建任务</p>
        </div>
        <div class="addTaskFormDiv">
            <form id="addTaskForm" action="">
                <ul>
                    <li>
                        <span class="txtLabel"><label>*</label>任务名称</span>
                        <span>
                            <input id="showType" type="hidden" />
                            <input id="taskId" type="hidden" name="taskId"/>
                            <input id="taskNameId" type="text" name="taskName"/>
                        </span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>*</label>任务类型</span>
                        <span><select id="taskTypeId" name="taskType"/></span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>*</label>调研区域</span>
                        <span><input type="text" name="regionId" id="regionId" placeholder="--请选择区域--" readonly/></span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>*</label>调研作物</span>
                        <span><select id="cropId" name="cropId"/></span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>*</label>开始时间</span>
                        <span><input id="startDateId" type="text" readonly/></span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>*</label>结束时间</span>
                        <span><input id="endDateId" type="text" readonly /></span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>*</label>任务模板</span>
                        <span><select id="templateTypeId" name="templateTypeId" /></span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>&nbsp;</label>工作单位</span>
                        <span><input id="workspaceId" type="text"/></span>
                    </li>
                    <li>
                        <span class="txtLabel"><label>&nbsp;</label>参与人员</span>
                        <span class="multipleInputForm">
                            <select id="userId" multiple="multiple" class="userIdSelect" style="overflow-y: scroll" onfocus="this.style.color='#000000'"></select>
                        </span>
                    </li>
                    <li>
                        <span class="txtLabel" id="menoId" style="vertical-align: top;margin-left: 54px;">备注</span>
                        <span><textarea id="remarkId"/></span>
                    </li>
                </ul>
                <div id="errorMsg" style="color:red;width: 58%;margin: 0 auto;"></div>
                <div style="height:40px;text-align: center;margin-top: 40px; display: flex;justify-content:center;align-items:Center;margin-bottom: 20px">
                    <a class="cancelBtn" id="cancelBtnId">取消</a> <a class="saveBtn" id="saveBtnId">保存</a>
                </div>
            </form>
        </div>
    </div>
    <!-- 遮罩层DIV -->
    <div id="process" class="dialogStyle" style="display: none;text-align:center;">
        <img src="images/public/process.gif" />
    </div>
    <!--<a class="returnTop"></a>-->
<script type="text/javascript">
    require(["jquery","Marquee","BaseAjax","jqGrid","jqueryUi","UserModule","commons","dateUtil","formVerfication","PopWin","custom_settings","RegionModule"],function($,Marquee,BaseAjax,jqGrid,jqueryUi,UserModule,commons,dateUtil,formVerfication,PopWin,custom_settings,RegionModule){

        var processDialog = $("#process");

        //初始化方法
        var init = function(){
            cancelAddCollection();//取消添加采集任务
            dateFun();//初始化日期
            loadDictData(1800);//加载数据集
            commons.showTaskType("taskTypeId");
            loadTemplate();//加载用户模板
            saveCollectionTask();
            isLogion();
            RegionSelectFun("regionId");//区域点击事件
            commons.findDictList(500, "cropId");//作物
            getDataSensorOption("userId");//参与人
            formFocus();

            var taskId = $("#taskId").val();
            if(taskId){
                setTaskInfo(taskId);
            }

        }

        //去掉提示信息边框
        var formFocus = function(){
            $("#addTaskForm input,#addTaskForm select").focus(function(){
                $(this).removeClass("errorBorder")
            })
        }

        //编辑回显值
        var setTaskInfo =function(taskId){
            var taskInfo = taskDetail(taskId);
            $("#taskId").val(taskId);
            $("#taskNameId").val(taskInfo.taskName);
            commons.findDictList(1800, "taskTypeId",taskInfo.taskType);
            commons.showTaskType("taskTypeId");
            var regionName=commons.queryRegionName(taskInfo.regionId);
            $("#regionId").val(regionName).attr("regionId", taskInfo.regionId);//设置区域中文和id
            $("#regionId").attr("regionCode", taskInfo.regionCode);
            commons.findDictList(500, "cropId",taskInfo.cropId);
            $("#startDateId").val(taskInfo.startDate)
            $("#endDateId").val(taskInfo.endDate);
            $("#workspaceId").val(taskInfo.companyName);
            $("#remarkId").val(taskInfo.remark);
            //回显模板
            $("#templateTypeId option").each(function(){
                if($(this).val()== taskInfo.templateId){
                    $(this).prop("selected",true)
                }
            })
            //回显参与人
            var list = taskUserList(taskId);
            var accountIds = [];
            $.each(list, function (i, element) {
                accountIds.push(element.accountId);
            })
            $("#userId").multipleSelect('setSelects',accountIds);//选中

        }

        /**
         * 获取任务参与人列表
         * @version <1> 2018-06-12 lijie : created.
         */
        var taskUserList = function(taskId){
            var user =[]
            var ajax = new BaseAjax();
            ajax.opts.url = COLLECTION_TASK_NEW.findCltTaskUserList_url;
            ajax.opts.contentType = "application/json";
            ajax.opts.data = JSON.stringify({taskId:taskId})
            ajax.opts.async = false;
            ajax.opts.type="POST";
            ajax.opts.successFun = function(result){
                if(result.flag){
                    user=result.data;
                }
            }
            ajax.run();
            return user;
        };

        /**
         * 根据任务ID获取详情
         * @version <1> 2018-06-12 lijie : created.
         */
        var taskDetail = function(taskId){
            var task={};
            var ajax = new BaseAjax();
            ajax.opts.url = COLLECTION_TASK_NEW.nolog_getTaskById_url;
            ajax.opts.data = JSON.stringify({taskId:taskId})
            ajax.opts.contentType = "application/json";
            ajax.opts.async = false;
            ajax.opts.type="POST";
            ajax.opts.successFun = function(result){
                if(result.flag){
                    task=result.data;
                }
            }
            ajax.run();
            return task;
        };

        /**
         * 区域选择控件
         * @version <1> 2018-05-30 lijie : Created.
         */

        var RegionSelectFun = function(regionIdName){
            var search_regionId = document.getElementById(regionIdName);
            search_regionId.value = custom_settings.main_search_region_name;
            search_regionId.setAttribute("regionid", custom_settings.main_search_region_id);
            search_regionId.setAttribute("regioncode", custom_settings.main_search_region_code);
            search_regionId.onclick = function(){
                var opts = {colNum:3,width:400,url:REGION_CONFIG.findRegion_url,closeFun:function(){
                    var regionId = search_regionId.getAttribute("regionId");
                }};
                var regionSelector = new RegionModule.RegionSelector(regionIdName,opts);
                regionSelector.show();
            };
        };

        /**
         * Description:多选框
         * @return
         * @version <1> 2018/8/21 15:47 zhangshen: Created.
         */
        var getDataSensorOption = function (selectId) {
            var dataStatusArray = myFollowList()
            $('#'+selectId).html("");
            var optionHtml = "";
            for (var i = 0, j = dataStatusArray.length; i < j; i++) {
                var dataStatus = dataStatusArray[i];
                var accountName = dataStatus.accountName;
                accountName= accountName ? accountName:"";
                optionHtml += '<option value="' + dataStatus.accountId + '" data-id="' + dataStatus.accountId + '">' + accountName + '</option>';
            }
            $('#' + selectId).append(optionHtml);
            $('#' + selectId).multipleSelect({placeholder:"--请选择--", selectAllText:"全选"});

        };

        /**
         * 获取我的关注列表
         * @version <1> 2018-06-12 lijie : created.
         */
        var myFollowList = function(){
            var user =[]
            var ajax = new BaseAjax();
            ajax.opts.url = COLLECTION_TASK_NEW.findMyFollowList_url;
            ajax.opts.contentType = "application/json";
            ajax.opts.data = JSON.stringify({followType:13003})
            ajax.opts.async = false;
            ajax.opts.type="POST";
            ajax.opts.successFun = function(result){
                if(result.flag){
                    user=result.data;
                }
            }
            ajax.run();
            return user;
        };

        //加载数据集
        var loadTaskTypeJson = {};
        var loadDictData = function (dictId) {
            var ajax = new BaseAjax();
            ajax.opts.url = DICT_COFING.queryDictByParentId_url;
            ajax.opts.async = false;
            ajax.opts.data = JSON.stringify({'parentId': dictId});
            ajax.opts.successFun = function (result) {
                if (result.flag) {
                    var statusArry = result.data;
                    var optList = "<option value=''>--请选择--</option>";
                    for (var i in statusArry) {
                        var status = statusArry[i];
                        loadTaskTypeJson[status.dictId] = status.dataName;
                        optList += "<option value='" + status.dictId + "'>" + status.dataName + "</option>";
                    }
                    $("#taskTypeId").html(optList);
                }
            };
            ajax.run();
        };
        //加载用户模板
        var loadTemplate = function () {
            var ajax = new BaseAjax();
            ajax.opts.url = COLLECTION_TASK_NEW.findCltTemplateList_url;
            ajax.opts.async = false;
            ajax.opts.type="POST";
            ajax.opts.successFun = function (result) {
                if (result.flag) {
                    var arry = result.data;
                    var optList = "<option value=''>--请选择--</option>";
                    for (var i in arry) {
                        var obj = arry[i];
                        optList += "<option value='" + obj.templateId + "'>"+obj.typeName+"-"+obj.templateName + "</option>";
                    }
                    $("#templateTypeId").html(optList);
                }
            };
            ajax.run();
        };
        //取消
        function cancelAddCollection(){
            $("#cancelBtnId").click(function(){
                // $(".taskMain").load("module/personal/myCollectionTask.html");
                $(".loadContent").load('personal.html');  //个人中心的第一个默认选中页：我的任务

            });
        }
        //保存采集任务
        function saveCollectionTask(){
            $("#saveBtnId").click(function(){
                saveTask(22001);
            });
            $("#publishBtnId").click(function(){
                saveTask(22002);
            });
        }
        //日期函数
        var dateFun = function () {

            var date = new Date();
            var hours = date.getHours();
            var minute = date.getMinutes();
            var second = date.getSeconds();
            var _date = date.getFullYear() + "-" + (date.getMonth() +1)+ "-" + date.getDate() +" " + hours +":"+minute

            dateUtil.timeEventFive("startDateId", _date, function () {

            }); //初始化出生日期控件
            dateUtil.timeEventFive("endDateId", _date, function () {
            }); //初始化出生日期控件
        };
        //保存参数
        var getParam = function (isPublish) {
            var taskId = $("#taskId").val();
            var taskName = $("#taskNameId").val();
            var taskType = $("#taskTypeId").val();
            var regionId = $("#regionId").attr("regionId");
            var regionCode = $("#regionId").attr("regionCode");
            var cropId = $("#cropId").val();
            var workplace = $("#workspaceId").val();
            var templateId = $("#templateTypeId").val();
            var startDate = $("#startDateId").val();
            var endDate = $("#endDateId").val();
            var remark = $("#remarkId").val();
            var loginResult = isLogion();
            if (!loginResult.flag) return;
            var userInfo = JSON.parse(loginResult.data);
            var userArr = $("#userId").multipleSelect('getSelects');  // 获取选中

            var cltTemplate ={
                templateId: templateId,
            };
            var cltTaskInfo ={
                taskId: taskId,
                taskName: taskName,
                taskType: taskType,
                regionId: regionId,
                regionCode:regionCode,
                cropId: cropId,
                companyName: workplace,
                templateId: templateId,
                remark: remark,
                isPublish:isPublish
            };
            var taskParam = {
                startDateStr: startDate,
                endDateStr: endDate,
                cltTaskInfo:cltTaskInfo,
                cltTemplate:cltTemplate,
                cltTaskInfo:cltTaskInfo,
                userArr:userArr,
            };

            return taskParam;
        }
        //保存大任务
        var saveTask = function (isPublish) {
            var addParam = getParam(isPublish);
            if (!formVerf()) {
                return false
            }
            showProcess();
            var baseAjax = new BaseAjax();
            //新增
            baseAjax.opts.url = COLLECTION_TASK_NEW.addTaskList_url;
            if(addParam.cltTaskInfo.taskId){
                baseAjax.opts.url = COLLECTION_TASK_NEW.updateTaskList_url;
            }
            baseAjax.opts.async = false; //同步
            baseAjax.opts.contentType = "application/json";
            baseAjax.opts.data = JSON.stringify(addParam);
            baseAjax.opts.successFun = function (result) {
                processDialog.dialog("close");
                if (result.flag) {
                    $('form')[0].reset();
                    commons.tipMessageShow("保存成功", 2000, true);
                    $(".loadContent").load('personal.html');  //个人中心的第一个默认选中页：我的任务
                } else {
                    $("#errorMsg").text("*"+result.msg);
                }
            };
            baseAjax.opts.errorFun = function (result) {
                processDialog.dialog("close");
                $("#errorMsg").text("*保存失败");
            };
            baseAjax.run();
        };
        //校验创建任务参数
        var formVerf = function () {
            $("#errorMsg").empty();
            $('#taskNameId,#taskTypeId,#templateTypeId,#workspaceId,#startDateId,#endDateId').removeClass("errorBorder")
            var addTaskForm = $("#addTaskForm");
            var errorMsg = $("#errorMsg");
            if (formVerfication.checkInputIsEmpty($('#taskNameId'), errorMsg, '任务名不能为空')) {
                $("#errorMsg").text('*任务名称不能为空');
                $('#taskNameId').addClass("errorBorder");
                return false;
            }
            if (formVerfication.checkInputLength(1,15,$('#taskNameId'),errorMsg,'任务名称不能超过15位')) {
                $("#errorMsg").text('*任务名称不能超过15位');
                $('#taskNameId').addClass("errorBorder");
                return false;
            }
            if (formVerfication.checkInputIsEmpty($('#taskTypeId'), errorMsg, '任务类型不能为空')) {
                $("#errorMsg").text('*任务类型不能为空');
                $('#taskTypeId').addClass("errorBorder");
                return false;
            }
            if (formVerfication.checkInputIsEmpty($('#regionId'), errorMsg, '调研区域不能为空')) {
                $("#errorMsg").text('*调研区域不能为空不能为空');
                $('#regionId').addClass("errorBorder");
                return false;
            }
            if (formVerfication.checkInputIsEmpty($('#cropId'), errorMsg, '调研作物不能为空')) {
                $("#errorMsg").text('*调研作物不能为空');
                $('#cropId').addClass("errorBorder");
                return false;
            }

            if (formVerfication.checkInputIsEmpty($('#startDateId'), errorMsg, '开始时间不能为空')) {
                $("#errorMsg").text('*开始时间不能为空');
                $('#startDateId').addClass("errorBorder");
                return false;
            }
            if (formVerfication.checkInputIsEmpty($('#endDateId'), errorMsg, '结束时间不能为空')) {
                $("#errorMsg").text('*结束时间不能为空');
                $('#endDateId').addClass("errorBorder");
                return false;
            }

            if($("#startDateId").val() > $("#endDateId").val()){
                $("#errorMsg").text('*结束时间不能小于开始时间');
                $('#startDateId').addClass("errorBorder");
                $('#endDateId').addClass("errorBorder");
                return false;
            }
            /*if (formVerfication.checkInputIsEmpty($('#workspaceId'), errorMsg, '工作单位不能为空')) {
                $("#errorMsg").text('*工作单位不能为空');
                $('#workspaceId').addClass("errorBorder");
                return false;
            }*/
            if($('#workspaceId').val()){
                if (formVerfication.checkInputLength(1,30,$('#workspaceId'),errorMsg,'工作单位不能超过30个字')) {
                    $("#errorMsg").text('*工作单位不能超过30个字');
                    $('#workspaceId').addClass("errorBorder");
                    return false;
                }
            }

            if (formVerfication.checkInputIsEmpty($('#templateTypeId'), errorMsg, '任务模板不能为空')) {
                $("#errorMsg").text('*任务模板不能为空');
                $('#templateTypeId').addClass("errorBorder");
                return false;
            }

            //
            // var startDateL = new Date($('#startDateId').val()).getTime();
            // var endDateL = new Date($('#endDateId').val()).getTime();
            // if(startDateL>endDateL){
            //     return false;
            // }
            return true;
        }
        //获取用户信息
        var isLogion = function(){
            var userInfo;
            var ajax = new BaseAjax();
            ajax.opts.type = "get";
            ajax.opts.url = LOGIN_CONFIG.check_user_login;
            ajax.opts.async = false;
            ajax.opts.successFun = function (result){
                userInfo = result;
            };
            ajax.opts.errorFun = function () {
                return null;
            };
            ajax.run();
            return userInfo;
        }


        //进度条
        var showProcess=function(){
            processDialog.dialog({
                autoOpen: false,
                height: 460,
                width: 460,
                modal: true ,
                closeOnEscape: false,
                open: function(event, ui) {
                    processDialog.siblings(".ui-dialog-titlebar").hide();
                    processDialog.parent(".ui-dialog").css({"opacity":1,"background":"rgba(0,0,0,0)"});
                },
            });
            processDialog.dialog("open");
        }

        init();
    })
</script>
<script type="text/javascript" src="js/lib/multiple-select/multiple-select.js"></script>